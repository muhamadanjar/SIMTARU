// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.12/esri/copyright.txt for details.
//>>built
require({cache:{"esri/layers/MapImageLayer":function(){define("dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/dom-construct dojo/dom-style ../kernel ../config ../sniff ../domUtils ../geometry/Point ../geometry/webMercatorUtils ./layer".split(" "),function(k,m,q,s,p,c,t,n,d,f,b,a,g){var l=k([g],{declaredClass:"esri.layers.MapImageLayer","-chains-":{constructor:"manual"},constructor:function(a){this.inherited(arguments,[null,a]);this._mapImages=[];var e=q.hitch;this._panStart=
e(this,this._panStart);this._pan=e(this,this._pan);this._extentChange=e(this,this._extentChange);this._zoom=e(this,this._zoom);this._zoomStart=e(this,this._zoomStart);this._scale=e(this,this._scale);this._resize=e(this,this._resize);m.connect(this,"onSuspend",this,this._onSuspend);m.connect(this,"onResume",this,this._onResume);this.loaded=!0;this.onLoad(this)},opacity:1,addImage:function(a){var e=this._mapImages.push(a),e=e-1;a._idx=e;a._layer=this;this._div&&this._createImage(a,e)},removeImage:function(a){if(a){var e=
a._idx,h=this._mapImages;if(h[e]===a){delete h[e];if(e=a._node)this._clearEvents(e),e.e_idx=e.e_bl=e.e_tr=e.e_l=e.e_t=e.e_w=e.e_h=null,e.parentNode&&(e.parentNode.removeChild(e),p.destroy(e));a._node=a._idx=a._layer=null}}},removeAllImages:function(){var a=this._mapImages,e,h=a.length;for(e=0;e<h;e++){var b=a[e];b&&this.removeImage(b)}this._mapImages=[]},getImages:function(){var a=this._mapImages,e=[],h,b=a.length;for(h=0;h<b;h++)a[h]&&e.push(a[h]);return e},setOpacity:function(a){this.opacity!=a&&
(this._opacityChanged(this.opacity=a),this.onOpacityChange())},onOpacityChange:function(){},_opacityChanged:function(a){var e=this._div,h,b;if(e)if(!d("ie")||8<d("ie"))c.set(e,"opacity",a);else{b=e.childNodes;h=b.length;for(e=0;e<h;e++)c.set(b[e],"opacity",a)}},_createImage:function(a,e){var h=p.create("img");c.set(h,{position:"absolute"});8>=d("ie")&&c.set(h,"opacity",this.opacity);a.rotation&&!(9>d("ie"))&&c.set(h,t._css.names.transform,t._css.rotate(360-a.rotation));a._node=h;h.e_idx=e;h.e_layer=
this;h.e_load=m.connect(h,"onload",l.prototype._imageLoaded);h.e_error=m.connect(h,"onerror",l.prototype._imageError);h.e_abort=m.connect(h,"onabort",l.prototype._imageError);h.src=a.href},_imageLoaded:function(a,e){var h=e||a.target||a.currentTarget,b=h.e_layer,g=b._mapImages[h.e_idx],l=b._map;l&&(l.__zooming||l.__panning||!b._sr)?b._standby.push(h):(b._clearEvents(h),g&&g._node===h&&l&&b._attach(g))},_imageError:function(a){a=a.target||a.currentTarget;var e=a.e_layer,h=e._mapImages[a.e_idx];e._clearEvents(a);
h&&(h._node=null)},_clearEvents:function(a){var e=m.disconnect;e(a.e_load);e(a.e_error);e(a.e_abort);a.e_load=a.e_error=a.e_abort=a.e_layer=null},_attach:function(g){var e=g.extent,h=e.spatialReference,r=this._sr,l=this._div,d=g._node,f=new b({x:e.xmin,y:e.ymin,spatialReference:h}),e=new b({x:e.xmax,y:e.ymax,spatialReference:h});r.equals(h)||(r.isWebMercator()&&4326===h.wkid?(f=a.geographicToWebMercator(f),e=a.geographicToWebMercator(e)):h.isWebMercator()&&4326===r.wkid&&(f=a.webMercatorToGeographic(f),
e=a.webMercatorToGeographic(e)));d.e_bl=f;d.e_tr=e;g.visible&&(this._setPos(d,l._left,l._top),(this._active||l).appendChild(d))},_setPos:function(a,e,h){var b=a.e_bl,g=a.e_tr,l=this._map,b=l.toScreen(b),g=l.toScreen(g);e=b.x-e;h=g.y-h;var d=Math.abs(g.x-b.x),b=Math.abs(b.y-g.y),g={width:d+"px",height:b+"px"},f=this._mapImages[a.e_idx];"css-transforms"===l.navigationMode?g[t._css.names.transform]=t._css.translate(e,h)+(f.rotation?" "+t._css.rotate(360-f.rotation):""):(g.left=e+"px",g.top=h+"px");c.set(a,
g);a.e_l=e;a.e_t=h;a.e_w=d;a.e_h=b},managedSuspension:!0,_setMap:function(a,e){this.inherited(arguments);var b=this._div=p.create("div",null,e),g=t._css.names,l={position:"absolute"},w=a.__visibleDelta;if(!d("ie")||8<d("ie"))l.opacity=this.opacity;"css-transforms"===a.navigationMode?(l[g.transform]=t._css.translate(w.x,w.y),c.set(b,l),b._left=w.x,b._top=w.y,l={position:"absolute",width:a.width+"px",height:a.height+"px",overflow:"visible"},this._active=p.create("div",null,b),c.set(this._active,l),
this._passive=p.create("div",null,b),c.set(this._passive,l)):(b._left=0,b._top=0,c.set(b,l));this._standby=[];g=this._mapImages;w=g.length;for(l=0;l<w;l++){var n=g[l];n._node||this._createImage(n,n._idx)}f.hide(b);return b},_unsetMap:function(a,b){this._disconnect();var h=this._div;if(h){var g=this._mapImages,l,d=g.length;for(l=0;l<d;l++){var f=g[l];if(f){var c=f._node;c&&(this._clearEvents(c),c.e_idx=c.e_bl=c.e_tr=c.e_l=c.e_t=c.e_w=c.e_h=null);f._node=null}}b.removeChild(h);p.destroy(h)}this._map=
this._div=this._sr=this._active=this._passive=this._standby=null;this.inherited(arguments)},_onSuspend:function(){this._disconnect();f.hide(this._div)},_onResume:function(a){a.firstOccurrence&&(this._sr=this._map.spatialReference,this._processStandbyList());a=this._map;var b=this._div,h=a.__visibleDelta;"css-transforms"===a.navigationMode&&(b._left=h.x,b._top=h.y,c.set(b,t._css.names.transform,t._css.translate(b._left,b._top)));this._redraw("css-transforms"===a.navigationMode);this._connect(a);f.show(b)},
_connect:function(a){if(!this._connections){var b=m.connect,h="css-transforms"===a.navigationMode;this._connections=[b(a,"onPanStart",this._panStart),b(a,"onPan",this._pan),b(a,"onExtentChange",this._extentChange),h&&b(a,"onZoomStart",this._zoomStart),h?b(a,"onScale",this._scale):b(a,"onZoom",this._zoom),h&&b(a,"onResize",this._resize)]}},_disconnect:function(){this._connections&&(s.forEach(this._connections,m.disconnect),this._connections=null)},_panStart:function(){this._panL=this._div._left;this._panT=
this._div._top},_pan:function(a,b){var h=this._div;h._left=this._panL+b.x;h._top=this._panT+b.y;"css-transforms"===this._map.navigationMode?c.set(h,t._css.names.transform,t._css.translate(h._left,h._top)):c.set(h,{left:h._left+"px",top:h._top+"px"})},_extentChange:function(a,b,h){h?this._redraw("css-transforms"===this._map.navigationMode):b&&this._pan(a,b);this._processStandbyList()},_processStandbyList:function(){var a,b=this._standby;if(b&&b.length)for(a=b.length-1;0<=a;a--)this._imageLoaded(null,
b[a]),b.splice(a,1)},_redraw:function(a){if(a){a=this._passive;var b=t._css.names;c.set(a,b.transition,"none");this._moveImages(a,this._active);c.set(a,b.transform,"none")}a=this._active||this._div;var b=this._div._left,h=this._div._top,g,l=a.childNodes.length,d;for(g=0;g<l;g++)d=a.childNodes[g],this._setPos(d,b,h)},_zoom:function(a,b,h){a=this._div;var g=a._left,l=a._top,d,f=a.childNodes.length,n;for(d=0;d<f;d++){n=a.childNodes[d];var k=n.e_w*b,p=n.e_h*b,m=(h.x-g-n.e_l)*(k-n.e_w)/n.e_w,t=(h.y-l-
n.e_t)*(p-n.e_h)/n.e_h,m=isNaN(m)?0:m,t=isNaN(t)?0:t;c.set(n,{left:n.e_l-m+"px",top:n.e_t-t+"px",width:k+"px",height:p+"px"})}},_zoomStart:function(){this._moveImages(this._active,this._passive)},_moveImages:function(a,b){var h=a.childNodes,g;g=h.length;if(0<g)for(g-=1;0<=g;g--)b.appendChild(h[g])},_scale:function(a,b){var h=t._css.names,g=this._passive;c.set(g,h.transition,b?"none":h.transformName+" "+n.defaults.map.zoomDuration+"ms ease");t._css.matrix(a);c.set(g,h.transform,t._css.matrix(a))},
_resize:function(a,b,h){c.set(this._active,{width:b+"px",height:h+"px"});c.set(this._passive,{width:b+"px",height:h+"px"})}});d("extend-esri")&&q.setObject("layers.MapImageLayer",l,t);return l})},"esri/tasks/Task":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/json dojo/has ../kernel ../deferredUtils ../urlUtils ../Evented".split(" "),function(k,m,q,s,p,c,t,n){k=k(n,{declaredClass:"esri.tasks._Task",_eventMap:{error:["error"],complete:["result"]},constructor:function(d,f){d&&m.isString(d)&&
(this._url=t.urlToObject(this.url=d));f&&f.requestOptions&&(this.requestOptions=f.requestOptions);this.normalization=!0;this._errorHandler=m.hitch(this,this._errorHandler);this.registerConnectEvents()},_useSSL:function(){var d=this._url,f=/^http:/i;this.url&&(this.url=this.url.replace(f,"https:"));d&&d.path&&(d.path=d.path.replace(f,"https:"))},_encode:function(d,f,b){var a,g,l={},v,e;for(v in d)if("declaredClass"!==v&&(a=d[v],g=typeof a,null!==a&&void 0!==a&&"function"!==g))if(m.isArray(a)){l[v]=
[];e=a.length;for(g=0;g<e;g++)l[v][g]=this._encode(a[g])}else"object"===g?a.toJson&&(g=a.toJson(b&&b[v]),"esri.tasks.FeatureSet"===a.declaredClass&&g.spatialReference&&(g.sr=g.spatialReference,delete g.spatialReference),l[v]=f?g:q.toJson(g)):l[v]=a;return l},_successHandler:function(d,f,b,a){f&&this[f].apply(this,d);b&&b.apply(null,d);a&&c._resDfd(a,d)},_errorHandler:function(d,f,b){this.onError(d);f&&f(d);b&&b.errback(d)},setNormalization:function(d){this.normalization=d},onError:function(){}});
s("extend-esri")&&(p.Task=k);return k})},"esri/layers/RenderMode":function(){define("dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has dojo/io/script ../kernel".split(" "),function(k,m,q,s,p,c,t){m=m(null,{declaredClass:"esri.layers._RenderMode",constructor:function(){this._prefix="jsonp_"+(k._scopeName||"dojo")+"IoScript"},initialize:function(c){this.map=c;this._init=!0},startup:function(){},propertyChangeHandler:function(c){},destroy:function(){this._init=!1},drawFeature:function(c){},
suspend:function(){},resume:function(){},refresh:function(){},_incRefCount:function(c){(c=this._featureMap[c])&&c._count++},_decRefCount:function(c){(c=this._featureMap[c])&&c._count--},_getFeature:function(c){return this._featureMap[c]},_addFeatureIIf:function(c,d){var f=this._featureMap,b=f[c],a=this.featureLayer;b||(f[c]=d,a._add(d),d._count=0);return b||d},_removeFeatureIIf:function(c){var d=this._featureMap[c],f=this.featureLayer;if(d){if(d._count)return;delete this._featureMap[c];f._remove(d)}return d},
_clearIIf:function(){var c;c=this.featureLayer;var d=c.graphics,f=c._selectedFeatures,b=c.objectIdField;for(c=d.length-1;0<=c;c--){var a=d[c],g=a.attributes[b];g in f?a._count=1:(a._count=0,this._removeFeatureIIf(g))}},_isPending:function(n){return c[this._prefix+n]?!0:!1},_cancelPendingRequest:function(n,d){if(n=n||c[this._prefix+d])try{n.cancel(),c._validCheck(n)}catch(f){}},_purgeRequests:function(){c._validCheck(null)},_toggleVisibility:function(c){var d=this.featureLayer,f=d.graphics,b=c?"show":
"hide",a,g=f.length;c=c&&d._ager;for(a=0;a<g;a++){var l=f[a];l[b]();c&&d._repaint(l)}},_applyTimeFilter:function(c){var d=this.featureLayer;if(d.timeInfo&&!d.suspended){c||d._fireUpdateStart();var f=d._trackManager;f&&f.clearTracks();var b=d.getTimeDefinition(),a=d._getOffsettedTE(d._mapTimeExtent);a?(a=d._getTimeOverlap(b,a))?(b=d._filterByTime(d.graphics,a.startTime,a.endTime),f&&f.addFeatures(b.match),s.forEach(b.match,function(a){var b=a._shape;a.visible||(a.show(),(b=a._shape)&&b._moveToFront());
d._ager&&b&&d._repaint(a)}),s.forEach(b.noMatch,function(a){a.visible&&a.hide()})):this._toggleVisibility(!1):(f&&f.addFeatures(d.graphics),this._toggleVisibility(!0));f&&(f.moveLatestToFront(),f.drawTracks());c||d._fireUpdateEnd()}}});p("extend-esri")&&q.setObject("layers._RenderMode",m,t);return m})},"esri/tasks/FeatureSet":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../lang ../graphic ../SpatialReference ../graphicsUtils ../geometry/jsonUtils ../symbols/jsonUtils".split(" "),
function(k,m,q,s,p,c,t,n,d,f,b){k=k(null,{declaredClass:"esri.tasks.FeatureSet",constructor:function(a){if(a){m.mixin(this,a);var g=this.features,l=a.spatialReference,d=f.getGeometryType(a.geometryType),l=this.spatialReference=new n(l);this.geometryType=a.geometryType;a.fields&&(this.fields=a.fields);q.forEach(g,function(a,h){var r=a.geometry&&a.geometry.spatialReference;g[h]=new t(d&&a.geometry?new d(a.geometry):null,a.symbol&&b.fromJson(a.symbol),a.attributes);g[h].geometry&&!r&&g[h].geometry.setSpatialReference(l)});
this._hydrate()}else this.features=[]},displayFieldName:null,geometryType:null,spatialReference:null,fieldAliases:null,toJson:function(a){var b={};this.displayFieldName&&(b.displayFieldName=this.displayFieldName);this.fields&&(b.fields=this.fields);this.spatialReference?b.spatialReference=this.spatialReference.toJson():this.features[0]&&this.features[0].geometry&&(b.spatialReference=this.features[0].geometry.spatialReference.toJson());this.features[0]&&(this.features[0].geometry&&(b.geometryType=
f.getJsonType(this.features[0].geometry)),b.features=d._encodeGraphics(this.features,a));b.exceededTransferLimit=this.exceededTransferLimit;return c.fixJson(b)},_hydrate:function(){var a=this.transform;if(a){var b=this.features,l,d=a.translate[0],e=a.translate[1],h=a.scale[0],r=a.scale[1],c=function(a,b,h){if("esriGeometryPoint"===a)return function(a){a.x=b(a.x);a.y=h(a.y)};if("esriGeometryPolyline"===a||"esriGeometryPolygon"===a)return function(a){a=a.rings||a.paths;var g,e,l,d,c,r,f,v;g=0;for(e=
a.length;g<e;g++){c=a[g];l=0;for(d=c.length;l<d;l++)r=c[l],0<l?(f+=r[0],v+=r[1]):(f=r[0],v=r[1]),r[0]=b(f),r[1]=h(v)}};if("esriGeometryEnvelope"===a)return function(a){a.xmin=b(a.xmin);a.ymin=h(a.ymin);a.xmax=b(a.xmax);a.ymax=h(a.ymax)};if("esriGeometryMultipoint"===a)return function(a){a=a.points;var g,e,l;g=0;for(e=a.length;g<e;g++)l=a[g],l[0]=b(void 0),l[1]=h(void 0)}}(this.geometryType,function(a){return a*h+d},function(a){return e-a*r}),a=0;for(l=b.length;a<l;a++)b[a].geometry&&c(b[a].geometry);
this.transform=null}}});s("extend-esri")&&m.setObject("tasks.FeatureSet",k,p);return k})},"esri/layers/StreamMode":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../SpatialReference ../tasks/query ../tasks/QueryTask ../geometry/jsonUtils ./RenderMode".split(" "),function(k,m,q,s,p,c,t,n,d,f){k=k([f],{declaredClass:"esri.layers._StreamMode",constructor:function(b,a){this.featureLayer=b;this._featureMap={};this._setRefreshRate();this._drawBuffer={adds:[],updates:[]};
this._timeoutId=null;this._flushDrawBuffer=m.hitch(this,this._flushDrawBuffer);this._featuresByTime={};this._lastEndTimeCheck=null;this._drawFeatures=m.hitch(this,this._drawFeatures);this._queryErrorHandler=m.hitch(this,this._queryErrorHandler)},startup:function(){},propertyChangeHandler:function(b){this._init&&(0===b?this._applyTimeFilter():3===b?this._redrawAllTracks():console.debug("StreamLayer: Stream Layer only supports changing map time or maximumTrackPoints. Layer id \x3d "+this.featureLayer.id))},
drawFeature:function(b){var a=this.featureLayer,g=a.objectIdField;this._timeoutId||(this._timeoutId=setTimeout(this._flushDrawBuffer,this._refreshRate));a._joinField&&this._getFeature(b.attributes[g])?this._drawBuffer.updates.push({oid:b.attributes[g],updates:b}):this._drawBuffer.adds.push(b)},resume:function(){this.propertyChangeHandler(0)},refresh:function(){var b=this.featureLayer;b&&(b._fireUpdateStart(),this._flushDrawBuffer())},_drawFeatures:function(b){this._purgeRequests();var a=this.featureLayer;
a._create(b.features||[]);a._fireUpdateEnd(null,null)},_applyTimeFilter:function(b){this.inherited(arguments);this._redrawAllTracks()},_removeFeatures:function(b){var a=this.featureLayer,g=a.objectIdField;b&&q.forEach(b,function(b){b=b.attributes[g];a._unSelectFeatureIIf(b,this);this._decRefCount(b);this._removeFeatureIIf(b)},this)},_addFeatures:function(b){var a=this.featureLayer,g=a._endTimeField,l,d,e,h=[],r=[],c=[];l=a._trackManager;d=a.objectIdField;if(l)for(e in b=l.addFeatures(b),b)b.hasOwnProperty(e)&&
(h.push(e),b[e].adds&&(r=r.concat(b[e].adds)),b[e].deletes&&(c=c.concat(b[e].deletes)));else r=b;q.forEach(r,function(a){var b=a.attributes[d],h;if(h=g&&a.attributes[g])h=1E3*Math.ceil(h/1E3),this._featuresByTime[h]?this._featuresByTime[h].push(b):this._featuresByTime[h]=[b];this._addFeatureIIf(b,a);this._incRefCount(b)},this);c.length&&this._removeFeatures(c);l&&l.refreshTracks(h)},_updateFeatures:function(b){var a=this.featureLayer,g,l,d=[];g=a._trackManager;l=a._trackIdField;q.forEach(b,function(b){var h=
b.updates;b=this._getFeature(b.oid);var c;if(b){h.geometry&&b.setGeometry(h.geometry);h=h.attributes||{};for(c in h)h.hasOwnProperty(c)&&(b.attributes[c]=h[c]);b.visible=this._checkFeatureTimeIntersects(b);g&&b.attributes[l]?d.push(b.attributes[l]):a._repaint(b,null,!0)}},this);d.length&&g.refreshTracks(d)},_redrawAllTracks:function(){var b=this.featureLayer._trackManager,a;if(b&&(a=b.trimTracks())&&0<a.length)this._removeFeatures(a),b.refreshTracks()},_flushDrawBuffer:function(){clearTimeout(this._timeoutId);
var b=this._drawBuffer,a=b.adds.splice(0,b.adds.length),g=b.updates.splice(0,b.updates.length),b=this.featureLayer;if(!b)return!1;b.updating||b._fireUpdateStart();this._addFeatures(a);this._updateFeatures(g);if((a=this._getExpiredFeatures())&&a.length)this._removeFeatures(a),b._trackManager&&b._trackManager.removeFeatures(a);b._purge();b._fireUpdateEnd();this._timeoutId=null},_clearDrawBuffer:function(){var b=this._timeoutId,a=this._drawBuffer,g=a.adds,a=a.updates;b&&clearTimeout(b);g.splice(0,g.length);
a.splice(0,a.length);this._timeoutId=null},_setRefreshRate:function(b){b=b||0===b?b:200;0>b&&(b=200);this._refreshRate=b},_checkFeatureTimeIntersects:function(b){var a=this.featureLayer,g=a.getMap().timeExtent;return!g||!a.timeInfo||!a.timeInfo.startTimeField&&!a.timeInfo.endTimeField?!0:0<a._filterByTime([b],g.startTime,g.endTime).match.length},_getRequestId:function(b){return("_"+b.name+b.layerId+b._ulid).replace(/[^a-zA-Z0-9\_]+/g,"_")},_fetchArchive:function(b){var a=this.featureLayer,g,l,f,e,
h,r;a._fireUpdateStart();if(b)b=new n(b),g=new t,l=this.map,f=a.getFilter()||{},e=f.where||"1\x3d1",h=f.geometry?d.fromJson(f.geometry):null,f=f.outFields?f.outFields.split(","):["*"],g.geometry=h,g.where=e,g.outFields=f,g.returnGeometry=!0,g.outSpatialReference=new c(l.spatialReference.toJson()),a._usePatch&&(r=this._getRequestId(a),this._cancelPendingRequest(null,r)),b.execute(g,this._drawFeatures,this._queryErrorHandler,r);else return this._fireUpdateEnd({error:"No url provided"}),!1},_queryErrorHandler:function(b){this._purgeRequests();
var a=this.featureLayer;a._errorHandler(b);a._fireUpdateEnd(b)},_getExpiredFeatures:function(){var b,a,g,l=[],d=[];if(!this.featureLayer._endTimeField)return d;b=1E3*Math.floor(this._lastEndTimeCheck/1E3);this._lastEndTimeCheck=a=1E3*Math.ceil(Date.now()/1E3);if(b&&b!==a)for(g=this._featuresByTime;b<=a;b+=1E3)g[b]&&(l=l.concat(g[b]),delete g[b]);q.forEach(l,function(a){(a=this._getFeature(a))&&d.push(a)},this);return d}});s("extend-esri")&&m.setObject("layers._StreamMode",k,p);return k})},"esri/tasks/StatisticDefinition":function(){define(["dojo/_base/declare",
"dojo/_base/lang","dojo/has","../kernel"],function(k,m,q,s){k=k(null,{declaredClass:"esri.tasks.StatisticDefinition",toJson:function(){return{statisticType:this.statisticType,onStatisticField:this.onStatisticField,outStatisticFieldName:this.outStatisticFieldName,maxPointCount:this.maxPointCount,maxRecordCount:this.maxRecordCount,maxVertexCount:this.maxVertexCount}}});q("extend-esri")&&m.setObject("tasks.StatisticDefinition",k,s);return k})},"esri/layers/GridLayout":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../SpatialReference ../geometry/Extent ../geometry/Polyline".split(" "),
function(k,m,q,s,p,c,t,n){k=k(null,{declaredClass:"esri.layers._GridLayout",constructor:function(d,c,b,a){this.origin=d;this.cellWidth=c.width;this.cellHeight=c.height;this.mapWidth=b.width;this.mapHeight=b.height;this.srInfo=a},setResolution:function(d){this._resolution=(d.xmax-d.xmin)/this.mapWidth;this.srInfo&&(d=Math.round(2*this.srInfo.valid[1]/this._resolution),d=Math.round(d/this.cellWidth),this._frameStats=[d,0,d-1])},getCellCoordinates:function(d){var c=this._resolution,b=this.origin;return{row:Math.floor((b.y-
d.y)/(this.cellHeight*c)),col:Math.floor((d.x-b.x)/(this.cellWidth*c))}},normalize:function(d){var c=this._frameStats;if(c){var b=c[0],a=c[1],c=c[2];d<a?(d%=b,d=d<a?d+b:d):d>c&&(d%=b)}return d},intersects:function(d,c){var b=this.srInfo;return b?q.some(c._getParts(b),function(a){return d.intersects(a.extent)}):d.intersects(c)},getCellExtent:function(d,f){var b=this._resolution,a=this.origin,g=this.cellWidth,l=this.cellHeight;return new t(f*g*b+a.x,a.y-(d+1)*l*b,(f+1)*g*b+a.x,a.y-d*l*b,new c(a.spatialReference.toJson()))},
getLatticeID:function(d){var c=this.getCellCoordinates({x:d.xmin,y:d.ymax}),b=this.getCellCoordinates({x:d.xmax,y:d.ymin});d=c.row;var a=b.row,c=this.normalize(c.col),b=this.normalize(b.col);return d+"_"+a+"_"+c+"_"+b},sorter:function(d,c){return d<c?-1:1},getCellsInExtent:function(d,c){var b=this.getCellCoordinates({x:d.xmin,y:d.ymax}),a=this.getCellCoordinates({x:d.xmax,y:d.ymin}),g=b.row,l=a.row,b=b.col,a=a.col,v=[],e,h,r,x=[],w=[],k,p,m,t=[];for(e=g;e<=l;e++)for(h=b;h<=a;h++)r=this.normalize(h),
d=this.getCellExtent(e,r),v.push({row:e,col:r,extent:d,resolution:this._resolution}),c&&(x.push(d.xmin,d.xmax),w.push(d.ymin,d.ymax));b=this.normalize(b);a=this.normalize(a);x.sort(this.sorter);w.sort(this.sorter);h=x.length;for(e=h-1;0<=e;e--)e<h-1&&x[e]===x[e+1]&&x.splice(e,1);h=w.length;for(e=h-1;0<=e;e--)e<h-1&&w[e]===w[e+1]&&w.splice(e,1);if(x.length&&w.length){r=x[0];k=x[x.length-1];p=w[0];m=w[w.length-1];h=x.length;for(e=0;e<h;e++)t.push([[x[e],m],[x[e],p]]);h=w.length;for(e=0;e<h;e++)t.push([[r,
w[e]],[k,w[e]]]);e=new n({paths:t,spatialReference:this.origin.spatialReference.toJson()});v.push({latticeID:g+"_"+l+"_"+b+"_"+a,lattice:e,resolution:this._resolution})}return{minRow:g,maxRow:l,minCol:b,maxCol:a,cells:v}}});s("extend-esri")&&m.setObject("layers._GridLayout",k,p);return k})},"esri/layers/FeatureEditResult":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","../kernel"],function(k,m,q,s){k=k(null,{declaredClass:"esri.layers.FeatureEditResult",constructor:function(k){k&&
m.isObject(k)&&(this.objectId=k.objectId,this.success=k.success,k.success||(k=k.error,this.error=Error(),this.error.code=k.code,this.error.message=k.description))}});q("extend-esri")&&m.setObject("layers.FeatureEditResult",k,s);return k})},"esri/layers/TrackManager":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../graphic ../geometry/Polyline ./GraphicsLayer".split(" "),function(k,m,q,s,p,c,t,n){k=k(null,{declaredClass:"esri.layers._TrackManager",constructor:function(d){this.layer=
d;this.trackMap={};this.trackLineMap={}},initialize:function(d){this.map=d;var c=this.layer,b=c._getRenderer(),b=b&&b.trackRenderer;if("esriGeometryPoint"===c.geometryType){var a=this.container=new n._GraphicsLayer({id:c.id+"_tracks",_child:!0});a.loaded=!0;a.onLoad(a);a._setMap(d,c._div);a.setRenderer(b)}},addFeatures:function(c){var f=this.trackMap,b=this.layer,a=b._trackIdField,g=[];q.forEach(c,function(b){var c=b.attributes[a];(f[c]=f[c]||[]).push(b);-1===q.indexOf(g,c)&&g.push(c)});var l=b._startTimeField,
v=b.objectIdField,e=function(a,b){var g=a.attributes[l],c=b.attributes[l];return g===c?a.attributes[v]<b.attributes[v]?-1:1:g<c?-1:1};q.forEach(g,function(a){f[a].sort(e)})},trimTracks:function(c){function f(c){for(c=b[c]||[];c.length>a;)g.push(c.shift())}var b=this.trackMap,a=this.layer.maximumTrackPoints||0,g=[],l;if(!a)return g;if(c)q.forEach(c,function(a){f(a)});else for(l in b)b.hasOwnProperty(l)&&f(l);return g},drawTracks:function(d){function f(h){var e=g[h],d,f,k;f=b.trackLineMap[h];a.remove(f);
delete b.trackLineMap[h];if(!e||2>e.length)return!1;f=[];for(d=e.length-1;0<=d;d--)(k=e[d].geometry)&&f.push([k.x,k.y]);e={};e[v]=h;1<f.length&&(f=new c(new t({paths:[f],spatialReference:l}),null,e),a.add(f),b.trackLineMap[h]=f)}var b=this,a=this.container,g,l,v,e;if(a)if(g=this.trackMap,l=this.map.spatialReference,v=this.layer._trackIdField,d)q.forEach(d,function(a){f(a)});else for(e in g)g.hasOwnProperty(e)&&f(e)},refreshTracks:function(c){function f(c){var h,d;b.drawTracks([c]);if(l&&l.latestObservationRenderer){c=
a[c]||[];h=c.length;for(d=0;d<h;d++)g._repaint(c[d],null,!0)}}var b=this,a=this.trackMap,g=this.layer,l=g._getRenderer(),v;if(c)q.forEach(c,function(a){f(a)});else for(v in a)a.hasOwnProperty(v)&&f(v);this.moveLatestToFront()},moveLatestToFront:function(c){q.forEach(this.getLatestObservations(c),function(c){var b=c._shape;b&&b._moveToFront();this._repaint(c,null,!0)},this.layer)},getLatestObservations:function(c){function f(a){a=g[a];return a[a.length-1]}var b=[],a=this.layer._getRenderer(),g=this.trackMap,
l;if(!a.latestObservationRenderer)return b;if(c)q.forEach(c,function(a){b.push(f(a))});else for(l in g)g.hasOwnProperty(l)&&b.push(f(l));return b},clearTracks:function(c){var f=this.getLatestObservations(c),b=this.container,a;c?q.forEach(c,function(c){delete this.trackMap[c];b&&(a=this.trackLineMap[c],b.remove(a),delete this.trackLineMap[c])},this):(this.trackMap={},this.trackLineMap={},b&&b.clear());q.forEach(f,function(a){this._repaint(a,null,!0)},this.layer)},isLatestObservation:function(c){var f=
this.trackMap[c.attributes[this.layer._trackIdField]];return f?f[f.length-1]===c:!1},destroy:function(){var c=this.container;c&&(c.clear(),c._unsetMap(this.map,this.layer._div));this.map=this.layer=this.trackMap=this.container=null}});s("extend-esri")&&m.setObject("layers._TrackManager",k,p);return k})},"esri/layers/FeatureType":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../lang ../symbols/jsonUtils ./RangeDomain ./CodedValueDomain ./InheritedDomain ./FeatureTemplate".split(" "),
function(k,m,q,s,p,c,t,n,d,f,b){k=k(null,{declaredClass:"esri.layers.FeatureType",constructor:function(a){if(a&&m.isObject(a)){this.id=a.id;this.name=a.name;var c=a.symbol;c&&(this.symbol=t.fromJson(c));var c=a.domains,l,v=this.domains={};for(l in c)if(c.hasOwnProperty(l)){var e=c[l];switch(e.type){case "range":v[l]=new n(e);break;case "codedValue":v[l]=new d(e);break;case "inherited":v[l]=new f(e)}}if(l=a.templates){c=this.templates=[];for(a=0;a<l.length;a++)c.push(new b(l[a]))}}},toJson:function(){var a=
{id:this.id,name:this.name,symbol:this.symbol&&this.symbol.toJson()},b,l=this.domains,d=this.templates,e=c.fixJson;if(l){var h=a.domains={};for(b in l)l.hasOwnProperty(b)&&(h[b]=l[b]&&l[b].toJson());e(h)}d&&(a.templates=q.map(d,function(a){return a.toJson()}));return e(a)}});s("extend-esri")&&m.setObject("layers.FeatureType",k,p);return k})},"esri/layers/FeatureTemplate":function(){define("dojo/_base/declare dojo/_base/lang dojo/has ../kernel ../lang ../graphic".split(" "),function(k,m,q,s,p,c){k=
k(null,{declaredClass:"esri.layers.FeatureTemplate",constructor:function(k){k&&m.isObject(k)&&(this.name=k.name,this.description=k.description,this.drawingTool=k.drawingTool,k=k.prototype,this.prototype=new c(k.geometry,null,k.attributes))},toJson:function(){return p.fixJson({name:this.name,description:this.description,drawingTool:this.drawingTool,prototype:this.prototype&&this.prototype.toJson()})}});m.mixin(k,{TOOL_AUTO_COMPLETE_POLYGON:"esriFeatureEditToolAutoCompletePolygon",TOOL_CIRCLE:"esriFeatureEditToolCircle",
TOOL_ELLIPSE:"esriFeatureEditToolEllipse",TOOL_FREEHAND:"esriFeatureEditToolFreehand",TOOL_LINE:"esriFeatureEditToolLine",TOOL_NONE:"esriFeatureEditToolNone",TOOL_POINT:"esriFeatureEditToolPoint",TOOL_POLYGON:"esriFeatureEditToolPolygon",TOOL_RECTANGLE:"esriFeatureEditToolRectangle",TOOL_ARROW:"esriFeatureEditToolArrow",TOOL_TRIANGLE:"esriFeatureEditToolTriangle",TOOL_LEFT_ARROW:"esriFeatureEditToolLeftArrow",TOOL_RIGHT_ARROW:"esriFeatureEditToolRightArrow",TOOL_UP_ARROW:"esriFeatureEditToolUpArrow",
TOOL_DOWN_ARROW:"esriFeatureEditToolDownArrow"});q("extend-esri")&&m.setObject("layers.FeatureTemplate",k,s);return k})},"esri/layers/OnDemandMode":function(){define("dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/has ../kernel ../geometry/Point ../tasks/query ./RenderMode ./GridLayout".split(" "),function(k,m,q,s,p,c,t,n,d,f){k=k([d],{declaredClass:"esri.layers._OnDemandMode",constructor:function(b){this.featureLayer=b;this._featureMap={};this._queryErrorHandler=q.hitch(this,
this._queryErrorHandler)},initialize:function(b){this.inherited(arguments);var a=this.featureLayer,c=a._srInfo;this._gridLayer=new f(new t(c?c.valid[0]:b.extent.xmin,b.extent.ymax,b.spatialReference),{width:a._tileWidth,height:a._tileHeight},{width:b.width,height:b.height},c);this._cellMap={};this._gridLayer.setResolution(b.extent)},startup:function(){this._ioQueue=[];this.featureLayer.suspended||(this._zoomHandler(),this._enableConnectors())},propertyChangeHandler:function(b){this._init&&(2>b?this._zoomHandler():
console.log("FeatureLayer: layer in on-demand mode does not support time definitions. Layer id \x3d "+this.featureLayer.id+", Layer URL \x3d "+this.featureLayer.url))},destroy:function(){this._disableConnectors();this.inherited(arguments)},drawFeature:function(b){var a=this._gridLayer,c=b.geometry,l=[];if(c)for(var l=a.getCellsInExtent("point"===c.type?{xmin:c.x,ymin:c.y,xmax:c.x,ymax:c.y}:c.getExtent(),!1).cells,a=this._cellMap,d,e=b.attributes[this.featureLayer.objectIdField],h,r,f,c=0;c<l.length;c++)d=
l[c],h=d.latticeID,r=d.row,f=d.col,h?d=a[h]=a[h]||d:(a[r]=a[r]||{},d=a[r][f]=a[r][f]||d),d.features=d.features||[],d.features.push(b),this._addFeatureIIf(e,b),this._incRefCount(e)},suspend:function(){this._init&&this._disableConnectors()},resume:function(){this._init&&(this._enableConnectors(),this._zoomHandler())},refresh:function(){this._zoomHandler()},_enableConnectors:function(){var b=this.map;this._zoomConnect=m.connect(b,"onZoomEnd",this,this._zoomHandler);this._panConnect=m.connect(b,"onPanEnd",
this,this._panHandler);this._resizeConnect=m.connect(b,"onResize",this,this._panHandler)},_disableConnectors:function(){m.disconnect(this._zoomConnect);m.disconnect(this._panConnect);m.disconnect(this._resizeConnect)},_zoomHandler:function(){this._processIOQueue(!0);var b=this.featureLayer,a=this.map;b.suspended||(b._fireUpdateStart(),this._clearIIf(),(b=b._trackManager)&&b.clearTracks(),this._cellMap={},this._gridLayer.setResolution(a.extent),this._sendRequest())},_panHandler:function(b){this.featureLayer._fireUpdateStart();
this._sendRequest(this.featureLayer._resized&&b)},_getRequestId:function(b,a){return("_"+b.name+b.layerId+b._ulid+"_"+a.resolution+"_"+(a.latticeID||a.row+"_"+a.col)).replace(/[^a-zA-Z0-9\_]+/g,"_")},_sendRequest:function(b){this._exceeds=!1;var a=this.featureLayer,c=this.map;b=b||c.extent;c=this._gridLayer.getCellsInExtent(b,a.latticeTiling).cells;if(!a.isEditable())var d=this._cellMap,c=s.filter(c,function(a){if(a.lattice){if(d[a.latticeID])return!1}else if(d[a.row]&&d[a.row][a.col])return!1;return!0});
var f=a.getOutFields(),e=a.getDefinitionExpression(),h=a._getOffsettedTE(a._mapTimeExtent),r=a.supportsAdvancedQueries?a.getOrderByFields():null,k=a._usePatch,m=this._ioQueue,p,t=this,q=this._drawFeatures,A,y,B;this._pending=this._pending||0;for(p=0;p<c.length;p++){A=c[p];y=new n;y.geometry=A.extent||A.lattice;y.outFields=f;y.where=e;a.latticeTiling&&A.extent&&(y.spatialRelationship=n.SPATIAL_REL_CONTAINS);y.returnGeometry=!0;y.timeExtent=h;a._ts&&(y._ts=(new Date).getTime());y.orderByFields=r;y.multipatchOption=
a.multipatchOption;y.maxAllowableOffset=a._maxOffset;y.quantizationParameters=a._quantizationParameters;B=null;if(k&&(B=this._getRequestId(a,A),this._isPending(B)))continue;this._pending++;m.push(a._task.execute(y,function(){var a=A;return function(b){q.apply(t,[b,a])}}.call(this),this._queryErrorHandler,B))}this._removeOldCells(b);this._endCheck()},_drawFeatures:function(b,a){this._exceeds=this._exceeds||b.exceededTransferLimit;this._finalizeIO();var c=this.map.extent,d=a.extent,f=a.row,e=a.col,
h=this.featureLayer.objectIdField,r=b.features,k=this._gridLayer,n=this._cellMap,m=a.latticeID,p=m?n[m]:n[f]&&n[f][e];if(a.resolution!=k._resolution||(m?m!==k.getLatticeID(c):!k.intersects(d,c)))p&&this._removeCell(f,e,m);else if(p)this._updateCell(p,r);else{a.features=r;m?n[m]=a:(n[f]=n[f]||{},n[f][e]=a);d=r.length;for(c=0;c<d;c++)f=r[c],e=f.attributes[h],this._addFeatureIIf(e,f),this._incRefCount(e)}this._endCheck()},_queryErrorHandler:function(b){this._finalizeIO();this.featureLayer._errorHandler(b);
this._endCheck(!0)},_finalizeIO:function(){this._purgeRequests();this._pending--},_endCheck:function(b){if(0===this._pending){this._processIOQueue();var a=this.featureLayer,c=a._trackManager;c&&(c.clearTracks(),c.addFeatures(a.graphics),a._ager&&s.forEach(a.graphics,function(b){b._shape&&a._repaint(b)}),c.moveLatestToFront(),c.drawTracks());this.featureLayer._fireUpdateEnd(b&&Error("FeatureLayer: an error occurred while updating the layer"),this._exceeds?{queryLimitExceeded:!0}:null);if(this._exceeds)a.onQueryLimitExceeded()}},
_processIOQueue:function(b){this._ioQueue=s.filter(this._ioQueue,function(a){return-1<a.fired?!1:!0});b&&s.forEach(this._ioQueue,this._cancelPendingRequest)},_removeOldCells:function(b){var a=this._cellMap,c=this._gridLayer,d,f;for(d in a)if(a[d]){var e=a[d],h=e.latticeID,r=0,k=0;if(h)r++,h!==c.getLatticeID(b)&&(this._removeCell(null,null,h),k++);else for(f in e)e[f]&&(r++,c.intersects(e[f].extent,b)||(this._removeCell(d,f),k++));k===r&&delete a[d]}},_updateCell:function(b,a){var c=this.featureLayer,
d=c.objectIdField,c=c._selectedFeatures,f,e=a.length;b.features=b.features||[];for(f=0;f<e;f++){var h=a[f],r=h.attributes[d],k=this._addFeatureIIf(r,h);k===h?(this._incRefCount(r),b.features.push(k)):r in c||(k.setGeometry(h.geometry),k.setAttributes(h.attributes))}},_removeCell:function(b,a,c){var d=this._cellMap,f=this.featureLayer,e=f.objectIdField,h=c?d[c]:d[b]&&d[b][a];if(h){c?delete d[c]:delete d[b][a];b=h.features;for(a=0;a<b.length;a++)c=b[a].attributes[e],this._decRefCount(c),c in f._selectedFeatures||
this._removeFeatureIIf(c)}}});p("extend-esri")&&q.setObject("layers._OnDemandMode",k,c);return k})},"esri/tasks/QueryTask":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/Deferred dojo/_base/json dojo/has ../kernel ../request ../deferredUtils ../geometry/Extent ../geometry/normalizeUtils ./Task ./FeatureSet".split(" "),function(k,m,q,s,p,c,t,n,d,f,b,a,g){k=k(a,{declaredClass:"esri.tasks.QueryTask",_eventMap:{complete:["featureSet"],"execute-for-count-complete":["count"],
"execute-for-ids-complete":["objectIds"],"execute-relationship-query-complete":["featureSets"]},constructor:function(a,b){this._handler=m.hitch(this,this._handler);this._relationshipQueryHandler=m.hitch(this,this._relationshipQueryHandler);this._executeForIdsHandler=m.hitch(this,this._executeForIdsHandler);this._countHandler=m.hitch(this,this._countHandler);this._extentHandler=m.hitch(this,this._extentHandler);this.source=b&&b.source;this.gdbVersion=b&&b.gdbVersion;this.registerConnectEvents()},__msigns:[{n:"execute",
c:4,a:[{i:0,p:["geometry"]}],e:2},{n:"executeForIds",c:3,a:[{i:0,p:["geometry"]}],e:2},{n:"executeForCount",c:3,a:[{i:0,p:["geometry"]}],e:2},{n:"executeForExtent",c:3,a:[{i:0,p:["geometry"]}],e:2}],onComplete:function(){},onExecuteRelationshipQueryComplete:function(){},onExecuteForIdsComplete:function(){},onExecuteForCountComplete:function(){},onExecuteForExtentComplete:function(){},execute:function(a,b,c,h,d){var f=d.assembly;a=this._encode(m.mixin({},this._url.query,{f:"json"},a.toJson(f&&f[0])));
var g=this._handler,k=this._errorHandler;this.source&&(f={source:this.source.toJson()},a.layer=p.toJson(f));this.gdbVersion&&(a.gdbVersion=this.gdbVersion);return n({url:this._url.path+"/query",content:a,callbackParamName:"callback",load:function(a,h){g(a,h,b,c,d.dfd)},error:function(a){k(a,c,d.dfd)},callbackSuffix:h},this.requestOptions)},executeRelationshipQuery:function(a,b,c){a=this._encode(m.mixin({},this._url.query,{f:"json"},a.toJson()));var h=this._relationshipQueryHandler,f=this._errorHandler;
this.gdbVersion&&(a.gdbVersion=this.gdbVersion);var g=new s(d._dfdCanceller);g._pendingDfd=n({url:this._url.path+"/queryRelatedRecords",content:a,callbackParamName:"callback",load:function(a,d){h(a,d,b,c,g)},error:function(a){f(a,c,g)}},this.requestOptions);return g},executeForIds:function(a,b,c,h){var d=h.assembly;a=this._encode(m.mixin({},this._url.query,{f:"json",returnIdsOnly:!0},a.toJson(d&&d[0])));var f=this._executeForIdsHandler,g=this._errorHandler;this.source&&(d={source:this.source.toJson()},
a.layer=p.toJson(d));this.gdbVersion&&(a.gdbVersion=this.gdbVersion);return n({url:this._url.path+"/query",content:a,callbackParamName:"callback",load:function(a,d){f(a,d,b,c,h.dfd)},error:function(a){g(a,c,h.dfd)}},this.requestOptions)},executeForCount:function(a,b,c,h){var d=h.assembly;a=this._encode(m.mixin({},this._url.query,{f:"json",returnIdsOnly:!0,returnCountOnly:!0},a.toJson(d&&d[0])));var f=this._countHandler,g=this._errorHandler;this.source&&(d={source:this.source.toJson()},a.layer=p.toJson(d));
this.gdbVersion&&(a.gdbVersion=this.gdbVersion);return n({url:this._url.path+"/query",content:a,callbackParamName:"callback",load:function(a,d){f(a,d,b,c,h.dfd)},error:function(a){g(a,c,h.dfd)}},this.requestOptions)},executeForExtent:function(a,b,c,h){var d=h.assembly;a=this._encode(m.mixin({},this._url.query,{f:"json",returnExtentOnly:!0,returnCountOnly:!0},a.toJson(d&&d[0])));var f=this._extentHandler,g=this._errorHandler;this.source&&(d={source:this.source.toJson()},a.layer=p.toJson(d));this.gdbVersion&&
(a.gdbVersion=this.gdbVersion);return n({url:this._url.path+"/query",content:a,callbackParamName:"callback",load:function(a,d){f(a,d,b,c,h.dfd)},error:function(a){g(a,c,h.dfd)}},this.requestOptions)},_handler:function(a,b,c,h,d){try{var f=new g(a);this._successHandler([f],"onComplete",c,d)}catch(k){this._errorHandler(k,h,d)}},_relationshipQueryHandler:function(a,b,c,h,d){try{var f=a.geometryType,k=a.spatialReference,n={};q.forEach(a.relatedRecordGroups,function(a){var b={};b.geometryType=f;b.spatialReference=
k;b.features=a.relatedRecords;b=new g(b);if(null!=a.objectId)n[a.objectId]=b;else for(var c in a)a.hasOwnProperty(c)&&"relatedRecords"!==c&&(n[a[c]]=b)});this._successHandler([n],"onExecuteRelationshipQueryComplete",c,d)}catch(m){this._errorHandler(m,h,d)}},_executeForIdsHandler:function(a,b,c,d,f){try{this._successHandler([a.objectIds],"onExecuteForIdsComplete",c,f)}catch(g){this._errorHandler(g,d,f)}},_countHandler:function(a,b,c,d,f){try{var g,k=a.features,n=a.objectIds;if(n)g=n.length;else{if(k)throw Error("Unable to perform query. Please check your parameters.");
g=a.count}this._successHandler([g],"onExecuteForCountComplete",c,f)}catch(m){this._errorHandler(m,d,f)}},_extentHandler:function(a,b,c,d,g){try{a.extent&&(a.extent=new f(a.extent)),this._successHandler([a],"onExecuteForExtentComplete",c,g)}catch(k){this._errorHandler(k,d,g)}}});b._createWrappers(k);c("extend-esri")&&m.setObject("tasks.QueryTask",k,t);return k})},"esri/layers/SelectionMode":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","../kernel","./RenderMode"],function(k,
m,q,s,p){k=k([p],{declaredClass:"esri.layers._SelectionMode",constructor:function(c){this.featureLayer=c;this._featureMap={}},propertyChangeHandler:function(c){this._init&&0===c&&this._applyTimeFilter()},resume:function(){this.propertyChangeHandler(0)}});q("extend-esri")&&m.setObject("layers._SelectionMode",k,s);return k})},"esri/layers/HeatmapManager":function(){define("dojo/_base/declare dojo/_base/lang dojo/on dojo/aspect dojo/_base/array require ../kernel ../sniff ../geometry/Point ./MapImageLayer ./MapImage ./FeatureLayer ../renderers/HeatmapRenderer ../tasks/query".split(" "),
function(k,m,q,s,p,c,t,n,d,f,b,a,g,l){function v(){}function e(a){var b=a.layer;return{geometry:a.geometry,attributes:a.attributes,getLayer:function(){return b}}}k=k(null,{declaredClass:"esri.layers.HeatmapManager",heatmapRenderer:null,sourceLayer:null,imageLayer:null,useTiles:!0,useWorker:!1,map:null,constructor:function(a){this.sourceLayer=a;this._hndls=[]},initialize:function(a){this.map=a;var b=this.sourceLayer,d=b.renderer;b.setDrawMode(!1);var b=this.imageLayer=new f({className:"heatmapImgLyr"}),
e=this;this.heatmapRenderer=d instanceof g?d:(d.getRendererInfoByZoom(a.getZoom())||d.getRendererInfoByScale(a.getScale())).renderer;this.recalculateHeatmap=this.recalculateHeatmap.bind(this);this._removeRenderer=this._removeRenderer.bind(this);this._handleRendererChange=this._handleRendererChange.bind(this);this._rendererChangeHandle=this.sourceLayer.on("renderer-change",this._handleRendererChange);a.addLayer(b);c(["../workers/heatmapCalculator"],function(a){e._calculator=new a(m.mixin({width:e.map.width,
height:e.map.height},e._getOptions()));e._setupRenderer();e.heatmapRenderer.getStats=function(a){return e._calculator.calculateStats(a||1)};e.heatmapRenderer.getHistogramData=function(a,b){return e._calculator.getHistogramData(a,b)}})},destroy:function(){this._removeHandlers();this.map.removeLayer(this.imageLayer);this._rendererChangeHandle.remove();this._rendererChangeHandle=this.sourceLayer=this.imageLayer=this.map=this.heatmapRenderer=this._hndls=null},_handleRendererChange:function(a){var b=a.renderer,
c=b instanceof g;this.heatmapRenderer?c?this.heatmapRenderer=b:this._removeRenderer(a):c&&(this.heatmapRenderer=b,this.sourceLayer&&this.map&&this._setupRenderer())},_setupRenderer:function(){var b=this._hndls,c=this.sourceLayer,d=this.map,e=this;c._originalDraw=c._draw;c._draw=v;c._div.clear();setTimeout(this._resetGraphics.bind(this),250);b.push(c.on("update-end",function(a){e.recalculateHeatmap()}));b.push(c.on("suspend",function(a){e.imageLayer.suspend()}));b.push(c.on("resume",function(a){e.imageLayer.resume()}));
b.push(s.after(c,"redraw",this.recalculateHeatmap));b.push(d.on("layer-remove",function(a){a.layer==c&&(d.removeLayer(e.imageLayer),e._removeRenderer({target:c}))}));c.mode!==a.MODE_ONDEMAND&&(b.push(d.on("resize, pan-end",function(a){setTimeout(e.recalculateHeatmap,16)})),b.push(d.on("zoom-end",function(a){setTimeout(function(){c._getRenderer().isInstanceOf(g)&&e.recalculateHeatmap()},16)})));this.imageLayer.suspended&&this.imageLayer.resume();c.graphics&&c.graphics.length&&this.recalculateHeatmap()},
_removeRenderer:function(a){var b=a.target;b._draw=b._originalDraw;delete b._originalDraw;b.setDrawMode(!0);this._removeHandlers();this._hndls=[];b.renderer!=a.renderer&&b.renderer.getRendererInfo?(this.heatmapRenderer=null,this.imageLayer.suspend()):(b.redraw(),this.destroy())},recalculateHeatmap:function(){this._calculator?this._doMainCalculation():this._calculatorClient&&this._doWorkerCalculation()},_doWorkerCalculation:function(){},_doMainCalculation:function(){var a=this.sourceLayer,c=this.imageLayer,
d=this.map,f=this.heatmapRenderer,g=this.map.extent,k=this.map.width,n=this.map.height,p=this._calculator,t=this,q=function(l){l=t._getScreenPoints(l.features,d,a);l=p.calculateImageData(m.mixin({screenPoints:l,mapinfo:{extent:[g.xmin,g.ymin,g.xmax,g.ymax],resolution:d.getResolution()},width:k,height:n},t._getOptions()));l=f.getSymbol(e({geometry:d.extent,attributes:{size:[k,n],imageData:l},layer:a}));l=new b({extent:d.extent,href:l.url});c.addImage(l);setTimeout(function(){var a=c._mapImages.slice(0,
-1),b=a.length;if(1E3<b)a=c._mapImages[b],c.removeAllImages(),c.addImage(a);else for(;b--&&a[b];)c.removeImage(a[b])},250)},s={geometry:d.extent,timeExtent:d.timeExtent,spatialRelationship:l.SPATIAL_REL_INTERSECTS};null!=a._canDoClientSideQuery(s)?a.queryFeatures(s,q):q({features:a.graphics})},_getScreenPoints:function(a,b,c){var e=[],f=a.length,g=0,l=0,k,n=new d(b.extent.xmin,b.extent.ymax,b.spatialReference),m=b.toScreen(n),t=m.x,m=m.y,q=b.getResolution(),s;for(b.extent._parts&&(s=p.map(b.extent._parts,
function(a){return c._intersects(b,a.extent)[0]}));f--;)l=a[f],l.geometry&&(k={x:Math.ceil((l.geometry.x-n.x)/q+t),y:Math.floor((n.y-l.geometry.y)/q-m),attributes:l.attributes},s&&(l=1<s.length&&k.x<-s[0]?s[1]:s[0],k.x+=l),e[g++]=k);return e},_removeHandlers:function(){for(var a=this._hndls.length;a--;)this._hndls[a].remove()},_getOptions:function(){var a=this.heatmapRenderer;return{blurRadius:a.blurRadius,gradient:a.gradient,maxPixelIntensity:a.maxPixelIntensity,minPixelIntensity:a.minPixelIntensity,
field:a.field}},_resetGraphics:function(){for(var a=this.sourceLayer.graphics,b=a.length,c;b--;)c=a[b],c._shape=c._offsets=void 0}});n("extend-esri")&&m.setObject("layers.HeatmapManager",k,t);return k})},"esri/layers/SnapshotMode":function(){define("dojo/_base/declare dojo/_base/lang dojo/has ../kernel ../SpatialReference ../tasks/query ./RenderMode".split(" "),function(k,m,q,s,p,c,t){k=k([t],{declaredClass:"esri.layers._SnapshotMode",constructor:function(c){this.featureLayer=c;this.pagination=c.queryPagination;
this._featureMap={};this._drawFeatures=m.hitch(this,this._drawFeatures);this._queryErrorHandler=m.hitch(this,this._queryErrorHandler)},startup:function(){this.pagination=this.pagination&&null!=this.featureLayer.maxRecordCount;this.featureLayer._collection?this._applyTimeFilter():this._fetchAll()},propertyChangeHandler:function(c){this._init&&(c?this.featureLayer._collection?console.log("FeatureLayer: layer created by value (from a feature collection) does not support definition expressions and time definitions. Layer id \x3d "+
this.featureLayer.id):this._fetchAll():this._applyTimeFilter())},drawFeature:function(c){var d=c.attributes[this.featureLayer.objectIdField];this._addFeatureIIf(d,c);this._incRefCount(d)},resume:function(){this.propertyChangeHandler(0)},refresh:function(){var c=this.featureLayer;c._collection?(c._fireUpdateStart(),c._refresh(!0),c._fireUpdateEnd()):this._fetchAll()},_getRequestId:function(c){return("_"+c.name+c.layerId+c._ulid).replace(/[^a-zA-Z0-9\_]+/g,"_")},_fetchAll:function(){var c=this.featureLayer;
!c._collection&&!c.suspended&&(c._fireUpdateStart(),this._clearIIf(),this._sendRequest())},_sendRequest:function(k){var d=this.map,f=this.featureLayer,b=f.getDefinitionExpression(),a=new c;a.outFields=f.getOutFields();a.where=b||"1\x3d1";a.returnGeometry=!0;a.outSpatialReference=new p(d.spatialReference.toJson());a.timeExtent=f.getTimeDefinition();a.maxAllowableOffset=f._maxOffset;a.quantizationParameters=f._quantizationParameters;f._ts&&(a._ts=(new Date).getTime());a.orderByFields=f.supportsAdvancedQueries?
f.getOrderByFields():null;a.multipatchOption=f.multipatchOption;this.pagination&&(this._start=a.start=null==k?0:k,a.num=f.maxRecordCount);var g;f._usePatch&&(g=this._getRequestId(f),this._cancelPendingRequest(null,g));f._task.execute(a,this._drawFeatures,this._queryErrorHandler,g)},_drawFeatures:function(c){this._purgeRequests();var d=c.features,f=this.featureLayer,b=f.objectIdField,a,g=d.length,l=c.exceededTransferLimit&&!f._collection,k,e;for(a=0;a<g;a++)k=d[a],e=k.attributes[b],this._addFeatureIIf(e,
k),this._incRefCount(e);this._applyTimeFilter(!0);if(!this.pagination||!l)f._fireUpdateEnd(null,c.exceededTransferLimit?{queryLimitExceeded:!0}:null);l&&(this.pagination&&this._sendRequest(this._start+f.maxRecordCount),f.onQueryLimitExceeded())},_queryErrorHandler:function(c){this._purgeRequests();var d=this.featureLayer;d._errorHandler(c);d._fireUpdateEnd(c)}});q("extend-esri")&&m.setObject("layers._SnapshotMode",k,s);return k})},"*noref":1}});
define("esri/layers/FeatureLayer","require module dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/_base/json dojo/_base/Deferred dojo/date/locale dojo/sniff dojo/io-query dojo/dom-construct dojo/i18n dojo/when dojo/promise/all ../kernel ../lang ../request ../config ../deferredUtils ../SpatialReference ../symbols/SimpleMarkerSymbol ../symbols/SimpleLineSymbol ../symbols/SimpleFillSymbol ../symbols/jsonUtils ../renderers/SimpleRenderer ../renderers/UniqueValueRenderer ../renderers/jsonUtils ../tasks/QueryTask ../tasks/query ../tasks/FeatureSet ../tasks/StatisticDefinition ../geometry/Extent ../geometry/jsonUtils ../geometry/normalizeUtils ../geometry/scaleUtils ./GraphicsLayer ./Field ./TimeInfo ./FeatureType ./FeatureTemplate ./FeatureEditResult ./LabelClass ./SnapshotMode ./OnDemandMode ./SelectionMode ./StreamMode ./TrackManager ./HeatmapManager dojo/i18n!../nls/jsapi dojo/has!extend-esri?./agscommon".split(" "),function(k,
m,q,s,p,c,t,n,d,f,b,a,g,l,v,e,h,r,x,w,E,L,M,A,y,B,N,O,P,F,G,Q,J,R,S,T,U,V,W,X,Y,C,Z,H,$,aa,ba,ca,K,da){var ea=x.defaults,z=q(U,{declaredClass:"esri.layers.FeatureLayer",invalidParams:"query contains one or more unsupported parameters",reHostedFS:/https?:\/\/services.*\.arcgis\.com/i,maxPointCountForAuto:4E3,maxRecordCountForAuto:2E3,maxVertexCountForAuto:25E4,generalizeForScale:4E3,_eventMap:{"add-attachment-complete":["result"],"before-apply-edits":["adds","updates","deletes"],"delete-attachments-complete":["results"],
"edits-complete":["adds","updates","deletes"],"query-attachment-infos-complete":["results"],"query-count-complete":["count"],"query-features-complete":["featureSet"],"query-ids-complete":["objectIds"],"query-related-features-complete":["featureSets"],"selection-complete":["features","method"],"update-end":["error","info"]},constructor:function(a,b){this._preventInit||this._initFeatureLayer(a,b)},_initFeatureLayer:function(a,b){this.i18n=da;b=b||{};this.showLabels=null!=b.showLabels?b.showLabels:!0;
this._outFields=b.outFields;this._defnExpr=b.definitionExpression;this._loadCallback=b.loadCallback;var c=b._usePatch;this._usePatch=null===c||void 0===c?!0:c;this._trackIdField=b.trackIdField;this.objectIdField=b.objectIdField;this._maxOffset=null!=b.maxAllowableOffset?b.maxAllowableOffset:this.maxAllowableOffset;this.quantize=null!=b.quantize?b.quantize:!0;this._optEditable=b.editable;this._optAutoGen=b.autoGeneralize;this.editSummaryCallback=b.editSummaryCallback;this.userId=b.userId;this.userIsAdmin=
b.userIsAdmin;this.useMapTime=b.hasOwnProperty("useMapTime")?!!b.useMapTime:!0;this.source=b.source;this.gdbVersion=b.gdbVersion;this.orderByFields=b.orderByFields;this.maxPointCountForAuto=null!=b.maxPointCountForAuto?b.maxPointCountForAuto:this.maxPointCountForAuto;this.maxRecordCountForAuto=null!=b.maxRecordCountForAuto?b.maxRecordCountForAuto:this.maxRecordCountForAuto;this.maxVertexCountForAuto=null!=b.maxVertexCountForAuto?b.maxVertexCountForAuto:this.maxVertexCountForAuto;this.generalizeForScale=
null!=b.generalizeForScale?b.generalizeForScale:this.generalizeForScale;this.queryPagination=null!=b.queryPagination?b.queryPagination:this.url?this.reHostedFS.test(this.url):!1;this.multipatchOption=b.multipatchOption;this._selectedFeatures={};this._selectedFeaturesArr=[];this._newFeatures=[];this._deletedFeatures={};this._ulid=this._getUniqueId();var d=z,c=this.mode=h.isDefined(b.mode)?b.mode:d.MODE_ONDEMAND;this._isStream&&(this.mode=c=d.MODE_STREAM);switch(c){case d.MODE_SNAPSHOT:this.currentMode=
d.MODE_SNAPSHOT;this._mode=new H(this);this._isSnapshot=!0;break;case d.MODE_ONDEMAND:case d.MODE_AUTO:this.currentMode=d.MODE_ONDEMAND;this._tileWidth=b.tileWidth||512;this._tileHeight=b.tileHeight||512;this._mode=new $(this);this.latticeTiling=b.latticeTiling;break;case d.MODE_SELECTION:this.currentMode=d.MODE_SELECTION;this._mode=new aa(this);this._isSelOnly=!0;break;case d.MODE_STREAM:this.currentMode=d.MODE_STREAM,this._mode=new ba(this),this._isStream=!0}this._initLayer=p.hitch(this,this._initLayer);
this._selectHandler=p.hitch(this,this._selectHandler);this._editable=!1;if(p.isObject(a)&&a.layerDefinition)return this._collection=!0,this.mode=this._isStream?d.MODE_STREAM:d.MODE_SNAPSHOT,this._initLayer(a),this;this._task=new P(this.url,{source:this.source,gdbVersion:this.gdbVersion});c=this._url.path;this._fserver=!1;-1!==c.search(/\/FeatureServer\//i)&&(this._fserver=!0);this.mode===d.MODE_AUTO&&this.reHostedFS.test(this.url)&&this._queryLimit();(d=b.resourceInfo)?this._initLayer(d):(this.source&&
(d={source:this.source.toJson()},this._url.query=p.mixin(this._url.query,{layer:t.toJson(d)})),this.gdbVersion&&(this._url.query=p.mixin(this._url.query,{gdbVersion:this.gdbVersion})),r({url:c,content:p.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler}));this.registerConnectEvents()},_initLayer:function(a,b){if(a||b){this._json=a;this._findCredential();if(this.credential&&this.credential.ssl||a&&a._ssl)this._useSSL(),this._task._useSSL();
this._collection&&(this._isStream||(this.currentMode=z.MODE_SNAPSHOT,this._mode=new H(this)),this._isSnapshot=!0,this._featureSet=a.featureSet,this._nextId=a.nextObjectId,a=a.layerDefinition);this.geometryType=a.geometryType;"string"!==typeof this.multipatchOption&&"esriGeometryMultiPatch"===this.geometryType&&(this.multipatchOption="xyFootprint");if(a.hasOwnProperty("capabilities")){var u=this.capabilities=a.capabilities;u&&-1!==u.toLowerCase().indexOf("editing")?this._editable=!0:this._editable=
!1}else this._collection||(this._editable=this._fserver);h.isDefined(this._optEditable)?(this._editable=this._optEditable,delete this._optEditable):"esriGeometryMultiPatch"===this.geometryType&&(this._editable=!1);this._json=t.toJson(this._json);if(this.isEditable())this._setMaxOffset(null);else if(this.currentMode!==z.MODE_SNAPSHOT&&("esriGeometryPolyline"===this.geometryType||"esriGeometryPolygon"===this.geometryType||this.hasXYFootprint()))this._autoGeneralize=h.isDefined(this._optAutoGen)?this._optAutoGen:
this.currentMode===z.MODE_ONDEMAND,delete this._optAutoGen;var u=a.effectiveMinScale||a.minScale,d=a.effectiveMaxScale||a.maxScale;!this._hasMin&&u&&this.setMinScale(u);!this._hasMax&&d&&this.setMaxScale(d);this.layerId=a.id;this.name=a.name;this.description=a.description;this.copyright=a.copyrightText;this.type=a.type;this.displayField=a.displayField;this.defaultDefinitionExpression=a.definitionExpression;this.fullExtent=new J(a.extent);this.initialExtent=new J(this.fullExtent.toJson());this.fullExtent.spatialReference&&
(this.spatialReference=new E(this.fullExtent.spatialReference.toJson()));this.defaultVisibility=a.defaultVisibility;if("esriGeometryPoint"===this.geometryType||"esriGeometryMultipoint"===this.geometryType)this.latticeTiling=!1;this.indexedFields=a.indexedFields;this.maxRecordCount=a.maxRecordCount;this.canModifyLayer=a.canModifyLayer;this.supportsStatistics=a.supportsStatistics;this.supportsAdvancedQueries=this._collection?!1:a.supportsAdvancedQueries;this.supportsCalculate=a.supportsCalculate;this.supportsAttachmentsByUploadId=
a.supportsAttachmentsByUploadId;this.supportsCoordinatesQuantization=a.supportsCoordinatesQuantization;this.quantize=this.quantize&&this.supportsCoordinatesQuantization;this.hasLabels=a.hasLabels;this.canScaleSymbols=a.canScaleSymbols;this.supportsRollbackOnFailureParameter=this.supportsRollbackOnFailure=a.supportsRollbackOnFailure;this.syncCanReturnChanges=a.syncCanReturnChanges;this.isDataVersioned=a.isDataVersioned;this.editFieldsInfo=a.editFieldsInfo;this.ownershipBasedAccessControlForFeatures=
a.ownershipBasedAccessControlForFeatures;this.editFieldsInfo&&this.ownershipBasedAccessControlForFeatures&&(this.creatorField=this.editFieldsInfo.creatorField);this.relationships=a.relationships;this.allowGeometryUpdates=h.isDefined(a.allowGeometryUpdates)?a.allowGeometryUpdates:!0;this.advancedQueryCapabilities=a.advancedQueryCapabilities||{supportsStatistics:this.supportsStatistics,supportsOrderBy:this.supportsAdvancedQueries,supportsDistinct:this.supportsAdvancedQueries};this._setMaxOffset(this._maxOffset,
!0);this._isTable="Table"===this.type;for(var e=this.fields=[],d=a.fields,u=0;u<d.length;u++)e.push(new V(d[u]));if(!this.objectIdField){this.objectIdField=a.objectIdField;if(!this.objectIdField){d=a.fields;for(u=0;u<d.length;u++)if(e=d[u],"esriFieldTypeOID"===e.type){this.objectIdField=e.name;break}}!this.objectIdField&&!this._isStream&&console.debug("esri.layers.FeatureLayer: "+h.substitute({url:this.url},"objectIdField is not set [url: ${url}]"))}if(!h.isDefined(this._nextId)){d=this.objectIdField;
e=-1;if(this._collection&&d)for(var g=(u=this._featureSet)&&u.features,l=g?g.length:0,k,u=0;u<l;u++)k=(k=g[u].attributes)&&k[d],k>e&&(e=k);this._nextId=e+1}this.globalIdField=a.globalIdField;if(u=this.typeIdField=a.typeIdField)if(u=!this._getField(u)&&this._getField(u,!0))this.typeIdField=u.name;this.visibilityField=a.visibilityField;if(d=a.defaultSymbol)this.defaultSymbol=y.fromJson(d);var m=this.types=[],n=a.types,D,r,e=(u=this.editFieldsInfo)&&u.creatorField,g=u&&u.editorField;k=e||g;l=[];if(n)for(u=
0;u<n.length;u++)D=new X(n[u]),r=D.templates,k&&(r&&r.length)&&(l=l.concat(r)),m.push(D);n=a.templates;D=this.templates=[];if(n)for(u=0;u<n.length;u++)m=new Y(n[u]),k&&l.push(m),D.push(m);for(u=0;u<l.length;u++)if(k=p.getObject("prototype.attributes",!1,l[u]))e&&delete k[e],g&&delete k[g];if(u=a.timeInfo)this.timeInfo=new W(u),this._startTimeField=u.startTimeField,this._endTimeField=u.endTimeField,this._startTimeField&&this._endTimeField&&(this._twoTimeFields=!0),this._trackIdField?u.trackIdField=
this._trackIdField:this._trackIdField=u.trackIdField;this.hasAttachments=!this._collection&&a.hasAttachments?!0:!1;this.htmlPopupType=a.htmlPopupType;var u=a.drawingInfo,q;if((e=u&&u.labelingInfo)&&!this.labelingInfo)this.labelingInfo=c.map(e,function(a){return new Z(a)}),this._fixLabelExpr();if(!this.renderer)if(u&&u.renderer){if(q=u.renderer,this.setRenderer(O.fromJson(q)),"classBreaks"===q.type&&this.renderer.setMaxInclusive(!0),!this._collection){var s=q.type,d=[];q=this.renderer;switch(s){case "simple":d.push(q.symbol);
break;case "uniqueValue":case "classBreaks":d.push(q.defaultSymbol),d=d.concat(c.map(q.infos,function(a){return a.symbol}))}var d=c.filter(d,h.isDefined),fa=this._url.path+"/images/",v=this._getToken();c.forEach(d,function(a){var b=a.url;b&&(-1===b.search(/https?\:/)&&-1===b.indexOf("data:")&&(a.url=fa+b),v&&-1!==a.url.search(/https?\:/)&&(a.url+="?token\x3d"+v))})}}else if(d)n=this.types,0<n.length?(q=new N(this.defaultSymbol,this.typeIdField),c.forEach(n,function(a){q.addValue(a.id,a.symbol)})):
q=new B(this.defaultSymbol),this.setRenderer(q);else if(!this._isTable){switch(this.geometryType){case "esriGeometryPoint":case "esriGeometryMultipoint":s=new L;break;case "esriGeometryPolyline":s=new M;break;case "esriGeometryPolygon":s=new A;break;default:this.hasXYFootprint()&&(s=new A)}this.setRenderer(s?new B(s):null)}s=u&&u.transparency||0;!this.hasOwnProperty("opacity")&&0<s&&(this.opacity=1-s/100);this.version=a.currentVersion;this.version||(this.version="capabilities"in a||"drawingInfo"in
a||"hasAttachments"in a||"htmlPopupType"in a||"relationships"in a||"timeInfo"in a||"typeIdField"in a||"types"in a?10:9.3);if((f("ie")||7<=f("trident")||f("safari"))&&this.isEditable()&&10.02>this.version)this._ts=!0;this.statistics=a.statistics;this._fixRendererFields();this._checkFields();this._updateCaps();var I=function(){this.currentMode!==z.MODE_SNAPSHOT&&(this.queryPagination=!1);this.loaded=!0;this.onLoad(this);var a=this._loadCallback;a&&(delete this._loadCallback,a(this))};this._collection?
(s=this._featureSet,this._featureSet=null,this._mode._drawFeatures(new G(s)),this._fcAdded=!0,I.call(this)):this._forceIdentity(this._limitPromise?function(){var a=this;this._limitPromise.then(function(b){a._checkMode(b)});this._limitPromise.always(function(){a._limitPromise=null;I.call(a)})}:I)}},setShowLabels:function(a){this.showLabels=a;this.onShowLabelsChange()},onShowLabelsChange:function(){},onRendererChange:function(a){this.inherited(arguments);var b=this._map;this._ager=!(!a||!a.observationAger||
!a.observationRenderer);a&&"colors"in a&&"blurRadius"in a&&"maxPixelIntensity"in a?"esriGeometryPoint"==this.geometryType&&(!this._heatmapManager&&b)&&(this._heatmapManager=new K(this),this._heatmapManager.initialize(b)):this.renderer&&this.renderer.getRendererInfo?c.some(this.renderer.rendererInfos,function(a){return a.renderer&&"colors"in a.renderer&&"blurRadius"in a.renderer})||(this._heatmapManager=null):this._heatmapManager=null;if(a){var d=[],b=c.filter([a,a.observationRenderer,a.latestObservationRenderer,
a.trackRenderer],h.isDefined),e=function(a){return null!=a&&"function"!=typeof a&&a};c.forEach(b,function(a){var b=e(a.attributeField),c=e(a.attributeField2);a=e(a.attributeField3);!1!==b&&d.push(b);!1!==c&&d.push(c);!1!==a&&d.push(a)});this._rendererFields=d}else this._rendererFields=[];this.loaded&&(this._fixRendererFields(),this._checkFields(this._rendererFields),this._collection&&(this._typesDirty=!0))},redraw:function(){this.inherited(arguments);this._trackManager&&this._trackManager.container&&
this._trackManager.container.redraw()},_evalSDRenderer:function(){this.inherited(arguments);var a=this._getRenderer();this._ager=!(!a||!a.observationAger||!a.observationRenderer);this._trackManager&&this._trackManager.container&&this._trackManager.container.setRenderer(a&&a.trackRenderer)},_setMap:function(a){var b=this.inherited(arguments),c=this._mode,d=this;c&&c.initialize(a);this.geometryType&&this.attr("data-geometry-type",this.geometryType.replace(/esriGeometry/i,"").toLowerCase());this._addHandle=
this.on("graphic-node-add",function(a){a=a.graphic.attributes;(a=d._selectedFeatures[a&&a[d.objectIdField]])&&a.attr("data-selected","")});return b},_unsetMap:function(a){var b=this._mode;b&&b.suspend();this._trackManager&&(this._trackManager.destroy(),this._trackManager=null);s.disconnect(this._zoomConnect);s.disconnect(this._addHandle);this._zoomConnect=this._addHandle=null;this._toggleTime(!1);this.inherited("_unsetMap",arguments)},refresh:function(){var a=this._mode;a&&a.refresh()},hasXYFootprint:function(){return"esriGeometryMultiPatch"===
this.geometryType&&"xyFootprint"===this.multipatchOption},getOutFields:function(){return c.filter(this._getOutFields(),function(a){return"*"===a||!!this._getField(a)},this)},getField:function(a){return this._getField(a,!0)},getDomain:function(a,b){var d,e,h=b&&b.feature,f=h&&this.typeIdField&&h.attributes&&h.attributes[this.typeIdField];null!=f&&c.some(this.types,function(b){if(b.id==f){if((d=b.domains&&b.domains[a])&&"inherited"===d.type)d=this._getLayerDomain(a),e=!0;return!0}return!1},this);!e&&
!d&&(d=this._getLayerDomain(a));return d},_getLayerDomain:function(a){var b;c.some(this.fields,function(c){c.name===a&&(b=c.domain);return!!b});return b},getType:function(a){var b,d=a&&this.typeIdField&&a.attributes&&a.attributes[this.typeIdField];c.some(this.types,function(a){a.id==d&&(b=a);return!!b});return b},setEditable:function(a){if(!this._collection)return console.log("FeatureLayer:setEditable - this functionality is not yet supported for layer in a feature service"),this;if(!this.loaded)return this._optEditable=
a,this;var b=this._editable;this._editable=a;this._updateCaps();if(b!==a)this.onCapabilitiesChange();return this},getEditCapabilities:function(a){var b={canCreate:!1,canUpdate:!1,canDelete:!1};if(!this.loaded||!this.isEditable())return b;var d=a&&a.feature;a=a&&a.userId;var e=c.map(this.capabilities?this.capabilities.toLowerCase().split(","):[],p.trim),h=-1<c.indexOf(e,"editing"),f=h&&-1<c.indexOf(e,"create"),b=h&&-1<c.indexOf(e,"update"),e=h&&-1<c.indexOf(e,"delete"),g=this.ownershipBasedAccessControlForFeatures,
k=this.editFieldsInfo,l=k&&k.creatorField,k=k&&k.realm,d=(d=d&&d.attributes)&&l?d[l]:void 0,m=!!this.userIsAdmin,l=!g||m||!(!g.allowOthersToUpdate&&!g.allowUpdateToOthers),g=!g||m||!(!g.allowOthersToDelete&&!g.allowDeleteToOthers);if(m||h&&!f&&!b&&!e)f=b=e=!0;h={canCreate:f,canUpdate:b,canDelete:e};null===d?(h.canUpdate=b&&l,h.canDelete=e&&g):""!==d&&d&&((a=a||this.getUserId())&&k&&(a=a+"@"+k),a.toLowerCase()!==d.toLowerCase()&&(h.canUpdate=b&&l,h.canDelete=e&&g));return h},getUserId:function(){var a;
this.loaded&&(a=this.credential&&this.credential.userId||this.userId||"");return a},setUserIsAdmin:function(a){this.userIsAdmin=a},setEditSummaryCallback:function(a){this.editSummaryCallback=a},getEditSummary:function(a,b,c){c=h.isDefined(c)?c:(new Date).getTime();var d="";c=this.getEditInfo(a,b,c);(b=b&&b.callback||this.editSummaryCallback)&&(c=b(a,c)||"");if(p.isString(c))d=c;else{if(c){a=c.action;b=c.userId;var e=c.timeValue,g=0;a&&g++;b&&g++;h.isDefined(e)&&g++;1<g&&(d=("edit"===a?"edit":"create")+
(b?"User":"")+(h.isDefined(e)?c.displayPattern:""))}d=d&&h.substitute(c,this.i18n.layers.FeatureLayer[d])}return d},getEditInfo:function(a,b,c){if(this.loaded){c=h.isDefined(c)?c:(new Date).getTime();b=b&&b.action||"last";var d=this.editFieldsInfo,e=d&&d.creatorField,g=d&&d.creationDateField,f=d&&d.editorField,d=d&&d.editDateField,f=(a=a&&a.attributes)&&f?a[f]:void 0,d=a&&d?a[d]:null,e=this._getEditData(a&&e?a[e]:void 0,a&&g?a[g]:null,c);c=this._getEditData(f,d,c);var k;switch(b){case "creation":k=
e;break;case "edit":k=c;break;case "last":k=c||e}k&&(k.action=k===c?"edit":"creation");return k}},_getEditData:function(a,b,c){var e,g,f;h.isDefined(b)&&(g=c-b,f=0>g?"Full":6E4>g?"Seconds":12E4>g?"Minute":36E5>g?"Minutes":72E5>g?"Hour":864E5>g?"Hours":6048E5>g?"WeekDay":"Full");if(void 0!==a||f)e=e||{},e.userId=a,f&&(a=d.format,c=new Date(b),e.minutes=Math.floor(g/6E4),e.hours=Math.floor(g/36E5),e.weekDay=a(c,{datePattern:"EEEE",selector:"date"}),e.formattedDate=a(c,{selector:"date"}),e.formattedTime=
a(c,{selector:"time"}),e.displayPattern=f,e.timeValue=b);return e},isEditable:function(){return!(!this._editable&&!this.userIsAdmin)},setMaxAllowableOffset:function(a){this.isEditable()||this._setMaxOffset(a,!0);return this},getMaxAllowableOffset:function(){var a=this._quantizationParameters?this._quantizationParameters.tolerance:void 0;return null!=this._maxOffset?this._maxOffset:a},_setMaxOffset:function(a,b){if(null==a)return delete this._maxOffset,delete this._quantizationParameters,this;this.quantize&&
this.supportsCoordinatesQuantization?("esriGeometryPolyline"===this.geometryType?this._maxOffset=a:delete this._maxOffset,this._quantizationParameters={mode:"view",originPosition:"upperLeft",tolerance:a,extent:this.fullExtent}):(b||(a=Math.floor(a)),this._maxOffset=a,delete this._quantizationParameters);return this},setAutoGeneralize:function(a){if(this.loaded){if(!this.isEditable()&&this.currentMode!==z.MODE_SNAPSHOT&&("esriGeometryPolyline"===this.geometryType||"esriGeometryPolygon"===this.geometryType||
this.hasXYFootprint()))(this._autoGeneralize=a)?(a=this._map)&&a.loaded&&this._setMaxOffset(a.extent.getWidth()/a.width):this._setMaxOffset(null)}else this._optAutoGen=a;return this},setGDBVersion:function(a){if(!this._collection&&a!==this.gdbVersion&&(a||this.gdbVersion))this.gdbVersion=a,this._task.gdbVersion=a,this._url.query=p.mixin(this._url.query,{gdbVersion:a}),this.loaded&&(this.clearSelection(),this._map&&this.refresh()),this.onGDBVersionChange();return this},setDefinitionExpression:function(a){this._defnExpr=
a;(a=this._mode)&&a.propertyChangeHandler(1);return this},getDefinitionExpression:function(){return this._defnExpr},setTimeDefinition:function(a){this._isSnapshot?(this._timeDefn=a,(a=this._mode)&&a.propertyChangeHandler(2)):console.log("FeatureLayer.setTimeDefinition: layer in on-demand or selection mode does not support time definitions. Layer id \x3d "+this.id+", Layer URL \x3d "+this.url);return this},getTimeDefinition:function(){return this._timeDefn},setTimeOffset:function(a,b){this._timeOffset=
a;this._timeOffsetUnits=b;var c=this._mode;c&&c.propertyChangeHandler(0);return this},setUseMapTime:function(a){this.useMapTime=a;this._toggleTime(!this.suspended);(a=this._mode)&&a.propertyChangeHandler(0)},selectFeatures:function(a,b,c,d){b=b||z.SELECTION_NEW;a=this._getShallowClone(a);var e=this._map,g,h=this,f=w._fixDfd(new n(w._dfdCanceller));a.outFields=this.getOutFields();a.returnGeometry=!0;a.multipatchOption=this.multipatchOption;e&&(a.outSpatialReference=new E(e.spatialReference.toJson()));
if(!this._applyQueryFilters(a,!0))return g={features:[]},this._selectHandler(g,b,c,d,f),f;if(e=this._canDoClientSideQuery(a))f._pendingDfd=l(this._doQuery(a,e)),f._pendingDfd.then(function(a){g={features:a};h._selectHandler(g,b,c,d,f)});else{if(this._collection)return this._resolve([Error("FeatureLayer::selectFeatures - "+this.invalidParams)],null,d,f,!0),f;var k=this;this._ts&&(a._ts=(new Date).getTime());(f._pendingDfd=this._task.execute(a)).addCallbacks(function(a){k._selectHandler(a,b,c,d,f)},
function(a){k._resolve([a],null,d,f,!0)})}return f},getSelectedFeatures:function(){var a=this._selectedFeatures,b=[],c;for(c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b},clearSelection:function(a){var b=this._selectedFeatures,c=this._mode,d;for(d in b)b.hasOwnProperty(d)&&(this._unSelectFeatureIIf(d,c),c._removeFeatureIIf(d));this._selectedFeatures={};this._isSelOnly&&c._applyTimeFilter(!0);if(!a)this.onSelectionClear();return this},setSelectionSymbol:function(a){if(this._selectionSymbol=a){var b=
this._selectedFeatures,c;for(c in b)b.hasOwnProperty(c)&&b[c].setSymbol(a)}return this},getSelectionSymbol:function(){return this._selectionSymbol},setLabelingInfo:function(a){a?(this.labelingInfo=a,this._fixLabelExpr()):delete this.labelingInfo;this._collection&&(this._typesDirty=!0);this.onLabelingInfoChange()},_fixLabelExpr:function(){var a=/\[([^\[\]]+)\]/ig,b,d=this,e=function(a,b){var c=d._getField(b,!0);return"["+(c&&c.name||b)+"]"};c.forEach(this.labelingInfo,function(c){if(b=c.labelExpression)c.labelExpression=
b.replace(a,e)})},__msigns:[{n:"applyEdits",c:5,a:[{i:0},{i:1}],e:4,f:1}],applyEdits:function(a,b,d,e,g,f){var h=f.assembly,k=f.dfd;this._applyNormalized(a,h&&h[0]);this._applyNormalized(b,h&&h[1]);this.onBeforeApplyEdits(a,b,d);var l={},m=this.objectIdField,h={f:"json"},n=!1;if(this._collection)f={},f.addResults=a?c.map(a,function(){n=!0;return{objectId:this._nextId++,success:!0}},this):null,f.updateResults=b?c.map(b,function(a){n=!0;var b=a.attributes[m];l[b]=a;return{objectId:b,success:!0}},this):
null,f.deleteResults=d?c.map(d,function(a){n=!0;return{objectId:a.attributes[m],success:!0}},this):null,n?this._editHandler(f,a,l,e,g,k):this._resolve([f.addResults,f.updateResults,f.deleteResults],null,e,k);else{a&&0<a.length&&(h.adds=this._convertFeaturesToJson(a,0,1),n=!0);if(b&&0<b.length){for(f=0;f<b.length;f++){var q=b[f];l[q.attributes[m]]=q}h.updates=this._convertFeaturesToJson(b,0,0,1);n=!0}if(d&&0<d.length){b=[];for(f=0;f<d.length;f++)b.push(d[f].attributes[m]);h.deletes=b.join(",");n=!0}if(n){var s=
this;return r({url:this._url.path+"/applyEdits",content:p.mixin(h,this._url.query),callbackParamName:"callback",load:function(b){s._editHandler(b,a,l,e,g,k)},error:function(a){s._resolve([a],null,g,k,!0)}},{usePost:!0})}this._resolve([],null,e,k)}},queryFeatures:function(a,b,c){return this._query("execute","onQueryFeaturesComplete",a,b,c)},queryRelatedFeatures:function(a,b,c){return this._query("executeRelationshipQuery","onQueryRelatedFeaturesComplete",a,b,c)},queryIds:function(a,b,c){return this._query("executeForIds",
"onQueryIdsComplete",a,b,c)},queryCount:function(a,b,c){return this._query("executeForCount","onQueryCountComplete",a,b,c)},queryExtent:function(a,b,c){return this._query("executeForExtent","onQueryExtentComplete",a,b,c)},queryAttachmentInfos:function(a,d,e){var f=this._url.path+"/"+a+"/attachments",h=new n(w._dfdCanceller),g=this;h._pendingDfd=r({url:f,content:p.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:function(e){e=e.attachmentInfos;var u;c.forEach(e,function(c){u=b.objectToQuery({gdbVersion:g._url.query&&
g._url.query.gdbVersion,layer:g._url.query&&g._url.query.layer,token:g._getToken()});c.url=f+"/"+c.id+(u?"?"+u:"");c.objectId=a});g._resolve([e],"onQueryAttachmentInfosComplete",d,h)},error:function(a){g._resolve([a],null,e,h,!0)}});return h},addAttachment:function(a,b,c,d){return this._sendAttachment("add",a,b,c,d)},updateAttachment:function(b,c,d,e,f){d.appendChild(a.create("input",{type:"hidden",name:"attachmentId",value:c}));return this._sendAttachment("update",b,d,e,f)},deleteAttachments:function(a,
b,d,e){var f=this._url.path+"/"+a+"/deleteAttachments",g=new n(w._dfdCanceller),h=this;b={f:"json",attachmentIds:b.join(",")};g._pendingDfd=r({url:f,content:p.mixin(b,this._url.query),callbackParamName:"callback",load:p.hitch(this,function(b){b=b.deleteAttachmentResults;b=c.map(b,function(b){b=new C(b);b.attachmentId=b.objectId;b.objectId=a;return b});h._resolve([b],"onDeleteAttachmentsComplete",d,g)}),error:function(a){h._resolve([a],null,e,g,!0)}},{usePost:!0});return g},addType:function(a){var b=
this.types;if(b){if(c.some(b,function(b){return b.id==a.id?!0:!1}))return!1;b.push(a)}else this.types=[a];return this._typesDirty=!0},deleteType:function(a){if(this._collection){var b=this.types;if(b){var d=-1;c.some(b,function(b,c){return b.id==a?(d=c,!0):!1});if(-1<d)return this._typesDirty=!0,b.splice(d,1)[0]}}},toJson:function(){var a=this._json;if(a=p.isString(a)?t.fromJson(a):p.clone(a)){var a=a.layerDefinition?a:{layerDefinition:a},b=a.layerDefinition,d=this._collection;if(d&&this._typesDirty){b.types=
c.map(this.types||[],function(a){return a.toJson()});var e=this.renderer,f=this.labelingInfo,g=b.drawingInfo;if((e||f)&&!g)g=b.drawingInfo={};g&&(e&&-1===e.declaredClass.indexOf("TemporalRenderer"))&&(g.renderer=e.toJson());f&&(g.labelingInfo=c.map(f,function(a){return a.toJson()}))}e=null;if(!d||this._fcAdded)e={geometryType:b.geometryType,features:this._convertFeaturesToJson(this.graphics,!0)};a.featureSet=p.mixin({},a.featureSet||{},e);d&&(a.nextObjectId=this._nextId,b.capabilities=this.capabilities);
return a}},onSelectionComplete:function(){},onSelectionClear:function(){},onBeforeApplyEdits:function(){},onEditsComplete:function(){},onQueryFeaturesComplete:function(){},onQueryRelatedFeaturesComplete:function(){},onQueryIdsComplete:function(){},onQueryCountComplete:function(){},onQueryExtentComplete:function(){},onQueryAttachmentInfosComplete:function(){},onAddAttachmentComplete:function(){},onUpdateAttachmentComplete:function(){},onDeleteAttachmentsComplete:function(){},onCapabilitiesChange:function(){},
onGDBVersionChange:function(){},onQueryLimitExceeded:function(){},onLabelingInfoChange:function(){},_forceIdentity:function(a){var b=this,c=this._url&&this._url.path;(this.ownershipBasedAccessControlForFeatures||this.userIsAdmin)&&!this._getToken()&&c&&e.id&&e.id._hasPortalSession()&&e.id._doPortalSignIn(c)?e.id.getCredential(c).then(function(){b._findCredential();a.call(b)},function(){a.call(b)}):a.call(this)},_checkMode:function(a){var b=this.geometryType,c=this.maxRecordCount;a=(a=a&&a.features&&
a.features[0])&&a.attributes&&a.attributes.exceedslimit;if(this.mode===z.MODE_AUTO&&!this.isEditable()&&0===a&&(this.queryPagination||("esriGeometryPolyline"===b||"esriGeometryPolygon"===b||"esriGeometryMultipoint"===b||this.hasXYFootprint())&&c>=this.maxRecordCountForAuto||"esriGeometryPoint"===b&&c>=this.maxPointCountForAuto))this.currentMode=z.MODE_SNAPSHOT,this._mode=new H(this),this._isSnapshot=!0,this._autoGeneralize=!1},_queryLimit:function(){var a=this,b=new n;this._limitPromise=b.promise;
setTimeout(function(){var c=new F,d=new Q;d.statisticType="exceedslimit";d.maxPointCount=a.maxPointCountForAuto;d.maxRecordCount=a.maxRecordCountForAuto;d.maxVertexCount=a.maxVertexCountForAuto;d.outStatisticFieldName="exceedslimit";c.outStatistics=[d];a.queryFeatures(c).promise.then(function(a){b.resolve(a)},function(a){b.reject(a)})},0)},_updateCaps:function(){var a=this._editable,b=p.trim(this.capabilities||""),d=c.map(b?b.split(","):[],p.trim),e=c.map(b?b.toLowerCase().split(","):[],p.trim),b=
c.indexOf(e,"editing"),f,e={Create:c.indexOf(e,"create"),Update:c.indexOf(e,"update"),Delete:c.indexOf(e,"delete")};if(a&&-1===b)d.push("Editing");else if(!a&&-1<b){a=[b];for(f in e)-1<e[f]&&a.push(e[f]);a.sort();for(f=a.length-1;0<=f;f--)d.splice(a[f],1)}this.capabilities=d.join(",")},_counter:{value:0},_getUniqueId:function(){return this._counter.value++},onSuspend:function(){this.inherited(arguments);this._toggleTime(!1);var a=this._mode;a&&a.suspend()},onResume:function(a){this.inherited(arguments);
this._toggleTime(!0);this._updateMaxOffset();var b=this._mode,c=this._map,d=this._getRenderer();if(a.firstOccurrence){this._fixRendererFields();this._checkFields();this.clearSelection();if(this.timeInfo&&!this._trackManager&&(this._trackIdField||d&&(d.latestObservationRenderer||d.trackRenderer)))this._trackManager=new ca(this),this._trackManager.initialize(c);d&&("colors"in d&&"blurRadius"in d&&"maxPixelIntensity"in d)&&("esriGeometryPoint"==this.geometryType&&!this._heatmapManager)&&(this._heatmapManager=
new K(this),this._heatmapManager.initialize(c));if(this.mode===z.MODE_AUTO&&this.currentMode===z.MODE_SNAPSHOT&&("esriGeometryPolyline"===this.geometryType||"esriGeometryPolygon"===this.geometryType||this.hasXYFootprint())&&!this.getMaxAllowableOffset())d=this.generalizeForScale,d=this.maxScale?this.maxScale:this.minScale?Math.min(d,this.minScale):Math.min(d,T.getScale(c,this.initialExtent)),this.isEditable()||this._setMaxOffset(c.extent.getWidth()/c.width/c.getScale()*d,!0);this._zoomConnect=s.connect(c,
"onZoomEnd",this,this._updateMaxOffset)}b&&(a.firstOccurrence?b.startup():b.resume())},_updateMaxOffset:function(){var a=this._map;a&&a.loaded&&this._autoGeneralize&&this._setMaxOffset(a.extent.getWidth()/a.width)},_toggleTime:function(a){var b=this._map;a&&this.timeInfo&&this.useMapTime&&b?(this._mapTimeExtent=b.timeExtent,this._timeConnect||(this._timeConnect=s.connect(b,"onTimeExtentChange",this,this._timeChangeHandler))):(this._mapTimeExtent=null,s.disconnect(this._timeConnect),this._timeConnect=
null)},_timeChangeHandler:function(a){this._mapTimeExtent=a;(a=this._mode)&&a.propertyChangeHandler(0)},_getOffsettedTE:function(a){var b=this._timeOffset,c=this._timeOffsetUnits;return a&&b&&c?a.offset(-1*b,c):a},_getTimeOverlap:function(a,b){return a&&b?a.intersection(b):a||b},_getTimeFilter:function(a){var b=this.getTimeDefinition(),c;if(b&&(c=this._getTimeOverlap(b,null),!c))return[!1];if(a){if(a=c?this._getTimeOverlap(a,c):a,!a)return[!1]}else a=c;return[!0,a]},_getAttributeFilter:function(a){var b=
this.getDefinitionExpression();return a?b?"("+b+") AND ("+a+")":a:b},_applyQueryFilters:function(a,b){a.where=this._getAttributeFilter(a.where);a.maxAllowableOffset=this._maxOffset;a.quantizationParameters=this._quantizationParameters;b&&this.supportsAdvancedQueries&&(a.orderByFields=a.orderByFields||this.getOrderByFields());if(this.timeInfo){var c=this._getTimeFilter(a.timeExtent);if(c[0])a.timeExtent=c[1];else return!1}return!0},_add:function(a){var b=this._selectionSymbol,c=a.attributes,d=this.visibilityField;
b&&this._isSelOnly&&a.setSymbol(b);if(d&&c&&c.hasOwnProperty(d))a[c[d]?"show":"hide"]();return this.add.apply(this,arguments)},_remove:function(){return this.remove.apply(this,arguments)},_canDoClientSideQuery:function(a){var b=[],d=this._map;if(!(this._isTable||!d&&!this._collection))if(!a.text&&!(a.where&&a.where!==this.getDefinitionExpression()||a.orderByFields&&a.orderByFields.length||a.outStatistics||a.returnDistinctValues)){var e=this._isSnapshot,f=this._isSelOnly,g=a.geometry;if(g)if(!f&&a.spatialRelationship===
F.SPATIAL_REL_INTERSECTS&&"extent"===g.type&&(e||d.extent.contains(g)))b.push(1);else return;if(d=a.objectIds)if(e)b.push(2);else{var g=d.length,h=this._mode,k=0,l;for(l=0;l<g;l++)h._getFeature(d[l])&&k++;if(k===g)b.push(2);else return}if(this.timeInfo)if(a=a.timeExtent,d=this._mapTimeExtent,e)a&&b.push(3);else if(f){if(a)return}else if(d)if(-1!==c.indexOf(b,2))a&&b.push(3);else if(-1!==c.indexOf(b,1))a==d&&b.push(3);else return;else if(0<b.length)a&&b.push(3);else if(a)return;return 0<b.length?b:
null}},_getAbsMid:function(a){return k.toAbsMid?k.toAbsMid(a):m.id.replace(/\/[^\/]*$/ig,"/")+a},_doQuery:function(a,b,d){var e=[],f=this._mode,g=this.objectIdField,h=this,k,l,m=new n,q=new n,s=function(a,b){if(!a.length||!b.length)return a.length?a:b;var c,d,e={};a.length>b.length?(d=a,c=b):(d=b,c=a);for(var f=d.length,h=c.length,k;f--;)k=d[f],e[k.attributes[g]]=!0;for(;h--;)k=c[h],e[k.attributes[g]]||d.push(k);return d};if(-1!==c.indexOf(b,1)){l=this.graphics;k=l.length;var r=this.spatialIndex||
this._map&&this._map.spatialIndex,t,v=a.geometry._normalize(null,!0);null==r&&ea.autoSpatialIndexing?t=(this._map||this).addPlugin(this._getAbsMid("../plugins/spatialIndex")).then(p.hitch(this,p.partial(this._getFromIndex,v,r)),function(a){q.resolve(p.hitch(this,p.partial(this._filterByExtent,l,v)))}):r&&(t=this._getFromIndex(v,r));t?t.then(function(a){for(var b=0;b<a.length;b++)a[b].results&&(e=e.concat(a[b].results));q.resolve(e)}).otherwise(function(a){q.reject(a)}):q.resolve(this._filterByExtent(l,
v))}else q.resolve([]);q.then(function(e){var l=[];if(-1!==c.indexOf(b,2)){var n=a.objectIds;for(k=n.length;k--;){var p=f._getFeature(n[k]);p&&l.push(p)}l=s(e,l)}else l=e;-1!==c.indexOf(b,3)&&h.timeInfo&&(e=a.timeExtent,l=h._filterByTime(0<l.length?l:h.graphics,e.startTime,e.endTime).match);d&&(l=c.map(l,function(a){return a.attributes[g]},this));m.resolve(l)});return m},_getFromIndex:function(a,b){b=b||this.spatialIndex||this._map.spatialIndex;a instanceof Array||(a=[a]);var d=this.id;return v(c.map(a,
function(a){return b.intersects(a,d)}))},_filterByExtent:function(a,b){for(var c=[],d=0,e=a.length;d<e;d++){var f=a[d],g=f.geometry;g&&(this.normalization&&b.length?(b[0].intersects(g)||b[1].intersects(g))&&c.push(f):b.intersects(g)&&c.push(f))}return c},_filterByTime:function(a,b,c){var d=this._startTimeField,e=this._endTimeField,f;this._twoTimeFields||(f=d||e);var g=h.isDefined,k=[],l=[],m,n=a.length,p,q;b=b?b.getTime():-Infinity;c=c?c.getTime():Infinity;if(f)for(m=0;m<n;m++)p=a[m],q=p.attributes,
d=q[f],d>=b&&d<=c?k.push(p):l.push(p);else for(m=0;m<n;m++)p=a[m],q=p.attributes,f=q[d],q=q[e],f=g(f)?f:-Infinity,q=g(q)?q:Infinity,f>=b&&f<=c||q>=b&&q<=c||b>=f&&c<=q?k.push(p):l.push(p);return{match:k,noMatch:l}},_resolve:function(a,b,c,d,e){b&&this[b].apply(this,a);c&&c.apply(null,a);d&&w._resDfd(d,a,e)},_getShallowClone:function(a){var b=new F,c;for(c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},_query:function(a,b,c,d,e){var f=this,g=this._map,h=new n(w._dfdCanceller),k=c,m=function(c,e){if(!e&&
("execute"===a||"executeRelationshipQuery"===a)){var g,k;if("execute"===a){g=c.features;k=g.length;for(k-=1;0<=k;k--)if(g[k]._layer=f,!f._isTable){var l=f._mode._getFeature(g[k].attributes[f.objectIdField]);l&&g.splice(k,1,l)}}else for(l in c)if(c.hasOwnProperty(l)){g=c[l].features;k=g.length;for(k-=1;0<=k;k--)g[k]._layer=f}}f._resolve([c],b,d,h)};if("executeRelationshipQuery"!==a){k=this._getShallowClone(c);k.outFields=this.getOutFields();k.returnGeometry=c.hasOwnProperty("returnGeometry")?c.returnGeometry:
!c.outStatistics;k.returnGeometry&&(k.multipatchOption=this.multipatchOption);var p;g&&(k.outSpatialReference=new E(g.spatialReference.toJson()));if(!this._applyQueryFilters(k,"execute"===a&&!k.outStatistics)){switch(a){case "execute":p=new G({features:[]});break;case "executeForIds":p=[];break;case "executeForCount":p=0;break;case "executeForExtent":p={}}m(p,!0);return h}if(c="executeForExtent"!==a&&this._canDoClientSideQuery(k))return h._pendingDfd=l(this._doQuery(k,c,"executeForIds"===a||"executeForCount"===
a)),h._pendingDfd.then(function(b){switch(a){case "execute":p=new G;p.features=b;break;case "executeForIds":p=b;break;case "executeForCount":p=b.length}m(p,!0)}),h}if(this._collection)return this._resolve([Error("FeatureLayer::_query - "+this.invalidParams)],null,e,h,!0),h;this._ts&&(k._ts=(new Date).getTime());(h._pendingDfd=this._task[a](k)).addCallbacks(function(a){m(a,!!k.outStatistics)},function(a){f._resolve([a],null,e,h,!0)});return h},_convertFeaturesToJson:function(a,b,d,e){var f=[],g=this._selectionSymbol,
h=this.visibilityField,k,l=this.objectIdField;if(this.loaded&&(d||e))k=c.filter(this.fields,function(a){return!1===a.editable&&(!e||a.name!==l)});for(d=0;d<a.length;d++){var m=a[d],n={},q=m.geometry,s=m.attributes,r=m.symbol;if(q&&(!e||!this.loaded||this.allowGeometryUpdates))n.geometry=q.toJson();h?(n.attributes=s=p.mixin({},s),s[h]=m.visible?1:0):s&&(n.attributes=p.mixin({},s));n.attributes&&(k&&k.length)&&c.forEach(k,function(a){delete n.attributes[a.name]});r&&r!==g&&(n.symbol=r.toJson());f.push(n)}return b?
f:t.toJson(f)},_selectHandler:function(a,b,c,d,e){var f;d=z;switch(b){case d.SELECTION_NEW:this.clearSelection(!0);f=!0;break;case d.SELECTION_ADD:f=!0;break;case d.SELECTION_SUBTRACT:f=!1}d=a.features;var g=this._mode,h=[],k=this.objectIdField,l,m;if(f)for(f=0;f<d.length;f++)l=d[f],m=l.attributes[k],l=g._addFeatureIIf(m,l),h.push(l),this._selectFeatureIIf(m,l,g);else for(f=0;f<d.length;f++)l=d[f],m=l.attributes[k],this._unSelectFeatureIIf(m,g),m=g._removeFeatureIIf(m),h.push(m||l);this._isSelOnly&&
g._applyTimeFilter(!0);this._resolve([h,b,a.exceededTransferLimit?{queryLimitExceeded:!0}:null],"onSelectionComplete",c,e);if(a.exceededTransferLimit)this.onQueryLimitExceeded()},_selectFeatureIIf:function(a,b,c){var d=this._selectedFeatures,e=d[a];e||(c._incRefCount(a),d[a]=b,this._isTable||(this._setSelectSymbol(b),b.attr("data-selected","")));return e||b},_unSelectFeatureIIf:function(a,b){var c=this._selectedFeatures[a];c&&(b._decRefCount(a),delete this._selectedFeatures[a],this._isTable||(this._setUnSelectSymbol(c),
c.attr("data-selected")));return c},_isSelected:function(a){},_setSelectSymbol:function(a){var b=this._selectionSymbol;b&&!this._isSelOnly&&a.setSymbol(b)},_setUnSelectSymbol:function(a){var b=this._selectionSymbol;b&&!this._isSelOnly&&b===a.symbol&&a.setSymbol(null,!0)},_getOutFields:function(){var a=[this.objectIdField,this.typeIdField,this.creatorField,this._startTimeField,this._endTimeField,this._trackIdField].concat(this._rendererFields).concat(this.dataAttributes),a=c.filter(a,function(a,b,
d){return!!a&&c.indexOf(d,a)===b}),b=p.clone(this._outFields);if(b){if(-1!==c.indexOf(b,"*"))return b;c.forEach(a,function(a){-1===c.indexOf(b,a)&&b.push(a)});return b}return a},_checkFields:function(a){var b=a||this._getOutFields();c.forEach(b,function(a){"*"!==a&&(this._getField(a)||console.debug("esri.layers.FeatureLayer: "+h.substitute({url:this.url,field:a},"unable to find '${field}' field in the layer 'fields' information [url: ${url}]")))},this);!a&&(!this._isTable&&!this._fserver&&!this._collection&&
!this._isStream)&&(c.some(this.fields,function(a){return a&&"esriFieldTypeGeometry"===a.type?!0:!1})||console.debug("esri.layers.FeatureLayer: "+h.substitute({url:this.url},"unable to find a field of type 'esriFieldTypeGeometry' in the layer 'fields' information. If you are using a map service layer, features will not have geometry [url: ${url}]")))},_fixFieldCase:function(a,b,c){var d=a&&a[b],e;if(d&&!p.isFunction(d)){if(e=!this._getField(d)&&this._getField(d,!0))d=a[b]=e.name;c&&c.push(d)}return d},
_fixRendererFields:function(){var a=this.renderer;this._orderBy=null;if(a&&0<this.fields.length){var b=[],d,a=c.filter([a,a.observationRenderer,a.latestObservationRenderer,a.trackRenderer],h.isDefined),e=[].concat(a);c.forEach(a,function(a){c.forEach(a.rendererInfos,function(a){a.renderer&&e.push(a.renderer)})});c.forEach(e,function(a){this._fixFieldCase(a,"attributeField",b);this._fixFieldCase(a,"attributeField2",b);this._fixFieldCase(a,"attributeField3",b);this._fixFieldCase(a.rotationInfo,"field",
b);if((d=this._fixFieldCase(a.sizeInfo,"field",b))&&!this._orderBy)this._orderBy=[d+" DESC"];this._fixFieldCase(a.sizeInfo,"normalizationField",b);this._fixFieldCase(a.colorInfo,"field",b);this._fixFieldCase(a.colorInfo,"normalizationField",b);this._fixFieldCase(a.field,"field",b);this._fixFieldCase(a.opacityInfo,"field",b);this._fixFieldCase(a.opacityInfo,"normalizationField",b);c.forEach(a.visualVariables,function(a){d=this._fixFieldCase(a,"field",b);"sizeInfo"===a.type&&(d&&!this._orderBy)&&(this._orderBy=
[d+" DESC"]);this._fixFieldCase(a,"normalizationField",b)},this);if(!this._orderBy&&a.addBreak&&!p.isFunction(a.attributeField)&&(a.backgroundFillSymbol||this._hasSizeDiff(a)))this._orderBy=[a.attributeField+" DESC"]},this);this._rendererFields=c.filter(b,h.isDefined)}},_hasSizeDiff:function(a){var b=Number.MAX_VALUE,d=-Number.MAX_VALUE,e,f;c.forEach(a.infos,function(a){if(f=a.symbol){e=0;switch(f.type){case "simplemarkersymbol":e=f.size;break;case "picturemarkersymbol":e=(f.width+f.height)/2;break;
case "simplelinesymbol":case "cartographiclinesymbol":e=f.width;break;case "simplefillsymbol":case "picturefillsymbol":e=f.outline&&f.outline.width}e&&(b=Math.min(b,e),d=Math.max(d,e))}});return b!==Number.MAX_VALUE&&d!==-Number.MAX_VALUE&&1<Math.abs(d-b)},getOrderByFields:function(){var a=this.orderByFields||this._orderBy;return this.supportsAdvancedQueries&&a?c.filter(a,function(a){a=a.split(" ")[0];return!!this._getField(a,!0)},this):null},_getField:function(a,b){var d=this.fields;if(!d||0===d.length)return null;
var e;b&&(a=a.toLowerCase());c.some(d,function(c){var d=!1;(d=b?c&&c.name.toLowerCase()===a?!0:!1:c&&c.name===a?!0:!1)&&(e=c);return d});return e},_getDateOpts:function(){this._dtOpts||(this._dtOpts={properties:c.map(c.filter(this.fields,function(a){return!!(a&&"esriFieldTypeDate"===a.type)}),function(a){return a.name})});return this._dtOpts},_applyNormalized:function(a,b){a&&b&&c.forEach(a,function(a,c){a&&b[c]&&a.setGeometry(b[c])})},_editHandler:function(a,b,d,e,f,g){f=a.addResults;var h=a.updateResults;
a=a.deleteResults;var k,l,m,n,p=this.objectIdField,q=this._mode,s=this._isTable;k=this.editFieldsInfo;var r=this.getOutFields()||[],t=k&&k.creatorField,v=k&&k.creationDateField,w=k&&k.editorField,x=k&&k.editDateField;k=k&&k.realm;-1===c.indexOf(r,"*")&&(t&&-1===c.indexOf(r,t)&&(t=null),v&&-1===c.indexOf(r,v)&&(v=null),w&&-1===c.indexOf(r,w)&&(w=null),x&&-1===c.indexOf(r,x)&&(x=null));var r=v||x?(new Date).getTime():null,y=t||w?this.getUserId():void 0;y&&k&&(y=y+"@"+k);if(f)for(k=0;k<f.length;k++)f[k]=
new C(f[k]),s||(l=f[k],l.success&&(l=l.objectId,m=b[k],(n=m._graphicsLayer)&&n!==this&&n.remove(m),n=m.attributes||{},n[p]=l,t&&(n[t]=y),w&&(n[w]=y),v&&(n[v]=r),x&&(n[x]=r),m.setAttributes(n),q._init&&q.drawFeature(m)));if(h)for(k=0;k<h.length;k++)if(h[k]=new C(h[k]),!s&&(l=h[k],l.success)){l=l.objectId;m=d[l];if(b=q._getFeature(l))b.geometry!==m.geometry&&b.setGeometry(R.fromJson(m.geometry.toJson())),this._repaint(b,l);m=b||m;n=m.attributes||{};w&&(n[w]=y);x&&(n[x]=r);m.setAttributes(n)}if(a){d=
[];for(k=0;k<a.length;k++)if(a[k]=new C(a[k]),!s&&(l=a[k],l.success&&(l=l.objectId,m=q._getFeature(l))))this._unSelectFeatureIIf(l,q)&&d.push(m),m._count=0,q._removeFeatureIIf(l);if(0<d.length)this.onSelectionComplete(d,z.SELECTION_SUBTRACT)}this._resolve([f,h,a],"onEditsComplete",e,g)},_sendAttachment:function(a,b,c,d,e){var f=this;return r({url:this._url.path+"/"+b+"/"+("add"===a?"addAttachment":"updateAttachment"),form:c,content:p.mixin(this._url.query,{f:"json",token:this._getToken()||void 0}),
callbackParamName:"callback.html",handleAs:"json"}).addCallback(function(c){var e="add"===a?"onAddAttachmentComplete":"onUpdateAttachmentComplete";c=new C(c["add"===a?"addAttachmentResult":"updateAttachmentResult"]);c.attachmentId=c.objectId;c.objectId=b;f._resolve([c],e,d);return c}).addErrback(function(a){f._resolve([a],null,e,null,!0)})},_repaint:function(a,b,c){b=h.isDefined(b)?b:a.attributes[this.objectIdField];(!(b in this._selectedFeatures)||!this._selectionSymbol)&&a.setSymbol(a.symbol,c)},
_getKind:function(a){var b=this._trackManager;return b?b.isLatestObservation(a)?1:0:0}});p.mixin(z,{MODE_SNAPSHOT:0,MODE_ONDEMAND:1,MODE_SELECTION:2,SELECTION_NEW:3,SELECTION_ADD:4,SELECTION_SUBTRACT:5,MODE_AUTO:6,MODE_STREAM:7,POPUP_NONE:"esriServerHTMLPopupTypeNone",POPUP_HTML_TEXT:"esriServerHTMLPopupTypeAsHTMLText",POPUP_URL:"esriServerHTMLPopupTypeAsURL"});S._createWrappers(z);f("extend-esri")&&p.setObject("layers.FeatureLayer",z,e);return z});