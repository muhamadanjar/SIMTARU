// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.12/esri/copyright.txt for details.
//>>built
require({cache:{"esri/layers/OnDemandMode":function(){define("dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/has ../kernel ../geometry/Point ../tasks/query ./RenderMode ./GridLayout".split(" "),function(r,m,k,u,s,e,w,n,b,g){r=r([b],{declaredClass:"esri.layers._OnDemandMode",constructor:function(d){this.featureLayer=d;this._featureMap={};this._queryErrorHandler=k.hitch(this,this._queryErrorHandler)},initialize:function(d){this.inherited(arguments);var f=this.featureLayer,
c=f._srInfo;this._gridLayer=new g(new w(c?c.valid[0]:d.extent.xmin,d.extent.ymax,d.spatialReference),{width:f._tileWidth,height:f._tileHeight},{width:d.width,height:d.height},c);this._cellMap={};this._gridLayer.setResolution(d.extent)},startup:function(){this._ioQueue=[];this.featureLayer.suspended||(this._zoomHandler(),this._enableConnectors())},propertyChangeHandler:function(d){this._init&&(2>d?this._zoomHandler():console.log("FeatureLayer: layer in on-demand mode does not support time definitions. Layer id \x3d "+
this.featureLayer.id+", Layer URL \x3d "+this.featureLayer.url))},destroy:function(){this._disableConnectors();this.inherited(arguments)},drawFeature:function(d){var f=this._gridLayer,c=d.geometry,b=[];if(c)for(var b=f.getCellsInExtent("point"===c.type?{xmin:c.x,ymin:c.y,xmax:c.x,ymax:c.y}:c.getExtent(),!1).cells,f=this._cellMap,h,a=d.attributes[this.featureLayer.objectIdField],q,l,v,c=0;c<b.length;c++)h=b[c],q=h.latticeID,l=h.row,v=h.col,q?h=f[q]=f[q]||h:(f[l]=f[l]||{},h=f[l][v]=f[l][v]||h),h.features=
h.features||[],h.features.push(d),this._addFeatureIIf(a,d),this._incRefCount(a)},suspend:function(){this._init&&this._disableConnectors()},resume:function(){this._init&&(this._enableConnectors(),this._zoomHandler())},refresh:function(){this._zoomHandler()},_enableConnectors:function(){var d=this.map;this._zoomConnect=m.connect(d,"onZoomEnd",this,this._zoomHandler);this._panConnect=m.connect(d,"onPanEnd",this,this._panHandler);this._resizeConnect=m.connect(d,"onResize",this,this._panHandler)},_disableConnectors:function(){m.disconnect(this._zoomConnect);
m.disconnect(this._panConnect);m.disconnect(this._resizeConnect)},_zoomHandler:function(){this._processIOQueue(!0);var d=this.featureLayer,f=this.map;d.suspended||(d._fireUpdateStart(),this._clearIIf(),(d=d._trackManager)&&d.clearTracks(),this._cellMap={},this._gridLayer.setResolution(f.extent),this._sendRequest())},_panHandler:function(d){this.featureLayer._fireUpdateStart();this._sendRequest(this.featureLayer._resized&&d)},_getRequestId:function(d,f){return("_"+d.name+d.layerId+d._ulid+"_"+f.resolution+
"_"+(f.latticeID||f.row+"_"+f.col)).replace(/[^a-zA-Z0-9\_]+/g,"_")},_sendRequest:function(d){this._exceeds=!1;var f=this.featureLayer,c=this.map;d=d||c.extent;c=this._gridLayer.getCellsInExtent(d,f.latticeTiling).cells;if(!f.isEditable())var b=this._cellMap,c=u.filter(c,function(a){if(a.lattice){if(b[a.latticeID])return!1}else if(b[a.row]&&b[a.row][a.col])return!1;return!0});var h=f.getOutFields(),a=f.getDefinitionExpression(),q=f._getOffsettedTE(f._mapTimeExtent),l=f.supportsAdvancedQueries?f.getOrderByFields():
null,v=f._usePatch,t=this._ioQueue,y,p=this,z=this._drawFeatures,g,e,k;this._pending=this._pending||0;for(y=0;y<c.length;y++){g=c[y];e=new n;e.geometry=g.extent||g.lattice;e.outFields=h;e.where=a;f.latticeTiling&&g.extent&&(e.spatialRelationship=n.SPATIAL_REL_CONTAINS);e.returnGeometry=!0;e.timeExtent=q;f._ts&&(e._ts=(new Date).getTime());e.orderByFields=l;e.multipatchOption=f.multipatchOption;e.maxAllowableOffset=f._maxOffset;e.quantizationParameters=f._quantizationParameters;k=null;if(v&&(k=this._getRequestId(f,
g),this._isPending(k)))continue;this._pending++;t.push(f._task.execute(e,function(){var a=g;return function(q){z.apply(p,[q,a])}}.call(this),this._queryErrorHandler,k))}this._removeOldCells(d);this._endCheck()},_drawFeatures:function(d,f){this._exceeds=this._exceeds||d.exceededTransferLimit;this._finalizeIO();var c=this.map.extent,b=f.extent,h=f.row,a=f.col,q=this.featureLayer.objectIdField,l=d.features,v=this._gridLayer,t=this._cellMap,y=f.latticeID,p=y?t[y]:t[h]&&t[h][a];if(f.resolution!=v._resolution||
(y?y!==v.getLatticeID(c):!v.intersects(b,c)))p&&this._removeCell(h,a,y);else if(p)this._updateCell(p,l);else{f.features=l;y?t[y]=f:(t[h]=t[h]||{},t[h][a]=f);b=l.length;for(c=0;c<b;c++)h=l[c],a=h.attributes[q],this._addFeatureIIf(a,h),this._incRefCount(a)}this._endCheck()},_queryErrorHandler:function(d){this._finalizeIO();this.featureLayer._errorHandler(d);this._endCheck(!0)},_finalizeIO:function(){this._purgeRequests();this._pending--},_endCheck:function(d){if(0===this._pending){this._processIOQueue();
var f=this.featureLayer,c=f._trackManager;c&&(c.clearTracks(),c.addFeatures(f.graphics),f._ager&&u.forEach(f.graphics,function(d){d._shape&&f._repaint(d)}),c.moveLatestToFront(),c.drawTracks());this.featureLayer._fireUpdateEnd(d&&Error("FeatureLayer: an error occurred while updating the layer"),this._exceeds?{queryLimitExceeded:!0}:null);if(this._exceeds)f.onQueryLimitExceeded()}},_processIOQueue:function(d){this._ioQueue=u.filter(this._ioQueue,function(d){return-1<d.fired?!1:!0});d&&u.forEach(this._ioQueue,
this._cancelPendingRequest)},_removeOldCells:function(d){var f=this._cellMap,c=this._gridLayer,b,h;for(b in f)if(f[b]){var a=f[b],q=a.latticeID,l=0,v=0;if(q)l++,q!==c.getLatticeID(d)&&(this._removeCell(null,null,q),v++);else for(h in a)a[h]&&(l++,c.intersects(a[h].extent,d)||(this._removeCell(b,h),v++));v===l&&delete f[b]}},_updateCell:function(d,f){var c=this.featureLayer,b=c.objectIdField,c=c._selectedFeatures,h,a=f.length;d.features=d.features||[];for(h=0;h<a;h++){var q=f[h],l=q.attributes[b],
v=this._addFeatureIIf(l,q);v===q?(this._incRefCount(l),d.features.push(v)):l in c||(v.setGeometry(q.geometry),v.setAttributes(q.attributes))}},_removeCell:function(d,f,c){var b=this._cellMap,h=this.featureLayer,a=h.objectIdField,q=c?b[c]:b[d]&&b[d][f];if(q){c?delete b[c]:delete b[d][f];d=q.features;for(f=0;f<d.length;f++)c=d[f].attributes[a],this._decRefCount(c),c in h._selectedFeatures||this._removeFeatureIIf(c)}}});s("extend-esri")&&k.setObject("layers._OnDemandMode",r,e);return r})},"esri/dijit/_EventedWidget":function(){define("dojo/_base/declare dojo/_base/lang dojo/aspect dojo/on ../Evented dijit/_WidgetBase".split(" "),
function(r,m,k,u,s,e){return r([e,s],{_onMap:function(e){var n=this.constructor._onMap,b;if(!n||!n.FINAL)delete this.constructor._onMap,n=this.registerConnectEvents(),n.FINAL=!0;e=e.toLowerCase();n[e]?b=this[n[e].method]:(e=this._onCamelCase(e),this[e]&&(b=e));return b},on:function(e,n){var b=this._onMap(e),g=e.replace(/\-/g,""),d="on"+g in this.domNode;return b||!d?this.inherited(arguments):this.own(u(this.domNode,g,n))[0]},emit:function(e,n,b){var g,d,f,c=e.toLowerCase(),k=this.constructor._onMap||
this.registerConnectEvents();d=this[this._onMap(c)];n=n||{};n.target||(n.target=this);d&&(k&&k[c])&&(this._onObj2Arr(function(){g=Array.prototype.slice.call(arguments)},k[c].argKeys)(n),f=m.mixin({},arguments),f[2]=g,f[0]=k[c].name.replace(/^on/,""));return this.inherited(f||arguments)}})})},"esri/layers/HeatmapManager":function(){define("dojo/_base/declare dojo/_base/lang dojo/on dojo/aspect dojo/_base/array require ../kernel ../sniff ../geometry/Point ./MapImageLayer ./MapImage ./FeatureLayer ../renderers/HeatmapRenderer ../tasks/query".split(" "),
function(r,m,k,u,s,e,w,n,b,g,d,f,c,x){function h(){}function a(a){var l=a.layer;return{geometry:a.geometry,attributes:a.attributes,getLayer:function(){return l}}}r=r(null,{declaredClass:"esri.layers.HeatmapManager",heatmapRenderer:null,sourceLayer:null,imageLayer:null,useTiles:!0,useWorker:!1,map:null,constructor:function(a){this.sourceLayer=a;this._hndls=[]},initialize:function(a){this.map=a;var l=this.sourceLayer,d=l.renderer;l.setDrawMode(!1);var l=this.imageLayer=new g({className:"heatmapImgLyr"}),
t=this;this.heatmapRenderer=d instanceof c?d:(d.getRendererInfoByZoom(a.getZoom())||d.getRendererInfoByScale(a.getScale())).renderer;this.recalculateHeatmap=this.recalculateHeatmap.bind(this);this._removeRenderer=this._removeRenderer.bind(this);this._handleRendererChange=this._handleRendererChange.bind(this);this._rendererChangeHandle=this.sourceLayer.on("renderer-change",this._handleRendererChange);a.addLayer(l);e(["../workers/heatmapCalculator"],function(a){t._calculator=new a(m.mixin({width:t.map.width,
height:t.map.height},t._getOptions()));t._setupRenderer();t.heatmapRenderer.getStats=function(a){return t._calculator.calculateStats(a||1)};t.heatmapRenderer.getHistogramData=function(a,q){return t._calculator.getHistogramData(a,q)}})},destroy:function(){this._removeHandlers();this.map.removeLayer(this.imageLayer);this._rendererChangeHandle.remove();this._rendererChangeHandle=this.sourceLayer=this.imageLayer=this.map=this.heatmapRenderer=this._hndls=null},_handleRendererChange:function(a){var l=a.renderer,
d=l instanceof c;this.heatmapRenderer?d?this.heatmapRenderer=l:this._removeRenderer(a):d&&(this.heatmapRenderer=l,this.sourceLayer&&this.map&&this._setupRenderer())},_setupRenderer:function(){var a=this._hndls,l=this.sourceLayer,d=this.map,t=this;l._originalDraw=l._draw;l._draw=h;l._div.clear();setTimeout(this._resetGraphics.bind(this),250);a.push(l.on("update-end",function(a){t.recalculateHeatmap()}));a.push(l.on("suspend",function(a){t.imageLayer.suspend()}));a.push(l.on("resume",function(a){t.imageLayer.resume()}));
a.push(u.after(l,"redraw",this.recalculateHeatmap));a.push(d.on("layer-remove",function(a){a.layer==l&&(d.removeLayer(t.imageLayer),t._removeRenderer({target:l}))}));l.mode!==f.MODE_ONDEMAND&&(a.push(d.on("resize, pan-end",function(a){setTimeout(t.recalculateHeatmap,16)})),a.push(d.on("zoom-end",function(a){setTimeout(function(){l._getRenderer().isInstanceOf(c)&&t.recalculateHeatmap()},16)})));this.imageLayer.suspended&&this.imageLayer.resume();l.graphics&&l.graphics.length&&this.recalculateHeatmap()},
_removeRenderer:function(a){var l=a.target;l._draw=l._originalDraw;delete l._originalDraw;l.setDrawMode(!0);this._removeHandlers();this._hndls=[];l.renderer!=a.renderer&&l.renderer.getRendererInfo?(this.heatmapRenderer=null,this.imageLayer.suspend()):(l.redraw(),this.destroy())},recalculateHeatmap:function(){this._calculator?this._doMainCalculation():this._calculatorClient&&this._doWorkerCalculation()},_doWorkerCalculation:function(){},_doMainCalculation:function(){var q=this.sourceLayer,l=this.imageLayer,
c=this.map,t=this.heatmapRenderer,f=this.map.extent,p=this.map.width,b=this.map.height,h=this._calculator,g=this,e=function(e){e=g._getScreenPoints(e.features,c,q);e=h.calculateImageData(m.mixin({screenPoints:e,mapinfo:{extent:[f.xmin,f.ymin,f.xmax,f.ymax],resolution:c.getResolution()},width:p,height:b},g._getOptions()));e=t.getSymbol(a({geometry:c.extent,attributes:{size:[p,b],imageData:e},layer:q}));e=new d({extent:c.extent,href:e.url});l.addImage(e);setTimeout(function(){var a=l._mapImages.slice(0,
-1),q=a.length;if(1E3<q)a=l._mapImages[q],l.removeAllImages(),l.addImage(a);else for(;q--&&a[q];)l.removeImage(a[q])},250)},n={geometry:c.extent,timeExtent:c.timeExtent,spatialRelationship:x.SPATIAL_REL_INTERSECTS};null!=q._canDoClientSideQuery(n)?q.queryFeatures(n,e):e({features:q.graphics})},_getScreenPoints:function(a,l,d){var c=[],f=a.length,p=0,h=0,g,e=new b(l.extent.xmin,l.extent.ymax,l.spatialReference),n=l.toScreen(e),k=n.x,n=n.y,m=l.getResolution(),x;for(l.extent._parts&&(x=s.map(l.extent._parts,
function(a){return d._intersects(l,a.extent)[0]}));f--;)h=a[f],h.geometry&&(g={x:Math.ceil((h.geometry.x-e.x)/m+k),y:Math.floor((e.y-h.geometry.y)/m-n),attributes:h.attributes},x&&(h=1<x.length&&g.x<-x[0]?x[1]:x[0],g.x+=h),c[p++]=g);return c},_removeHandlers:function(){for(var a=this._hndls.length;a--;)this._hndls[a].remove()},_getOptions:function(){var a=this.heatmapRenderer;return{blurRadius:a.blurRadius,gradient:a.gradient,maxPixelIntensity:a.maxPixelIntensity,minPixelIntensity:a.minPixelIntensity,
field:a.field}},_resetGraphics:function(){for(var a=this.sourceLayer.graphics,l=a.length,d;l--;)d=a[l],d._shape=d._offsets=void 0}});n("extend-esri")&&m.setObject("layers.HeatmapManager",r,w);return r})},"dijit/a11y":function(){define("dojo/_base/array dojo/dom dojo/dom-attr dojo/dom-style dojo/_base/lang dojo/sniff ./main".split(" "),function(r,m,k,u,s,e,w){var n={_isElementShown:function(b){var g=u.get(b);return"hidden"!=g.visibility&&"collapsed"!=g.visibility&&"none"!=g.display&&"hidden"!=k.get(b,
"type")},hasDefaultTabStop:function(b){switch(b.nodeName.toLowerCase()){case "a":return k.has(b,"href");case "area":case "button":case "input":case "object":case "select":case "textarea":return!0;case "iframe":var g;try{var d=b.contentDocument;if("designMode"in d&&"on"==d.designMode)return!0;g=d.body}catch(f){try{g=b.contentWindow.document.body}catch(c){return!1}}return g&&("true"==g.contentEditable||g.firstChild&&"true"==g.firstChild.contentEditable);default:return"true"==b.contentEditable}},effectiveTabIndex:function(b){return k.get(b,
"disabled")?void 0:k.has(b,"tabIndex")?+k.get(b,"tabIndex"):n.hasDefaultTabStop(b)?0:void 0},isTabNavigable:function(b){return 0<=n.effectiveTabIndex(b)},isFocusable:function(b){return-1<=n.effectiveTabIndex(b)},_getTabNavigable:function(b){function g(a){return a&&"input"==a.tagName.toLowerCase()&&a.type&&"radio"==a.type.toLowerCase()&&a.name&&a.name.toLowerCase()}var d,f,c,m,h,a,q={},l=n._isElementShown,v=n.effectiveTabIndex,t=function(b){for(b=b.firstChild;b;b=b.nextSibling)if(!(1!=b.nodeType||
9>=e("ie")&&"HTML"!==b.scopeName||!l(b))){var p=v(b);if(0<=p){if(0==p)d||(d=b),f=b;else if(0<p){if(!c||p<m)m=p,c=b;if(!h||p>=a)a=p,h=b}p=g(b);k.get(b,"checked")&&p&&(q[p]=b)}"SELECT"!=b.nodeName.toUpperCase()&&t(b)}};l(b)&&t(b);return{first:q[g(d)]||d,last:q[g(f)]||f,lowest:q[g(c)]||c,highest:q[g(h)]||h}},getFirstInTabbingOrder:function(b,g){var d=n._getTabNavigable(m.byId(b,g));return d.lowest?d.lowest:d.first},getLastInTabbingOrder:function(b,g){var d=n._getTabNavigable(m.byId(b,g));return d.last?
d.last:d.highest}};s.mixin(w,n);return n})},"esri/layers/StreamMode":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../SpatialReference ../tasks/query ../tasks/QueryTask ../geometry/jsonUtils ./RenderMode".split(" "),function(r,m,k,u,s,e,w,n,b,g){r=r([g],{declaredClass:"esri.layers._StreamMode",constructor:function(d,b){this.featureLayer=d;this._featureMap={};this._setRefreshRate();this._drawBuffer={adds:[],updates:[]};this._timeoutId=null;this._flushDrawBuffer=
m.hitch(this,this._flushDrawBuffer);this._featuresByTime={};this._lastEndTimeCheck=null;this._drawFeatures=m.hitch(this,this._drawFeatures);this._queryErrorHandler=m.hitch(this,this._queryErrorHandler)},startup:function(){},propertyChangeHandler:function(d){this._init&&(0===d?this._applyTimeFilter():3===d?this._redrawAllTracks():console.debug("StreamLayer: Stream Layer only supports changing map time or maximumTrackPoints. Layer id \x3d "+this.featureLayer.id))},drawFeature:function(d){var b=this.featureLayer,
c=b.objectIdField;this._timeoutId||(this._timeoutId=setTimeout(this._flushDrawBuffer,this._refreshRate));b._joinField&&this._getFeature(d.attributes[c])?this._drawBuffer.updates.push({oid:d.attributes[c],updates:d}):this._drawBuffer.adds.push(d)},resume:function(){this.propertyChangeHandler(0)},refresh:function(){var d=this.featureLayer;d&&(d._fireUpdateStart(),this._flushDrawBuffer())},_drawFeatures:function(d){this._purgeRequests();var b=this.featureLayer;b._create(d.features||[]);b._fireUpdateEnd(null,
null)},_applyTimeFilter:function(d){this.inherited(arguments);this._redrawAllTracks()},_removeFeatures:function(d){var b=this.featureLayer,c=b.objectIdField;d&&k.forEach(d,function(d){d=d.attributes[c];b._unSelectFeatureIIf(d,this);this._decRefCount(d);this._removeFeatureIIf(d)},this)},_addFeatures:function(d){var b=this.featureLayer,c=b._endTimeField,g,h,a,q=[],l=[],v=[];g=b._trackManager;h=b.objectIdField;if(g)for(a in d=g.addFeatures(d),d)d.hasOwnProperty(a)&&(q.push(a),d[a].adds&&(l=l.concat(d[a].adds)),
d[a].deletes&&(v=v.concat(d[a].deletes)));else l=d;k.forEach(l,function(a){var q=a.attributes[h],l;if(l=c&&a.attributes[c])l=1E3*Math.ceil(l/1E3),this._featuresByTime[l]?this._featuresByTime[l].push(q):this._featuresByTime[l]=[q];this._addFeatureIIf(q,a);this._incRefCount(q)},this);v.length&&this._removeFeatures(v);g&&g.refreshTracks(q)},_updateFeatures:function(d){var b=this.featureLayer,c,g,h=[];c=b._trackManager;g=b._trackIdField;k.forEach(d,function(a){var q=a.updates;a=this._getFeature(a.oid);
var l;if(a){q.geometry&&a.setGeometry(q.geometry);q=q.attributes||{};for(l in q)q.hasOwnProperty(l)&&(a.attributes[l]=q[l]);a.visible=this._checkFeatureTimeIntersects(a);c&&a.attributes[g]?h.push(a.attributes[g]):b._repaint(a,null,!0)}},this);h.length&&c.refreshTracks(h)},_redrawAllTracks:function(){var d=this.featureLayer._trackManager,b;if(d&&(b=d.trimTracks())&&0<b.length)this._removeFeatures(b),d.refreshTracks()},_flushDrawBuffer:function(){clearTimeout(this._timeoutId);var d=this._drawBuffer,
b=d.adds.splice(0,d.adds.length),c=d.updates.splice(0,d.updates.length),d=this.featureLayer;if(!d)return!1;d.updating||d._fireUpdateStart();this._addFeatures(b);this._updateFeatures(c);if((b=this._getExpiredFeatures())&&b.length)this._removeFeatures(b),d._trackManager&&d._trackManager.removeFeatures(b);d._purge();d._fireUpdateEnd();this._timeoutId=null},_clearDrawBuffer:function(){var b=this._timeoutId,f=this._drawBuffer,c=f.adds,f=f.updates;b&&clearTimeout(b);c.splice(0,c.length);f.splice(0,f.length);
this._timeoutId=null},_setRefreshRate:function(b){b=b||0===b?b:200;0>b&&(b=200);this._refreshRate=b},_checkFeatureTimeIntersects:function(b){var f=this.featureLayer,c=f.getMap().timeExtent;return!c||!f.timeInfo||!f.timeInfo.startTimeField&&!f.timeInfo.endTimeField?!0:0<f._filterByTime([b],c.startTime,c.endTime).match.length},_getRequestId:function(b){return("_"+b.name+b.layerId+b._ulid).replace(/[^a-zA-Z0-9\_]+/g,"_")},_fetchArchive:function(d){var f=this.featureLayer,c,g,h,a,q,l;f._fireUpdateStart();
if(d)d=new n(d),c=new w,g=this.map,h=f.getFilter()||{},a=h.where||"1\x3d1",q=h.geometry?b.fromJson(h.geometry):null,h=h.outFields?h.outFields.split(","):["*"],c.geometry=q,c.where=a,c.outFields=h,c.returnGeometry=!0,c.outSpatialReference=new e(g.spatialReference.toJson()),f._usePatch&&(l=this._getRequestId(f),this._cancelPendingRequest(null,l)),d.execute(c,this._drawFeatures,this._queryErrorHandler,l);else return this._fireUpdateEnd({error:"No url provided"}),!1},_queryErrorHandler:function(b){this._purgeRequests();
var g=this.featureLayer;g._errorHandler(b);g._fireUpdateEnd(b)},_getExpiredFeatures:function(){var b,g,c,e=[],h=[];if(!this.featureLayer._endTimeField)return h;b=1E3*Math.floor(this._lastEndTimeCheck/1E3);this._lastEndTimeCheck=g=1E3*Math.ceil(Date.now()/1E3);if(b&&b!==g)for(c=this._featuresByTime;b<=g;b+=1E3)c[b]&&(e=e.concat(c[b]),delete c[b]);k.forEach(e,function(a){(a=this._getFeature(a))&&h.push(a)},this);return h}});u("extend-esri")&&m.setObject("layers._StreamMode",r,s);return r})},"esri/PopupInfo":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/json dojo/i18n dojo/has dojo/Deferred dojo/sniff dojo/promise/all ./lang ./kernel ./request ./tasks/query ./tasks/QueryTask ./tasks/StatisticDefinition dojo/i18n!dojo/cldr/nls/number".split(" "),
function(r,m,k,u,s,e,w,n,b,g,d,f,c,x,h,a){r=r(null,{declaredClass:"esri.PopupInfo",initialize:function(a,l){if(a){m.mixin(this,l);this.info=a;this.title=this.getTitle;this.content=this.getContent;var b=this._fieldLabels={},c=this._fieldsMap={};a.fieldInfos&&k.forEach(a.fieldInfos,function(a){b[a.fieldName]=a.label;c[a.fieldName]=a});this._relatedFieldPrefix="relationships/";this.titleHasRelatedFields=!!(a.title&&-1!==a.title.indexOf("{"+this._relatedFieldPrefix))}},toJson:function(){return u.fromJson(u.toJson(this.info))},
getTitle:function(){},getContent:function(){},getComponents:function(a){var l=this.info,b=new w,c,d;l.fieldInfos&&(d=k.filter(l.fieldInfos,function(a){return-1!==a.fieldName.indexOf(this._relatedFieldPrefix)},this));d&&0<d.length&&(c=this._getRelatedRecords({graphic:a,fieldsInfo:d}));c?c.always(m.hitch(this,function(){b.resolve(this._getPopupValues(a))})):b.resolve(this._getPopupValues(a));return b.promise},_getPopupValues:function(a,b){var c=this.info,d=a.getLayer(),h=m.clone(a.attributes)||{},p=
m.clone(h),f=c.fieldInfos,e="",n="",N,C,x,s,u,r=d&&d._getDateOpts&&d._getDateOpts().properties,w={dateFormat:{properties:r,formatter:"DateFormat"+this._insertOffset(this._dateFormats.shortDateShortTime)}};if(this._relatedInfo)for(s in this._relatedInfo)if(this._relatedInfo.hasOwnProperty(s)){var P=this._relatedInfo[s],A=this._relatedLayersInfo[s];P&&(k.forEach(P.relatedFeatures,function(a){for(u in a.attributes)if(a.attributes.hasOwnProperty(u)&&"esriRelCardinalityOneToOne"===A.relation.cardinality){var q=
this._toRelatedFieldName([A.relation.id,u]);h[q]=p[q]=a.attributes[u]}},this),k.forEach(P.relatedStatsFeatures,function(a){for(u in a.attributes)if(a.attributes.hasOwnProperty(u)){var q=this._toRelatedFieldName([A.relation.id,u]);h[q]=p[q]=a.attributes[u]}},this))}f&&k.forEach(f,function(a){C=a.fieldName;p[C]=this._formatValue(p[C],C,w);r&&(a.format&&a.format.dateFormat)&&(a=k.indexOf(r,C),-1<a&&r.splice(a,1))},this);if(d){s=d.types;var E=(P=d.typeIdField)&&h[P];for(C in h)if(h.hasOwnProperty(C)&&
-1===C.indexOf(this._relatedFieldPrefix)&&(x=h[C],g.isDefined(x))){var B=this._getDomainName(d,a,s,E,C,x);g.isDefined(B)?p[C]=B:C===P&&(B=this._getTypeName(d,a,x),g.isDefined(B)&&(p[C]=B))}}c.title&&(e=this._processFieldsInLinks(this._fixTokens(c.title),h),e=m.trim(g.substitute(p,e,w)||""));if(b)return{title:e};c.description&&(n=this._processFieldsInLinks(this._fixTokens(c.description),h),n=m.trim(g.substitute(p,n,w)||""));f&&(N=[],k.forEach(f,function(a){(C=a.fieldName)&&a.visible&&N.push([a.label||
C,g.substitute(p,"${"+C+"}",w)||""])}));var M,J;c.mediaInfos&&(M=[],k.forEach(c.mediaInfos,function(a){J=0;x=a.value;switch(a.type){case "image":var q=x.sourceURL,q=q&&m.trim(g.substitute(h,this._fixTokens(q)));J=!!q;break;case "piechart":case "linechart":case "columnchart":case "barchart":J=k.some(x.fields,function(a){return g.isDefined(h[a])||-1!==a.indexOf(this._relatedFieldPrefix)&&this._relatedInfo},this);break;default:return}if(J){a=m.clone(a);x=a.value;var q=a.title?this._processFieldsInLinks(this._fixTokens(a.title),
h):"",b=a.caption?this._processFieldsInLinks(this._fixTokens(a.caption),h):"";a.title=q?m.trim(g.substitute(p,q,w)||""):"";a.caption=b?m.trim(g.substitute(p,b,w)||""):"";if("image"===a.type)x.sourceURL=g.substitute(h,this._fixTokens(x.sourceURL)),x.linkURL&&(x.linkURL=m.trim(g.substitute(h,this._fixTokens(x.linkURL))||""));else{var l,d;k.forEach(x.fields,function(a,q){if(-1!==a.indexOf(this._relatedFieldPrefix))d=this._getRelatedChartInfos(a,x,h,w),d instanceof Array?x.fields=d:x.fields[q]=d;else{var b=
h[a],b=void 0===b?null:b;l=h[x.normalizeField]||0;b&&l&&(b/=l);x.fields[q]={y:b,tooltip:(this._fieldLabels[a]||a)+":\x3cbr/\x3e"+this._formatValue(b,a,w,!!l)}}},this)}M.push(a)}},this));return{title:e,description:n,fields:N&&N.length?N:null,mediaInfos:M&&M.length?M:null,formatted:p,editSummary:d&&d.getEditSummary?d.getEditSummary(a):""}},_getRelatedChartInfos:function(a,b,d,c){var h,p,g,f,e,n;h=[];n=this._fromRelatedFieldName(a);e=n[0];p=this._relatedInfo[e];e=this._relatedLayersInfo[e];p&&k.forEach(p.relatedFeatures,
function(p){p=p.attributes;var e,k;for(k in p)if(p.hasOwnProperty(k)&&k===n[1]){e={};f=p[k];b.normalizeField&&(g=-1!==b.normalizeField.indexOf(this._relatedFieldPrefix)?p[this._fromRelatedFieldName(b.normalizeField)[1]]:d[b.normalizeField]);f&&g&&(f/=g);if(b.tooltipField)if(-1!==b.tooltipField.indexOf(this._relatedFieldPrefix)){var m=this._fromRelatedFieldName(b.tooltipField)[1];e.tooltip=p[m]+":\x3cbr/\x3e"+this._formatValue(f,p[m],c,!!g)}else e.tooltip=(this._fieldLabels[a]||a)+":\x3cbr/\x3e"+this._formatValue(f,
b.tooltipField,c,!!g);else e.tooltip=f;e.y=f;h.push(e)}},this);return"esriRelCardinalityOneToMany"===e.relation.cardinality||"esriRelCardinalityManyToMany"===e.relation.cardinality?h:h[0]},getAttachments:function(a){var b=a.getLayer();a=a.attributes;if(this.info.showAttachments&&(b&&b.hasAttachments&&b.objectIdField)&&(a=a&&a[b.objectIdField]))return b.queryAttachmentInfos(a)},_dateFormats:{shortDate:"(datePattern: 'M/d/y', selector: 'date')",shortDateLE:"(datePattern: 'd/M/y', selector: 'date')",
longMonthDayYear:"(datePattern: 'MMMM d, y', selector: 'date')",dayShortMonthYear:"(datePattern: 'd MMM y', selector: 'date')",longDate:"(datePattern: 'EEEE, MMMM d, y', selector: 'date')",shortDateShortTime:"(datePattern: 'M/d/y', timePattern: 'h:mm a', selector: 'date and time')",shortDateLEShortTime:"(datePattern: 'd/M/y', timePattern: 'h:mm a', selector: 'date and time')",shortDateShortTime24:"(datePattern: 'M/d/y', timePattern: 'H:mm', selector: 'date and time')",shortDateLEShortTime24:"(datePattern: 'd/M/y', timePattern: 'H:mm', selector: 'date and time')",
shortDateLongTime:"(datePattern: 'M/d/y', timePattern: 'h:mm:ss a', selector: 'date and time')",shortDateLELongTime:"(datePattern: 'd/M/y', timePattern: 'h:mm:ss a', selector: 'date and time')",shortDateLongTime24:"(datePattern: 'M/d/y', timePattern: 'H:mm:ss', selector: 'date and time')",shortDateLELongTime24:"(datePattern: 'd/M/y', timePattern: 'H:mm:ss', selector: 'date and time')",longMonthYear:"(datePattern: 'MMMM y', selector: 'date')",shortMonthYear:"(datePattern: 'MMM y', selector: 'date')",
year:"(datePattern: 'y', selector: 'date')"},_reHref:/href\s*=\s*\"[^\"]+\"/ig,_fixTokens:function(a){return a.replace(/(\{[^\{\r\n]+\})/g,"$$$1")},_processFieldsInLinks:function(a,b){return a&&a.replace(this._reHref,function(a){return a=g.substitute(b,a)})},_formatValue:function(b,l,d,c){var h=this._fieldsMap[l],p=h&&h.format;l="number"===typeof b&&-1===k.indexOf(d.dateFormat.properties,l)&&(!p||!p.dateFormat);if(!g.isDefined(b)||!h||!g.isDefined(p))return l?this._forceLTR(b):b;var f="",e=[],h=p.hasOwnProperty("places")||
p.hasOwnProperty("digitSeparator"),n=p.hasOwnProperty("digitSeparator")?p.digitSeparator:!0;if(h)f="NumberFormat",e.push("places: "+(g.isDefined(p.places)&&(!c||0<p.places)?Number(p.places):"Infinity")),e.length&&(f+="("+e.join(",")+")");else if(p.dateFormat)f="DateFormat"+this._insertOffset(this._dateFormats[p.dateFormat]||this._dateFormats.shortDateShortTime);else return l?this._forceLTR(b):b;b=g.substitute({myKey:b},"${myKey:"+f+"}",d)||"";h&&!n&&a.group&&(b=b.replace(RegExp("\\"+a.group,"g"),
""));return l?this._forceLTR(b):b},_forceLTR:function(a){var b=n("ie");return b&&10>=b?a:"\x3cspan class\x3d'esriNumericValue'\x3e"+a+"\x3c/span\x3e"},_insertOffset:function(a){a&&(a=g.isDefined(this.utcOffset)?a.replace(/\)\s*$/,", utcOffset:"+this.utcOffset+")"):a);return a},_getDomainName:function(a,b,d,c,h,p){return(a=a.getDomain&&a.getDomain(h,{feature:b}))&&a.codedValues?a.getName(p):null},_getTypeName:function(a,b,d){return(a=a.getType&&a.getType(b))&&a.name},_getRelatedRecords:function(a){var b=
a.graphic,d=new w,c;this._relatedLayersInfo?this._queryRelatedLayers(b).then(m.hitch(this,function(a){this._setRelatedRecords(b,a);d.resolve(a)}),m.hitch(this,this._handlerErrorResponse,d)):this._getRelatedLayersInfo(a).then(m.hitch(this,function(a){for(c in a)a.hasOwnProperty(c)&&a[c]&&(this._relatedLayersInfo[c].relatedLayerInfo=a[c]);this._queryRelatedLayers(b).then(m.hitch(this,function(a){this._setRelatedRecords(b,a);d.resolve(a)}),m.hitch(this,this._handlerErrorResponse,d))}),m.hitch(this,this._handlerErrorResponse,
d));return d.promise},_getRelatedLayersInfo:function(a){var l=a.fieldsInfo,d,c,g={};d=a.graphic.getLayer();this._relatedLayersInfo||(this._relatedLayersInfo={});k.forEach(l,function(a){var b,q,l,c;b=this._fromRelatedFieldName(a.fieldName);q=b[0];b=b[1];q&&(this._relatedLayersInfo[q]||(k.some(d.relationships,function(a){if(a.id==q)return c=a,!0}),c&&(this._relatedLayersInfo[q]={relation:c,relatedFields:[],outStatistics:[]})),this._relatedLayersInfo[q]&&(this._relatedLayersInfo[q].relatedFields.push(b),
a.statisticType&&(l=new h,l.statisticType=a.statisticType,l.onStatisticField=b,l.outStatisticFieldName=b,this._relatedLayersInfo[q].outStatistics.push(l))))},this);for(c in this._relatedLayersInfo)this._relatedLayersInfo.hasOwnProperty(c)&&this._relatedLayersInfo[c]&&(a=this._relatedLayersInfo[c].relation,a=d.url.replace(/[0-9]+$/,a.relatedTableId),this._relatedLayersInfo[c].relatedLayerUrl=a,g[c]=f({url:a,content:{f:"json"},callbackParamName:"callback"}));return b(g)},_queryRelatedLayers:function(a){var l=
{},d;for(d in this._relatedLayersInfo)this._relatedLayersInfo.hasOwnProperty(d)&&(l[d]=this._queryRelatedLayer({graphic:a,relatedInfo:this._relatedLayersInfo[d]}));return b(l)},_queryRelatedLayer:function(a){var l,d,h,g,p,f,e,n,m,C;l=a.graphic;d=l.getLayer().url.match(/[0-9]+$/g)[0];n=a.relatedInfo;e=n.relatedLayerInfo;m=n.relatedLayerUrl;C=n.relation;k.some(e.relationships,function(a){if(a.relatedTableId===parseInt(d,10))return h=a,!0},this);h&&(a=new c,k.some(e.fields,function(a){if(a.name===h.keyField)return p=
-1!==k.indexOf(["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"],a.type)?"number":"string",!0}),g="string"===p?h.keyField+"\x3d'"+l.attributes[C.keyField]+"'":h.keyField+"\x3d"+l.attributes[C.keyField],a.where=g,a.outFields=n.relatedFields,n.outStatistics&&(0<n.outStatistics.length&&e.supportsStatistics)&&(f=new c,f.where=a.where,f.outFields=a.outFields,f.outStatistics=n.outStatistics),l=new x(m),g=[],g.push(l.execute(a)),f&&g.push(l.execute(f)));return b(g)},
_setRelatedRecords:function(a,b){this._relatedInfo=[];for(var d in b)if(b.hasOwnProperty(d)&&b[d]){var c=b[d];this._relatedInfo[d]={};this._relatedInfo[d].relatedFeatures=c[0].features;g.isDefined(c[1])&&(this._relatedInfo[d].relatedStatsFeatures=c[1].features)}},_handlerErrorResponse:function(a,b){a.reject(b)},_fromRelatedFieldName:function(a){var b=[];-1!==a.indexOf(this._relatedFieldPrefix)&&(a=a.split("/"),b=a.slice(1));return b},_toRelatedFieldName:function(a){var b="";a&&0<a.length&&(b=this._relatedFieldPrefix+
a[0]+"/"+a[1]);return b}});e("extend-esri")&&(d.PopupInfo=d.PopupInfoTemplate=r);return r})},"dojo/hccss":function(){define("require ./_base/config ./dom-class ./dom-style ./has ./domReady ./_base/window".split(" "),function(r,m,k,u,s,e,w){s.add("highcontrast",function(){var e=w.doc.createElement("div");e.style.cssText='border: 1px solid; border-color:red green; position: absolute; height: 5px; top: -999px;background-image: url("'+(m.blankGif||r.toUrl("./resources/blank.gif"))+'");';w.body().appendChild(e);
var b=u.getComputedStyle(e),g=b.backgroundImage,b=b.borderTopColor==b.borderRightColor||g&&("none"==g||"url(invalid-url:)"==g);8>=s("ie")?e.outerHTML="":w.body().removeChild(e);return b});e(function(){s("highcontrast")&&k.add(w.body(),"dj_a11y")});return s})},"dijit/_WidgetBase":function(){define("require dojo/_base/array dojo/aspect dojo/_base/config dojo/_base/connect dojo/_base/declare dojo/dom dojo/dom-attr dojo/dom-class dojo/dom-construct dojo/dom-geometry dojo/dom-style dojo/has dojo/_base/kernel dojo/_base/lang dojo/on dojo/ready dojo/Stateful dojo/topic dojo/_base/window ./Destroyable dojo/has!dojo-bidi?./_BidiMixin ./registry".split(" "),
function(r,m,k,u,s,e,w,n,b,g,d,f,c,x,h,a,q,l,v,t,y,p,z){function D(a){return function(b){n[b?"set":"remove"](this.domNode,a,b);this._set(a,b)}}c.add("dijit-legacy-requires",!x.isAsync);c.add("dojo-bidi",!1);c("dijit-legacy-requires")&&q(0,function(){r(["dijit/_base/manager"])});var S={};u=e("dijit._WidgetBase",[l,y],{id:"",_setIdAttr:"domNode",lang:"",_setLangAttr:D("lang"),dir:"",_setDirAttr:D("dir"),"class":"",_setClassAttr:{node:"domNode",type:"class"},_setTypeAttr:null,style:"",title:"",tooltip:"",
baseClass:"",srcNodeRef:null,domNode:null,containerNode:null,ownerDocument:null,_setOwnerDocumentAttr:function(a){this._set("ownerDocument",a)},attributeMap:{},_blankGif:u.blankGif||r.toUrl("dojo/resources/blank.gif"),_introspect:function(){var a=this.constructor;if(!a._setterAttrs){var b=a.prototype,d=a._setterAttrs=[],a=a._onMap={},c;for(c in b.attributeMap)d.push(c);for(c in b)/^on/.test(c)&&(a[c.substring(2).toLowerCase()]=c),/^_set[A-Z](.*)Attr$/.test(c)&&(c=c.charAt(4).toLowerCase()+c.substr(5,
c.length-9),(!b.attributeMap||!(c in b.attributeMap))&&d.push(c))}},postscript:function(a,b){this.create(a,b)},create:function(a,b){this._introspect();this.srcNodeRef=w.byId(b);this._connects=[];this._supportingWidgets=[];this.srcNodeRef&&"string"==typeof this.srcNodeRef.id&&(this.id=this.srcNodeRef.id);a&&(this.params=a,h.mixin(this,a));this.postMixInProperties();this.id||(this.id=z.getUniqueId(this.declaredClass.replace(/\./g,"_")),this.params&&delete this.params.id);this.ownerDocument=this.ownerDocument||
(this.srcNodeRef?this.srcNodeRef.ownerDocument:document);this.ownerDocumentBody=t.body(this.ownerDocument);z.add(this);this.buildRendering();var d;if(this.domNode){this._applyAttributes();var c=this.srcNodeRef;c&&(c.parentNode&&this.domNode!==c)&&(c.parentNode.replaceChild(this.domNode,c),d=!0);this.domNode.setAttribute("widgetId",this.id)}this.postCreate();d&&delete this.srcNodeRef;this._created=!0},_applyAttributes:function(){var a={},b;for(b in this.params||{})a[b]=this._get(b);m.forEach(this.constructor._setterAttrs,
function(b){if(!(b in a)){var c=this._get(b);c&&this.set(b,c)}},this);for(b in a)this.set(b,a[b])},postMixInProperties:function(){},buildRendering:function(){this.domNode||(this.domNode=this.srcNodeRef||this.ownerDocument.createElement("div"));if(this.baseClass){var a=this.baseClass.split(" ");this.isLeftToRight()||(a=a.concat(m.map(a,function(a){return a+"Rtl"})));b.add(this.domNode,a)}},postCreate:function(){},startup:function(){this._started||(this._started=!0,m.forEach(this.getChildren(),function(a){!a._started&&
(!a._destroyed&&h.isFunction(a.startup))&&(a.startup(),a._started=!0)}))},destroyRecursive:function(a){this._beingDestroyed=!0;this.destroyDescendants(a);this.destroy(a)},destroy:function(a){function b(c){c.destroyRecursive?c.destroyRecursive(a):c.destroy&&c.destroy(a)}this._beingDestroyed=!0;this.uninitialize();m.forEach(this._connects,h.hitch(this,"disconnect"));m.forEach(this._supportingWidgets,b);this.domNode&&m.forEach(z.findWidgets(this.domNode,this.containerNode),b);this.destroyRendering(a);
z.remove(this.id);this._destroyed=!0},destroyRendering:function(a){this.bgIframe&&(this.bgIframe.destroy(a),delete this.bgIframe);this.domNode&&(a?n.remove(this.domNode,"widgetId"):g.destroy(this.domNode),delete this.domNode);this.srcNodeRef&&(a||g.destroy(this.srcNodeRef),delete this.srcNodeRef)},destroyDescendants:function(a){m.forEach(this.getChildren(),function(b){b.destroyRecursive&&b.destroyRecursive(a)})},uninitialize:function(){return!1},_setStyleAttr:function(a){var b=this.domNode;h.isObject(a)?
f.set(b,a):b.style.cssText=b.style.cssText?b.style.cssText+("; "+a):a;this._set("style",a)},_attrToDom:function(a,c,d){d=3<=arguments.length?d:this.attributeMap[a];m.forEach(h.isArray(d)?d:[d],function(d){var q=this[d.node||d||"domNode"];switch(d.type||"attribute"){case "attribute":h.isFunction(c)&&(c=h.hitch(this,c));d=d.attribute?d.attribute:/^on[A-Z][a-zA-Z]*$/.test(a)?a.toLowerCase():a;q.tagName?n.set(q,d,c):q.set(d,c);break;case "innerText":q.innerHTML="";q.appendChild(this.ownerDocument.createTextNode(c));
break;case "innerHTML":q.innerHTML=c;break;case "class":b.replace(q,c,this[a])}},this)},get:function(a){var b=this._getAttrNames(a);return this[b.g]?this[b.g]():this._get(a)},set:function(a,b){if("object"===typeof a){for(var c in a)this.set(c,a[c]);return this}c=this._getAttrNames(a);var d=this[c.s];if(h.isFunction(d))var q=d.apply(this,Array.prototype.slice.call(arguments,1));else{var d=this.focusNode&&!h.isFunction(this.focusNode)?"focusNode":"domNode",l=this[d]&&this[d].tagName,p;if(p=l)if(!(p=
S[l])){p=this[d];var g={},f;for(f in p)g[f.toLowerCase()]=!0;p=S[l]=g}f=p;c=a in this.attributeMap?this.attributeMap[a]:c.s in this?this[c.s]:f&&c.l in f&&"function"!=typeof b||/^aria-|^data-|^role$/.test(a)?d:null;null!=c&&this._attrToDom(a,b,c);this._set(a,b)}return q||this},_attrPairNames:{},_getAttrNames:function(a){var b=this._attrPairNames;if(b[a])return b[a];var c=a.replace(/^[a-z]|-[a-zA-Z]/g,function(a){return a.charAt(a.length-1).toUpperCase()});return b[a]={n:a+"Node",s:"_set"+c+"Attr",
g:"_get"+c+"Attr",l:c.toLowerCase()}},_set:function(a,b){var c=this[a];this[a]=b;if(this._created&&!(c===b||c!==c&&b!==b))this._watchCallbacks&&this._watchCallbacks(a,c,b),this.emit("attrmodified-"+a,{detail:{prevValue:c,newValue:b}})},_get:function(a){return this[a]},emit:function(b,c,d){c=c||{};void 0===c.bubbles&&(c.bubbles=!0);void 0===c.cancelable&&(c.cancelable=!0);c.detail||(c.detail={});c.detail.widget=this;var q,l=this["on"+b];l&&(q=l.apply(this,d?d:[c]));this._started&&!this._beingDestroyed&&
a.emit(this.domNode,b.toLowerCase(),c);return q},on:function(b,c){var d=this._onMap(b);return d?k.after(this,d,c,!0):this.own(a(this.domNode,b,c))[0]},_onMap:function(a){var b=this.constructor,c=b._onMap;if(!c){var c=b._onMap={},d;for(d in b.prototype)/^on/.test(d)&&(c[d.replace(/^on/,"").toLowerCase()]=d)}return c["string"==typeof a&&a.toLowerCase()]},toString:function(){return"[Widget "+this.declaredClass+", "+(this.id||"NO ID")+"]"},getChildren:function(){return this.containerNode?z.findWidgets(this.containerNode):
[]},getParent:function(){return z.getEnclosingWidget(this.domNode.parentNode)},connect:function(a,b,c){return this.own(s.connect(a,b,this,c))[0]},disconnect:function(a){a.remove()},subscribe:function(a,b){return this.own(v.subscribe(a,h.hitch(this,b)))[0]},unsubscribe:function(a){a.remove()},isLeftToRight:function(){return this.dir?"ltr"==this.dir:d.isBodyLtr(this.ownerDocument)},isFocusable:function(){return this.focus&&"none"!=f.get(this.domNode,"display")},placeAt:function(a,b){var c=!a.tagName&&
z.byId(a);c&&c.addChild&&(!b||"number"===typeof b)?c.addChild(this,b):(c=c&&"domNode"in c?c.containerNode&&!/after|before|replace/.test(b||"")?c.containerNode:c.domNode:w.byId(a,this.ownerDocument),g.place(this.domNode,c,b),!this._started&&(this.getParent()||{})._started&&this.startup());return this},defer:function(a,b){var c=setTimeout(h.hitch(this,function(){c&&(c=null,this._destroyed||h.hitch(this,a)())}),b||0);return{remove:function(){c&&(clearTimeout(c),c=null);return null}}}});c("dojo-bidi")&&
u.extend(p);return u})},"esri/layers/FeatureLayer":function(){define("require module dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/_base/json dojo/_base/Deferred dojo/date/locale dojo/sniff dojo/io-query dojo/dom-construct dojo/i18n dojo/when dojo/promise/all ../kernel ../lang ../request ../config ../deferredUtils ../SpatialReference ../symbols/SimpleMarkerSymbol ../symbols/SimpleLineSymbol ../symbols/SimpleFillSymbol ../symbols/jsonUtils ../renderers/SimpleRenderer ../renderers/UniqueValueRenderer ../renderers/jsonUtils ../tasks/QueryTask ../tasks/query ../tasks/FeatureSet ../tasks/StatisticDefinition ../geometry/Extent ../geometry/jsonUtils ../geometry/normalizeUtils ../geometry/scaleUtils ./GraphicsLayer ./Field ./TimeInfo ./FeatureType ./FeatureTemplate ./FeatureEditResult ./LabelClass ./SnapshotMode ./OnDemandMode ./SelectionMode ./StreamMode ./TrackManager ./HeatmapManager dojo/i18n!../nls/jsapi dojo/has!extend-esri?./agscommon".split(" "),
function(r,m,k,u,s,e,w,n,b,g,d,f,c,x,h,a,q,l,v,t,y,p,z,D,S,N,C,H,$,O,X,aa,P,A,E,B,M,J,F,I,Y,G,T,Q,U,ua,ba,ca,Z,da){var ea=v.defaults,K=k(M,{declaredClass:"esri.layers.FeatureLayer",invalidParams:"query contains one or more unsupported parameters",reHostedFS:/https?:\/\/services.*\.arcgis\.com/i,maxPointCountForAuto:4E3,maxRecordCountForAuto:2E3,maxVertexCountForAuto:25E4,generalizeForScale:4E3,_eventMap:{"add-attachment-complete":["result"],"before-apply-edits":["adds","updates","deletes"],"delete-attachments-complete":["results"],
"edits-complete":["adds","updates","deletes"],"query-attachment-infos-complete":["results"],"query-count-complete":["count"],"query-features-complete":["featureSet"],"query-ids-complete":["objectIds"],"query-related-features-complete":["featureSets"],"selection-complete":["features","method"],"update-end":["error","info"]},constructor:function(a,b){this._preventInit||this._initFeatureLayer(a,b)},_initFeatureLayer:function(a,b){this.i18n=da;b=b||{};this.showLabels=null!=b.showLabels?b.showLabels:!0;
this._outFields=b.outFields;this._defnExpr=b.definitionExpression;this._loadCallback=b.loadCallback;var c=b._usePatch;this._usePatch=null===c||void 0===c?!0:c;this._trackIdField=b.trackIdField;this.objectIdField=b.objectIdField;this._maxOffset=null!=b.maxAllowableOffset?b.maxAllowableOffset:this.maxAllowableOffset;this.quantize=null!=b.quantize?b.quantize:!0;this._optEditable=b.editable;this._optAutoGen=b.autoGeneralize;this.editSummaryCallback=b.editSummaryCallback;this.userId=b.userId;this.userIsAdmin=
b.userIsAdmin;this.useMapTime=b.hasOwnProperty("useMapTime")?!!b.useMapTime:!0;this.source=b.source;this.gdbVersion=b.gdbVersion;this.orderByFields=b.orderByFields;this.maxPointCountForAuto=null!=b.maxPointCountForAuto?b.maxPointCountForAuto:this.maxPointCountForAuto;this.maxRecordCountForAuto=null!=b.maxRecordCountForAuto?b.maxRecordCountForAuto:this.maxRecordCountForAuto;this.maxVertexCountForAuto=null!=b.maxVertexCountForAuto?b.maxVertexCountForAuto:this.maxVertexCountForAuto;this.generalizeForScale=
null!=b.generalizeForScale?b.generalizeForScale:this.generalizeForScale;this.queryPagination=null!=b.queryPagination?b.queryPagination:this.url?this.reHostedFS.test(this.url):!1;this.multipatchOption=b.multipatchOption;this._selectedFeatures={};this._selectedFeaturesArr=[];this._newFeatures=[];this._deletedFeatures={};this._ulid=this._getUniqueId();var d=K,c=this.mode=q.isDefined(b.mode)?b.mode:d.MODE_ONDEMAND;this._isStream&&(this.mode=c=d.MODE_STREAM);switch(c){case d.MODE_SNAPSHOT:this.currentMode=
d.MODE_SNAPSHOT;this._mode=new Q(this);this._isSnapshot=!0;break;case d.MODE_ONDEMAND:case d.MODE_AUTO:this.currentMode=d.MODE_ONDEMAND;this._tileWidth=b.tileWidth||512;this._tileHeight=b.tileHeight||512;this._mode=new U(this);this.latticeTiling=b.latticeTiling;break;case d.MODE_SELECTION:this.currentMode=d.MODE_SELECTION;this._mode=new ua(this);this._isSelOnly=!0;break;case d.MODE_STREAM:this.currentMode=d.MODE_STREAM,this._mode=new ba(this),this._isStream=!0}this._initLayer=s.hitch(this,this._initLayer);
this._selectHandler=s.hitch(this,this._selectHandler);this._editable=!1;if(s.isObject(a)&&a.layerDefinition)return this._collection=!0,this.mode=this._isStream?d.MODE_STREAM:d.MODE_SNAPSHOT,this._initLayer(a),this;this._task=new $(this.url,{source:this.source,gdbVersion:this.gdbVersion});c=this._url.path;this._fserver=!1;-1!==c.search(/\/FeatureServer\//i)&&(this._fserver=!0);this.mode===d.MODE_AUTO&&this.reHostedFS.test(this.url)&&this._queryLimit();(d=b.resourceInfo)?this._initLayer(d):(this.source&&
(d={source:this.source.toJson()},this._url.query=s.mixin(this._url.query,{layer:w.toJson(d)})),this.gdbVersion&&(this._url.query=s.mixin(this._url.query,{gdbVersion:this.gdbVersion})),l({url:c,content:s.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler}));this.registerConnectEvents()},_initLayer:function(a,b){if(a||b){this._json=a;this._findCredential();if(this.credential&&this.credential.ssl||a&&a._ssl)this._useSSL(),this._task._useSSL();
this._collection&&(this._isStream||(this.currentMode=K.MODE_SNAPSHOT,this._mode=new Q(this)),this._isSnapshot=!0,this._featureSet=a.featureSet,this._nextId=a.nextObjectId,a=a.layerDefinition);this.geometryType=a.geometryType;"string"!==typeof this.multipatchOption&&"esriGeometryMultiPatch"===this.geometryType&&(this.multipatchOption="xyFootprint");if(a.hasOwnProperty("capabilities")){var c=this.capabilities=a.capabilities;c&&-1!==c.toLowerCase().indexOf("editing")?this._editable=!0:this._editable=
!1}else this._collection||(this._editable=this._fserver);q.isDefined(this._optEditable)?(this._editable=this._optEditable,delete this._optEditable):"esriGeometryMultiPatch"===this.geometryType&&(this._editable=!1);this._json=w.toJson(this._json);if(this.isEditable())this._setMaxOffset(null);else if(this.currentMode!==K.MODE_SNAPSHOT&&("esriGeometryPolyline"===this.geometryType||"esriGeometryPolygon"===this.geometryType||this.hasXYFootprint()))this._autoGeneralize=q.isDefined(this._optAutoGen)?this._optAutoGen:
this.currentMode===K.MODE_ONDEMAND,delete this._optAutoGen;var c=a.effectiveMinScale||a.minScale,d=a.effectiveMaxScale||a.maxScale;!this._hasMin&&c&&this.setMinScale(c);!this._hasMax&&d&&this.setMaxScale(d);this.layerId=a.id;this.name=a.name;this.description=a.description;this.copyright=a.copyrightText;this.type=a.type;this.displayField=a.displayField;this.defaultDefinitionExpression=a.definitionExpression;this.fullExtent=new P(a.extent);this.initialExtent=new P(this.fullExtent.toJson());this.fullExtent.spatialReference&&
(this.spatialReference=new y(this.fullExtent.spatialReference.toJson()));this.defaultVisibility=a.defaultVisibility;if("esriGeometryPoint"===this.geometryType||"esriGeometryMultipoint"===this.geometryType)this.latticeTiling=!1;this.indexedFields=a.indexedFields;this.maxRecordCount=a.maxRecordCount;this.canModifyLayer=a.canModifyLayer;this.supportsStatistics=a.supportsStatistics;this.supportsAdvancedQueries=this._collection?!1:a.supportsAdvancedQueries;this.supportsCalculate=a.supportsCalculate;this.supportsAttachmentsByUploadId=
a.supportsAttachmentsByUploadId;this.supportsCoordinatesQuantization=a.supportsCoordinatesQuantization;this.quantize=this.quantize&&this.supportsCoordinatesQuantization;this.hasLabels=a.hasLabels;this.canScaleSymbols=a.canScaleSymbols;this.supportsRollbackOnFailureParameter=this.supportsRollbackOnFailure=a.supportsRollbackOnFailure;this.syncCanReturnChanges=a.syncCanReturnChanges;this.isDataVersioned=a.isDataVersioned;this.editFieldsInfo=a.editFieldsInfo;this.ownershipBasedAccessControlForFeatures=
a.ownershipBasedAccessControlForFeatures;this.editFieldsInfo&&this.ownershipBasedAccessControlForFeatures&&(this.creatorField=this.editFieldsInfo.creatorField);this.relationships=a.relationships;this.allowGeometryUpdates=q.isDefined(a.allowGeometryUpdates)?a.allowGeometryUpdates:!0;this.advancedQueryCapabilities=a.advancedQueryCapabilities||{supportsStatistics:this.supportsStatistics,supportsOrderBy:this.supportsAdvancedQueries,supportsDistinct:this.supportsAdvancedQueries};this._setMaxOffset(this._maxOffset,
!0);this._isTable="Table"===this.type;for(var l=this.fields=[],d=a.fields,c=0;c<d.length;c++)l.push(new J(d[c]));if(!this.objectIdField){this.objectIdField=a.objectIdField;if(!this.objectIdField){d=a.fields;for(c=0;c<d.length;c++)if(l=d[c],"esriFieldTypeOID"===l.type){this.objectIdField=l.name;break}}!this.objectIdField&&!this._isStream&&console.debug("esri.layers.FeatureLayer: "+q.substitute({url:this.url},"objectIdField is not set [url: ${url}]"))}if(!q.isDefined(this._nextId)){d=this.objectIdField;
l=-1;if(this._collection&&d)for(var h=(c=this._featureSet)&&c.features,f=h?h.length:0,t,c=0;c<f;c++)t=(t=h[c].attributes)&&t[d],t>l&&(l=t);this._nextId=l+1}this.globalIdField=a.globalIdField;if(c=this.typeIdField=a.typeIdField)if(c=!this._getField(c)&&this._getField(c,!0))this.typeIdField=c.name;this.visibilityField=a.visibilityField;if(d=a.defaultSymbol)this.defaultSymbol=S.fromJson(d);var n=this.types=[],v=a.types,k,m,l=(c=this.editFieldsInfo)&&c.creatorField,h=c&&c.editorField;t=l||h;f=[];if(v)for(c=
0;c<v.length;c++)k=new I(v[c]),m=k.templates,t&&(m&&m.length)&&(f=f.concat(m)),n.push(k);v=a.templates;k=this.templates=[];if(v)for(c=0;c<v.length;c++)n=new Y(v[c]),t&&f.push(n),k.push(n);for(c=0;c<f.length;c++)if(t=s.getObject("prototype.attributes",!1,f[c]))l&&delete t[l],h&&delete t[h];if(c=a.timeInfo)this.timeInfo=new F(c),this._startTimeField=c.startTimeField,this._endTimeField=c.endTimeField,this._startTimeField&&this._endTimeField&&(this._twoTimeFields=!0),this._trackIdField?c.trackIdField=
this._trackIdField:this._trackIdField=c.trackIdField;this.hasAttachments=!this._collection&&a.hasAttachments?!0:!1;this.htmlPopupType=a.htmlPopupType;var c=a.drawingInfo,x;if((l=c&&c.labelingInfo)&&!this.labelingInfo)this.labelingInfo=e.map(l,function(a){return new T(a)}),this._fixLabelExpr();if(!this.renderer)if(c&&c.renderer){if(x=c.renderer,this.setRenderer(H.fromJson(x)),"classBreaks"===x.type&&this.renderer.setMaxInclusive(!0),!this._collection){var u=x.type,d=[];x=this.renderer;switch(u){case "simple":d.push(x.symbol);
break;case "uniqueValue":case "classBreaks":d.push(x.defaultSymbol),d=d.concat(e.map(x.infos,function(a){return a.symbol}))}var d=e.filter(d,q.isDefined),r=this._url.path+"/images/",O=this._getToken();e.forEach(d,function(a){var b=a.url;b&&(-1===b.search(/https?\:/)&&-1===b.indexOf("data:")&&(a.url=r+b),O&&-1!==a.url.search(/https?\:/)&&(a.url+="?token\x3d"+O))})}}else if(d)v=this.types,0<v.length?(x=new C(this.defaultSymbol,this.typeIdField),e.forEach(v,function(a){x.addValue(a.id,a.symbol)})):x=
new N(this.defaultSymbol),this.setRenderer(x);else if(!this._isTable){switch(this.geometryType){case "esriGeometryPoint":case "esriGeometryMultipoint":u=new p;break;case "esriGeometryPolyline":u=new z;break;case "esriGeometryPolygon":u=new D;break;default:this.hasXYFootprint()&&(u=new D)}this.setRenderer(u?new N(u):null)}u=c&&c.transparency||0;!this.hasOwnProperty("opacity")&&0<u&&(this.opacity=1-u/100);this.version=a.currentVersion;this.version||(this.version="capabilities"in a||"drawingInfo"in a||
"hasAttachments"in a||"htmlPopupType"in a||"relationships"in a||"timeInfo"in a||"typeIdField"in a||"types"in a?10:9.3);if((g("ie")||7<=g("trident")||g("safari"))&&this.isEditable()&&10.02>this.version)this._ts=!0;this.statistics=a.statistics;this._fixRendererFields();this._checkFields();this._updateCaps();var A=function(){this.currentMode!==K.MODE_SNAPSHOT&&(this.queryPagination=!1);this.loaded=!0;this.onLoad(this);var a=this._loadCallback;a&&(delete this._loadCallback,a(this))};this._collection?
(u=this._featureSet,this._featureSet=null,this._mode._drawFeatures(new X(u)),this._fcAdded=!0,A.call(this)):this._forceIdentity(this._limitPromise?function(){var a=this;this._limitPromise.then(function(b){a._checkMode(b)});this._limitPromise.always(function(){a._limitPromise=null;A.call(a)})}:A)}},setShowLabels:function(a){this.showLabels=a;this.onShowLabelsChange()},onShowLabelsChange:function(){},onRendererChange:function(a){this.inherited(arguments);var b=this._map;this._ager=!(!a||!a.observationAger||
!a.observationRenderer);a&&"colors"in a&&"blurRadius"in a&&"maxPixelIntensity"in a?"esriGeometryPoint"==this.geometryType&&(!this._heatmapManager&&b)&&(this._heatmapManager=new Z(this),this._heatmapManager.initialize(b)):this.renderer&&this.renderer.getRendererInfo?e.some(this.renderer.rendererInfos,function(a){return a.renderer&&"colors"in a.renderer&&"blurRadius"in a.renderer})||(this._heatmapManager=null):this._heatmapManager=null;if(a){var c=[],b=e.filter([a,a.observationRenderer,a.latestObservationRenderer,
a.trackRenderer],q.isDefined),d=function(a){return null!=a&&"function"!=typeof a&&a};e.forEach(b,function(a){var b=d(a.attributeField),l=d(a.attributeField2);a=d(a.attributeField3);!1!==b&&c.push(b);!1!==l&&c.push(l);!1!==a&&c.push(a)});this._rendererFields=c}else this._rendererFields=[];this.loaded&&(this._fixRendererFields(),this._checkFields(this._rendererFields),this._collection&&(this._typesDirty=!0))},redraw:function(){this.inherited(arguments);this._trackManager&&this._trackManager.container&&
this._trackManager.container.redraw()},_evalSDRenderer:function(){this.inherited(arguments);var a=this._getRenderer();this._ager=!(!a||!a.observationAger||!a.observationRenderer);this._trackManager&&this._trackManager.container&&this._trackManager.container.setRenderer(a&&a.trackRenderer)},_setMap:function(a){var b=this.inherited(arguments),c=this._mode,d=this;c&&c.initialize(a);this.geometryType&&this.attr("data-geometry-type",this.geometryType.replace(/esriGeometry/i,"").toLowerCase());this._addHandle=
this.on("graphic-node-add",function(a){a=a.graphic.attributes;(a=d._selectedFeatures[a&&a[d.objectIdField]])&&a.attr("data-selected","")});return b},_unsetMap:function(a){var b=this._mode;b&&b.suspend();this._trackManager&&(this._trackManager.destroy(),this._trackManager=null);u.disconnect(this._zoomConnect);u.disconnect(this._addHandle);this._zoomConnect=this._addHandle=null;this._toggleTime(!1);this.inherited("_unsetMap",arguments)},refresh:function(){var a=this._mode;a&&a.refresh()},hasXYFootprint:function(){return"esriGeometryMultiPatch"===
this.geometryType&&"xyFootprint"===this.multipatchOption},getOutFields:function(){return e.filter(this._getOutFields(),function(a){return"*"===a||!!this._getField(a)},this)},getField:function(a){return this._getField(a,!0)},getDomain:function(a,b){var c,d,l=b&&b.feature,q=l&&this.typeIdField&&l.attributes&&l.attributes[this.typeIdField];null!=q&&e.some(this.types,function(b){if(b.id==q){if((c=b.domains&&b.domains[a])&&"inherited"===c.type)c=this._getLayerDomain(a),d=!0;return!0}return!1},this);!d&&
!c&&(c=this._getLayerDomain(a));return c},_getLayerDomain:function(a){var b;e.some(this.fields,function(c){c.name===a&&(b=c.domain);return!!b});return b},getType:function(a){var b,c=a&&this.typeIdField&&a.attributes&&a.attributes[this.typeIdField];e.some(this.types,function(a){a.id==c&&(b=a);return!!b});return b},setEditable:function(a){if(!this._collection)return console.log("FeatureLayer:setEditable - this functionality is not yet supported for layer in a feature service"),this;if(!this.loaded)return this._optEditable=
a,this;var b=this._editable;this._editable=a;this._updateCaps();if(b!==a)this.onCapabilitiesChange();return this},getEditCapabilities:function(a){var b={canCreate:!1,canUpdate:!1,canDelete:!1};if(!this.loaded||!this.isEditable())return b;var c=a&&a.feature;a=a&&a.userId;var d=e.map(this.capabilities?this.capabilities.toLowerCase().split(","):[],s.trim),l=-1<e.indexOf(d,"editing"),q=l&&-1<e.indexOf(d,"create"),b=l&&-1<e.indexOf(d,"update"),d=l&&-1<e.indexOf(d,"delete"),h=this.ownershipBasedAccessControlForFeatures,
p=this.editFieldsInfo,f=p&&p.creatorField,p=p&&p.realm,c=(c=c&&c.attributes)&&f?c[f]:void 0,g=!!this.userIsAdmin,f=!h||g||!(!h.allowOthersToUpdate&&!h.allowUpdateToOthers),h=!h||g||!(!h.allowOthersToDelete&&!h.allowDeleteToOthers);if(g||l&&!q&&!b&&!d)q=b=d=!0;l={canCreate:q,canUpdate:b,canDelete:d};null===c?(l.canUpdate=b&&f,l.canDelete=d&&h):""!==c&&c&&((a=a||this.getUserId())&&p&&(a=a+"@"+p),a.toLowerCase()!==c.toLowerCase()&&(l.canUpdate=b&&f,l.canDelete=d&&h));return l},getUserId:function(){var a;
this.loaded&&(a=this.credential&&this.credential.userId||this.userId||"");return a},setUserIsAdmin:function(a){this.userIsAdmin=a},setEditSummaryCallback:function(a){this.editSummaryCallback=a},getEditSummary:function(a,b,c){c=q.isDefined(c)?c:(new Date).getTime();var d="";c=this.getEditInfo(a,b,c);(b=b&&b.callback||this.editSummaryCallback)&&(c=b(a,c)||"");if(s.isString(c))d=c;else{if(c){a=c.action;b=c.userId;var l=c.timeValue,h=0;a&&h++;b&&h++;q.isDefined(l)&&h++;1<h&&(d=("edit"===a?"edit":"create")+
(b?"User":"")+(q.isDefined(l)?c.displayPattern:""))}d=d&&q.substitute(c,this.i18n.layers.FeatureLayer[d])}return d},getEditInfo:function(a,b,c){if(this.loaded){c=q.isDefined(c)?c:(new Date).getTime();b=b&&b.action||"last";var d=this.editFieldsInfo,l=d&&d.creatorField,h=d&&d.creationDateField,p=d&&d.editorField,d=d&&d.editDateField,p=(a=a&&a.attributes)&&p?a[p]:void 0,d=a&&d?a[d]:null,l=this._getEditData(a&&l?a[l]:void 0,a&&h?a[h]:null,c);c=this._getEditData(p,d,c);var f;switch(b){case "creation":f=
l;break;case "edit":f=c;break;case "last":f=c||l}f&&(f.action=f===c?"edit":"creation");return f}},_getEditData:function(a,c,d){var l,h,p;q.isDefined(c)&&(h=d-c,p=0>h?"Full":6E4>h?"Seconds":12E4>h?"Minute":36E5>h?"Minutes":72E5>h?"Hour":864E5>h?"Hours":6048E5>h?"WeekDay":"Full");if(void 0!==a||p)l=l||{},l.userId=a,p&&(a=b.format,d=new Date(c),l.minutes=Math.floor(h/6E4),l.hours=Math.floor(h/36E5),l.weekDay=a(d,{datePattern:"EEEE",selector:"date"}),l.formattedDate=a(d,{selector:"date"}),l.formattedTime=
a(d,{selector:"time"}),l.displayPattern=p,l.timeValue=c);return l},isEditable:function(){return!(!this._editable&&!this.userIsAdmin)},setMaxAllowableOffset:function(a){this.isEditable()||this._setMaxOffset(a,!0);return this},getMaxAllowableOffset:function(){var a=this._quantizationParameters?this._quantizationParameters.tolerance:void 0;return null!=this._maxOffset?this._maxOffset:a},_setMaxOffset:function(a,b){if(null==a)return delete this._maxOffset,delete this._quantizationParameters,this;this.quantize&&
this.supportsCoordinatesQuantization?("esriGeometryPolyline"===this.geometryType?this._maxOffset=a:delete this._maxOffset,this._quantizationParameters={mode:"view",originPosition:"upperLeft",tolerance:a,extent:this.fullExtent}):(b||(a=Math.floor(a)),this._maxOffset=a,delete this._quantizationParameters);return this},setAutoGeneralize:function(a){if(this.loaded){if(!this.isEditable()&&this.currentMode!==K.MODE_SNAPSHOT&&("esriGeometryPolyline"===this.geometryType||"esriGeometryPolygon"===this.geometryType||
this.hasXYFootprint()))(this._autoGeneralize=a)?(a=this._map)&&a.loaded&&this._setMaxOffset(a.extent.getWidth()/a.width):this._setMaxOffset(null)}else this._optAutoGen=a;return this},setGDBVersion:function(a){if(!this._collection&&a!==this.gdbVersion&&(a||this.gdbVersion))this.gdbVersion=a,this._task.gdbVersion=a,this._url.query=s.mixin(this._url.query,{gdbVersion:a}),this.loaded&&(this.clearSelection(),this._map&&this.refresh()),this.onGDBVersionChange();return this},setDefinitionExpression:function(a){this._defnExpr=
a;(a=this._mode)&&a.propertyChangeHandler(1);return this},getDefinitionExpression:function(){return this._defnExpr},setTimeDefinition:function(a){this._isSnapshot?(this._timeDefn=a,(a=this._mode)&&a.propertyChangeHandler(2)):console.log("FeatureLayer.setTimeDefinition: layer in on-demand or selection mode does not support time definitions. Layer id \x3d "+this.id+", Layer URL \x3d "+this.url);return this},getTimeDefinition:function(){return this._timeDefn},setTimeOffset:function(a,b){this._timeOffset=
a;this._timeOffsetUnits=b;var c=this._mode;c&&c.propertyChangeHandler(0);return this},setUseMapTime:function(a){this.useMapTime=a;this._toggleTime(!this.suspended);(a=this._mode)&&a.propertyChangeHandler(0)},selectFeatures:function(a,b,c,d){b=b||K.SELECTION_NEW;a=this._getShallowClone(a);var l=this._map,q,h=this,p=t._fixDfd(new n(t._dfdCanceller));a.outFields=this.getOutFields();a.returnGeometry=!0;a.multipatchOption=this.multipatchOption;l&&(a.outSpatialReference=new y(l.spatialReference.toJson()));
if(!this._applyQueryFilters(a,!0))return q={features:[]},this._selectHandler(q,b,c,d,p),p;if(l=this._canDoClientSideQuery(a))p._pendingDfd=x(this._doQuery(a,l)),p._pendingDfd.then(function(a){q={features:a};h._selectHandler(q,b,c,d,p)});else{if(this._collection)return this._resolve([Error("FeatureLayer::selectFeatures - "+this.invalidParams)],null,d,p,!0),p;var f=this;this._ts&&(a._ts=(new Date).getTime());(p._pendingDfd=this._task.execute(a)).addCallbacks(function(a){f._selectHandler(a,b,c,d,p)},
function(a){f._resolve([a],null,d,p,!0)})}return p},getSelectedFeatures:function(){var a=this._selectedFeatures,b=[],c;for(c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b},clearSelection:function(a){var b=this._selectedFeatures,c=this._mode,d;for(d in b)b.hasOwnProperty(d)&&(this._unSelectFeatureIIf(d,c),c._removeFeatureIIf(d));this._selectedFeatures={};this._isSelOnly&&c._applyTimeFilter(!0);if(!a)this.onSelectionClear();return this},setSelectionSymbol:function(a){if(this._selectionSymbol=a){var b=
this._selectedFeatures,c;for(c in b)b.hasOwnProperty(c)&&b[c].setSymbol(a)}return this},getSelectionSymbol:function(){return this._selectionSymbol},setLabelingInfo:function(a){a?(this.labelingInfo=a,this._fixLabelExpr()):delete this.labelingInfo;this._collection&&(this._typesDirty=!0);this.onLabelingInfoChange()},_fixLabelExpr:function(){var a=/\[([^\[\]]+)\]/ig,b,c=this,d=function(a,b){var d=c._getField(b,!0);return"["+(d&&d.name||b)+"]"};e.forEach(this.labelingInfo,function(c){if(b=c.labelExpression)c.labelExpression=
b.replace(a,d)})},__msigns:[{n:"applyEdits",c:5,a:[{i:0},{i:1}],e:4,f:1}],applyEdits:function(a,b,c,d,q,h){var p=h.assembly,f=h.dfd;this._applyNormalized(a,p&&p[0]);this._applyNormalized(b,p&&p[1]);this.onBeforeApplyEdits(a,b,c);var g={},t=this.objectIdField,p={f:"json"},v=!1;if(this._collection)h={},h.addResults=a?e.map(a,function(){v=!0;return{objectId:this._nextId++,success:!0}},this):null,h.updateResults=b?e.map(b,function(a){v=!0;var b=a.attributes[t];g[b]=a;return{objectId:b,success:!0}},this):
null,h.deleteResults=c?e.map(c,function(a){v=!0;return{objectId:a.attributes[t],success:!0}},this):null,v?this._editHandler(h,a,g,d,q,f):this._resolve([h.addResults,h.updateResults,h.deleteResults],null,d,f);else{a&&0<a.length&&(p.adds=this._convertFeaturesToJson(a,0,1),v=!0);if(b&&0<b.length){for(h=0;h<b.length;h++){var n=b[h];g[n.attributes[t]]=n}p.updates=this._convertFeaturesToJson(b,0,0,1);v=!0}if(c&&0<c.length){b=[];for(h=0;h<c.length;h++)b.push(c[h].attributes[t]);p.deletes=b.join(",");v=!0}if(v){var z=
this;return l({url:this._url.path+"/applyEdits",content:s.mixin(p,this._url.query),callbackParamName:"callback",load:function(b){z._editHandler(b,a,g,d,q,f)},error:function(a){z._resolve([a],null,q,f,!0)}},{usePost:!0})}this._resolve([],null,d,f)}},queryFeatures:function(a,b,c){return this._query("execute","onQueryFeaturesComplete",a,b,c)},queryRelatedFeatures:function(a,b,c){return this._query("executeRelationshipQuery","onQueryRelatedFeaturesComplete",a,b,c)},queryIds:function(a,b,c){return this._query("executeForIds",
"onQueryIdsComplete",a,b,c)},queryCount:function(a,b,c){return this._query("executeForCount","onQueryCountComplete",a,b,c)},queryExtent:function(a,b,c){return this._query("executeForExtent","onQueryExtentComplete",a,b,c)},queryAttachmentInfos:function(a,b,c){var h=this._url.path+"/"+a+"/attachments",q=new n(t._dfdCanceller),p=this;q._pendingDfd=l({url:h,content:s.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:function(c){c=c.attachmentInfos;var l;e.forEach(c,function(b){l=d.objectToQuery({gdbVersion:p._url.query&&
p._url.query.gdbVersion,layer:p._url.query&&p._url.query.layer,token:p._getToken()});b.url=h+"/"+b.id+(l?"?"+l:"");b.objectId=a});p._resolve([c],"onQueryAttachmentInfosComplete",b,q)},error:function(a){p._resolve([a],null,c,q,!0)}});return q},addAttachment:function(a,b,c,d){return this._sendAttachment("add",a,b,c,d)},updateAttachment:function(a,b,c,d,l){c.appendChild(f.create("input",{type:"hidden",name:"attachmentId",value:b}));return this._sendAttachment("update",a,c,d,l)},deleteAttachments:function(a,
b,c,d){var h=this._url.path+"/"+a+"/deleteAttachments",q=new n(t._dfdCanceller),p=this;b={f:"json",attachmentIds:b.join(",")};q._pendingDfd=l({url:h,content:s.mixin(b,this._url.query),callbackParamName:"callback",load:s.hitch(this,function(b){b=b.deleteAttachmentResults;b=e.map(b,function(b){b=new G(b);b.attachmentId=b.objectId;b.objectId=a;return b});p._resolve([b],"onDeleteAttachmentsComplete",c,q)}),error:function(a){p._resolve([a],null,d,q,!0)}},{usePost:!0});return q},addType:function(a){var b=
this.types;if(b){if(e.some(b,function(b){return b.id==a.id?!0:!1}))return!1;b.push(a)}else this.types=[a];return this._typesDirty=!0},deleteType:function(a){if(this._collection){var b=this.types;if(b){var c=-1;e.some(b,function(b,d){return b.id==a?(c=d,!0):!1});if(-1<c)return this._typesDirty=!0,b.splice(c,1)[0]}}},toJson:function(){var a=this._json;if(a=s.isString(a)?w.fromJson(a):s.clone(a)){var a=a.layerDefinition?a:{layerDefinition:a},b=a.layerDefinition,c=this._collection;if(c&&this._typesDirty){b.types=
e.map(this.types||[],function(a){return a.toJson()});var d=this.renderer,l=this.labelingInfo,h=b.drawingInfo;if((d||l)&&!h)h=b.drawingInfo={};h&&(d&&-1===d.declaredClass.indexOf("TemporalRenderer"))&&(h.renderer=d.toJson());l&&(h.labelingInfo=e.map(l,function(a){return a.toJson()}))}d=null;if(!c||this._fcAdded)d={geometryType:b.geometryType,features:this._convertFeaturesToJson(this.graphics,!0)};a.featureSet=s.mixin({},a.featureSet||{},d);c&&(a.nextObjectId=this._nextId,b.capabilities=this.capabilities);
return a}},onSelectionComplete:function(){},onSelectionClear:function(){},onBeforeApplyEdits:function(){},onEditsComplete:function(){},onQueryFeaturesComplete:function(){},onQueryRelatedFeaturesComplete:function(){},onQueryIdsComplete:function(){},onQueryCountComplete:function(){},onQueryExtentComplete:function(){},onQueryAttachmentInfosComplete:function(){},onAddAttachmentComplete:function(){},onUpdateAttachmentComplete:function(){},onDeleteAttachmentsComplete:function(){},onCapabilitiesChange:function(){},
onGDBVersionChange:function(){},onQueryLimitExceeded:function(){},onLabelingInfoChange:function(){},_forceIdentity:function(b){var c=this,d=this._url&&this._url.path;(this.ownershipBasedAccessControlForFeatures||this.userIsAdmin)&&!this._getToken()&&d&&a.id&&a.id._hasPortalSession()&&a.id._doPortalSignIn(d)?a.id.getCredential(d).then(function(){c._findCredential();b.call(c)},function(){b.call(c)}):b.call(this)},_checkMode:function(a){var b=this.geometryType,c=this.maxRecordCount;a=(a=a&&a.features&&
a.features[0])&&a.attributes&&a.attributes.exceedslimit;if(this.mode===K.MODE_AUTO&&!this.isEditable()&&0===a&&(this.queryPagination||("esriGeometryPolyline"===b||"esriGeometryPolygon"===b||"esriGeometryMultipoint"===b||this.hasXYFootprint())&&c>=this.maxRecordCountForAuto||"esriGeometryPoint"===b&&c>=this.maxPointCountForAuto))this.currentMode=K.MODE_SNAPSHOT,this._mode=new Q(this),this._isSnapshot=!0,this._autoGeneralize=!1},_queryLimit:function(){var a=this,b=new n;this._limitPromise=b.promise;
setTimeout(function(){var c=new O,d=new aa;d.statisticType="exceedslimit";d.maxPointCount=a.maxPointCountForAuto;d.maxRecordCount=a.maxRecordCountForAuto;d.maxVertexCount=a.maxVertexCountForAuto;d.outStatisticFieldName="exceedslimit";c.outStatistics=[d];a.queryFeatures(c).promise.then(function(a){b.resolve(a)},function(a){b.reject(a)})},0)},_updateCaps:function(){var a=this._editable,b=s.trim(this.capabilities||""),c=e.map(b?b.split(","):[],s.trim),d=e.map(b?b.toLowerCase().split(","):[],s.trim),
b=e.indexOf(d,"editing"),l,d={Create:e.indexOf(d,"create"),Update:e.indexOf(d,"update"),Delete:e.indexOf(d,"delete")};if(a&&-1===b)c.push("Editing");else if(!a&&-1<b){a=[b];for(l in d)-1<d[l]&&a.push(d[l]);a.sort();for(l=a.length-1;0<=l;l--)c.splice(a[l],1)}this.capabilities=c.join(",")},_counter:{value:0},_getUniqueId:function(){return this._counter.value++},onSuspend:function(){this.inherited(arguments);this._toggleTime(!1);var a=this._mode;a&&a.suspend()},onResume:function(a){this.inherited(arguments);
this._toggleTime(!0);this._updateMaxOffset();var b=this._mode,c=this._map,d=this._getRenderer();if(a.firstOccurrence){this._fixRendererFields();this._checkFields();this.clearSelection();if(this.timeInfo&&!this._trackManager&&(this._trackIdField||d&&(d.latestObservationRenderer||d.trackRenderer)))this._trackManager=new ca(this),this._trackManager.initialize(c);d&&("colors"in d&&"blurRadius"in d&&"maxPixelIntensity"in d)&&("esriGeometryPoint"==this.geometryType&&!this._heatmapManager)&&(this._heatmapManager=
new Z(this),this._heatmapManager.initialize(c));if(this.mode===K.MODE_AUTO&&this.currentMode===K.MODE_SNAPSHOT&&("esriGeometryPolyline"===this.geometryType||"esriGeometryPolygon"===this.geometryType||this.hasXYFootprint())&&!this.getMaxAllowableOffset())d=this.generalizeForScale,d=this.maxScale?this.maxScale:this.minScale?Math.min(d,this.minScale):Math.min(d,B.getScale(c,this.initialExtent)),this.isEditable()||this._setMaxOffset(c.extent.getWidth()/c.width/c.getScale()*d,!0);this._zoomConnect=u.connect(c,
"onZoomEnd",this,this._updateMaxOffset)}b&&(a.firstOccurrence?b.startup():b.resume())},_updateMaxOffset:function(){var a=this._map;a&&a.loaded&&this._autoGeneralize&&this._setMaxOffset(a.extent.getWidth()/a.width)},_toggleTime:function(a){var b=this._map;a&&this.timeInfo&&this.useMapTime&&b?(this._mapTimeExtent=b.timeExtent,this._timeConnect||(this._timeConnect=u.connect(b,"onTimeExtentChange",this,this._timeChangeHandler))):(this._mapTimeExtent=null,u.disconnect(this._timeConnect),this._timeConnect=
null)},_timeChangeHandler:function(a){this._mapTimeExtent=a;(a=this._mode)&&a.propertyChangeHandler(0)},_getOffsettedTE:function(a){var b=this._timeOffset,c=this._timeOffsetUnits;return a&&b&&c?a.offset(-1*b,c):a},_getTimeOverlap:function(a,b){return a&&b?a.intersection(b):a||b},_getTimeFilter:function(a){var b=this.getTimeDefinition(),c;if(b&&(c=this._getTimeOverlap(b,null),!c))return[!1];if(a){if(a=c?this._getTimeOverlap(a,c):a,!a)return[!1]}else a=c;return[!0,a]},_getAttributeFilter:function(a){var b=
this.getDefinitionExpression();return a?b?"("+b+") AND ("+a+")":a:b},_applyQueryFilters:function(a,b){a.where=this._getAttributeFilter(a.where);a.maxAllowableOffset=this._maxOffset;a.quantizationParameters=this._quantizationParameters;b&&this.supportsAdvancedQueries&&(a.orderByFields=a.orderByFields||this.getOrderByFields());if(this.timeInfo){var c=this._getTimeFilter(a.timeExtent);if(c[0])a.timeExtent=c[1];else return!1}return!0},_add:function(a){var b=this._selectionSymbol,c=a.attributes,d=this.visibilityField;
b&&this._isSelOnly&&a.setSymbol(b);if(d&&c&&c.hasOwnProperty(d))a[c[d]?"show":"hide"]();return this.add.apply(this,arguments)},_remove:function(){return this.remove.apply(this,arguments)},_canDoClientSideQuery:function(a){var b=[],c=this._map;if(!(this._isTable||!c&&!this._collection))if(!a.text&&!(a.where&&a.where!==this.getDefinitionExpression()||a.orderByFields&&a.orderByFields.length||a.outStatistics||a.returnDistinctValues)){var d=this._isSnapshot,l=this._isSelOnly,h=a.geometry;if(h)if(!l&&a.spatialRelationship===
O.SPATIAL_REL_INTERSECTS&&"extent"===h.type&&(d||c.extent.contains(h)))b.push(1);else return;if(c=a.objectIds)if(d)b.push(2);else{var h=c.length,q=this._mode,p=0,f;for(f=0;f<h;f++)q._getFeature(c[f])&&p++;if(p===h)b.push(2);else return}if(this.timeInfo)if(a=a.timeExtent,c=this._mapTimeExtent,d)a&&b.push(3);else if(l){if(a)return}else if(c)if(-1!==e.indexOf(b,2))a&&b.push(3);else if(-1!==e.indexOf(b,1))a==c&&b.push(3);else return;else if(0<b.length)a&&b.push(3);else if(a)return;return 0<b.length?b:
null}},_getAbsMid:function(a){return r.toAbsMid?r.toAbsMid(a):m.id.replace(/\/[^\/]*$/ig,"/")+a},_doQuery:function(a,b,c){var d=[],l=this._mode,h=this.objectIdField,q=this,p,f,g=new n,t=new n,v=function(a,b){if(!a.length||!b.length)return a.length?a:b;var c,d,l={};a.length>b.length?(d=a,c=b):(d=b,c=a);for(var q=d.length,p=c.length,f;q--;)f=d[q],l[f.attributes[h]]=!0;for(;p--;)f=c[p],l[f.attributes[h]]||d.push(f);return d};if(-1!==e.indexOf(b,1)){f=this.graphics;p=f.length;var z=this.spatialIndex||
this._map&&this._map.spatialIndex,k,y=a.geometry._normalize(null,!0);null==z&&ea.autoSpatialIndexing?k=(this._map||this).addPlugin(this._getAbsMid("../plugins/spatialIndex")).then(s.hitch(this,s.partial(this._getFromIndex,y,z)),function(a){t.resolve(s.hitch(this,s.partial(this._filterByExtent,f,y)))}):z&&(k=this._getFromIndex(y,z));k?k.then(function(a){for(var b=0;b<a.length;b++)a[b].results&&(d=d.concat(a[b].results));t.resolve(d)}).otherwise(function(a){t.reject(a)}):t.resolve(this._filterByExtent(f,
y))}else t.resolve([]);t.then(function(d){var f=[];if(-1!==e.indexOf(b,2)){var t=a.objectIds;for(p=t.length;p--;){var n=l._getFeature(t[p]);n&&f.push(n)}f=v(d,f)}else f=d;-1!==e.indexOf(b,3)&&q.timeInfo&&(d=a.timeExtent,f=q._filterByTime(0<f.length?f:q.graphics,d.startTime,d.endTime).match);c&&(f=e.map(f,function(a){return a.attributes[h]},this));g.resolve(f)});return g},_getFromIndex:function(a,b){b=b||this.spatialIndex||this._map.spatialIndex;a instanceof Array||(a=[a]);var c=this.id;return h(e.map(a,
function(a){return b.intersects(a,c)}))},_filterByExtent:function(a,b){for(var c=[],d=0,l=a.length;d<l;d++){var h=a[d],q=h.geometry;q&&(this.normalization&&b.length?(b[0].intersects(q)||b[1].intersects(q))&&c.push(h):b.intersects(q)&&c.push(h))}return c},_filterByTime:function(a,b,c){var d=this._startTimeField,l=this._endTimeField,h;this._twoTimeFields||(h=d||l);var p=q.isDefined,f=[],g=[],t,e=a.length,v,n;b=b?b.getTime():-Infinity;c=c?c.getTime():Infinity;if(h)for(t=0;t<e;t++)v=a[t],n=v.attributes,
d=n[h],d>=b&&d<=c?f.push(v):g.push(v);else for(t=0;t<e;t++)v=a[t],n=v.attributes,h=n[d],n=n[l],h=p(h)?h:-Infinity,n=p(n)?n:Infinity,h>=b&&h<=c||n>=b&&n<=c||b>=h&&c<=n?f.push(v):g.push(v);return{match:f,noMatch:g}},_resolve:function(a,b,c,d,l){b&&this[b].apply(this,a);c&&c.apply(null,a);d&&t._resDfd(d,a,l)},_getShallowClone:function(a){var b=new O,c;for(c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},_query:function(a,b,c,d,l){var h=this,q=this._map,p=new n(t._dfdCanceller),f=c,g=function(c,l){if(!l&&
("execute"===a||"executeRelationshipQuery"===a)){var q,f;if("execute"===a){q=c.features;f=q.length;for(f-=1;0<=f;f--)if(q[f]._layer=h,!h._isTable){var g=h._mode._getFeature(q[f].attributes[h.objectIdField]);g&&q.splice(f,1,g)}}else for(g in c)if(c.hasOwnProperty(g)){q=c[g].features;f=q.length;for(f-=1;0<=f;f--)q[f]._layer=h}}h._resolve([c],b,d,p)};if("executeRelationshipQuery"!==a){f=this._getShallowClone(c);f.outFields=this.getOutFields();f.returnGeometry=c.hasOwnProperty("returnGeometry")?c.returnGeometry:
!c.outStatistics;f.returnGeometry&&(f.multipatchOption=this.multipatchOption);var e;q&&(f.outSpatialReference=new y(q.spatialReference.toJson()));if(!this._applyQueryFilters(f,"execute"===a&&!f.outStatistics)){switch(a){case "execute":e=new X({features:[]});break;case "executeForIds":e=[];break;case "executeForCount":e=0;break;case "executeForExtent":e={}}g(e,!0);return p}if(c="executeForExtent"!==a&&this._canDoClientSideQuery(f))return p._pendingDfd=x(this._doQuery(f,c,"executeForIds"===a||"executeForCount"===
a)),p._pendingDfd.then(function(b){switch(a){case "execute":e=new X;e.features=b;break;case "executeForIds":e=b;break;case "executeForCount":e=b.length}g(e,!0)}),p}if(this._collection)return this._resolve([Error("FeatureLayer::_query - "+this.invalidParams)],null,l,p,!0),p;this._ts&&(f._ts=(new Date).getTime());(p._pendingDfd=this._task[a](f)).addCallbacks(function(a){g(a,!!f.outStatistics)},function(a){h._resolve([a],null,l,p,!0)});return p},_convertFeaturesToJson:function(a,b,c,d){var l=[],h=this._selectionSymbol,
q=this.visibilityField,f,p=this.objectIdField;if(this.loaded&&(c||d))f=e.filter(this.fields,function(a){return!1===a.editable&&(!d||a.name!==p)});for(c=0;c<a.length;c++){var g=a[c],t={},v=g.geometry,n=g.attributes,z=g.symbol;if(v&&(!d||!this.loaded||this.allowGeometryUpdates))t.geometry=v.toJson();q?(t.attributes=n=s.mixin({},n),n[q]=g.visible?1:0):n&&(t.attributes=s.mixin({},n));t.attributes&&(f&&f.length)&&e.forEach(f,function(a){delete t.attributes[a.name]});z&&z!==h&&(t.symbol=z.toJson());l.push(t)}return b?
l:w.toJson(l)},_selectHandler:function(a,b,c,d,l){var h;d=K;switch(b){case d.SELECTION_NEW:this.clearSelection(!0);h=!0;break;case d.SELECTION_ADD:h=!0;break;case d.SELECTION_SUBTRACT:h=!1}d=a.features;var q=this._mode,f=[],p=this.objectIdField,g,t;if(h)for(h=0;h<d.length;h++)g=d[h],t=g.attributes[p],g=q._addFeatureIIf(t,g),f.push(g),this._selectFeatureIIf(t,g,q);else for(h=0;h<d.length;h++)g=d[h],t=g.attributes[p],this._unSelectFeatureIIf(t,q),t=q._removeFeatureIIf(t),f.push(t||g);this._isSelOnly&&
q._applyTimeFilter(!0);this._resolve([f,b,a.exceededTransferLimit?{queryLimitExceeded:!0}:null],"onSelectionComplete",c,l);if(a.exceededTransferLimit)this.onQueryLimitExceeded()},_selectFeatureIIf:function(a,b,c){var d=this._selectedFeatures,l=d[a];l||(c._incRefCount(a),d[a]=b,this._isTable||(this._setSelectSymbol(b),b.attr("data-selected","")));return l||b},_unSelectFeatureIIf:function(a,b){var c=this._selectedFeatures[a];c&&(b._decRefCount(a),delete this._selectedFeatures[a],this._isTable||(this._setUnSelectSymbol(c),
c.attr("data-selected")));return c},_isSelected:function(a){},_setSelectSymbol:function(a){var b=this._selectionSymbol;b&&!this._isSelOnly&&a.setSymbol(b)},_setUnSelectSymbol:function(a){var b=this._selectionSymbol;b&&!this._isSelOnly&&b===a.symbol&&a.setSymbol(null,!0)},_getOutFields:function(){var a=[this.objectIdField,this.typeIdField,this.creatorField,this._startTimeField,this._endTimeField,this._trackIdField].concat(this._rendererFields).concat(this.dataAttributes),a=e.filter(a,function(a,b,
c){return!!a&&e.indexOf(c,a)===b}),b=s.clone(this._outFields);if(b){if(-1!==e.indexOf(b,"*"))return b;e.forEach(a,function(a){-1===e.indexOf(b,a)&&b.push(a)});return b}return a},_checkFields:function(a){var b=a||this._getOutFields();e.forEach(b,function(a){"*"!==a&&(this._getField(a)||console.debug("esri.layers.FeatureLayer: "+q.substitute({url:this.url,field:a},"unable to find '${field}' field in the layer 'fields' information [url: ${url}]")))},this);!a&&(!this._isTable&&!this._fserver&&!this._collection&&
!this._isStream)&&(e.some(this.fields,function(a){return a&&"esriFieldTypeGeometry"===a.type?!0:!1})||console.debug("esri.layers.FeatureLayer: "+q.substitute({url:this.url},"unable to find a field of type 'esriFieldTypeGeometry' in the layer 'fields' information. If you are using a map service layer, features will not have geometry [url: ${url}]")))},_fixFieldCase:function(a,b,c){var d=a&&a[b],l;if(d&&!s.isFunction(d)){if(l=!this._getField(d)&&this._getField(d,!0))d=a[b]=l.name;c&&c.push(d)}return d},
_fixRendererFields:function(){var a=this.renderer;this._orderBy=null;if(a&&0<this.fields.length){var b=[],c,a=e.filter([a,a.observationRenderer,a.latestObservationRenderer,a.trackRenderer],q.isDefined),d=[].concat(a);e.forEach(a,function(a){e.forEach(a.rendererInfos,function(a){a.renderer&&d.push(a.renderer)})});e.forEach(d,function(a){this._fixFieldCase(a,"attributeField",b);this._fixFieldCase(a,"attributeField2",b);this._fixFieldCase(a,"attributeField3",b);this._fixFieldCase(a.rotationInfo,"field",
b);if((c=this._fixFieldCase(a.sizeInfo,"field",b))&&!this._orderBy)this._orderBy=[c+" DESC"];this._fixFieldCase(a.sizeInfo,"normalizationField",b);this._fixFieldCase(a.colorInfo,"field",b);this._fixFieldCase(a.colorInfo,"normalizationField",b);this._fixFieldCase(a.field,"field",b);this._fixFieldCase(a.opacityInfo,"field",b);this._fixFieldCase(a.opacityInfo,"normalizationField",b);e.forEach(a.visualVariables,function(a){c=this._fixFieldCase(a,"field",b);"sizeInfo"===a.type&&(c&&!this._orderBy)&&(this._orderBy=
[c+" DESC"]);this._fixFieldCase(a,"normalizationField",b)},this);if(!this._orderBy&&a.addBreak&&!s.isFunction(a.attributeField)&&(a.backgroundFillSymbol||this._hasSizeDiff(a)))this._orderBy=[a.attributeField+" DESC"]},this);this._rendererFields=e.filter(b,q.isDefined)}},_hasSizeDiff:function(a){var b=Number.MAX_VALUE,c=-Number.MAX_VALUE,d,l;e.forEach(a.infos,function(a){if(l=a.symbol){d=0;switch(l.type){case "simplemarkersymbol":d=l.size;break;case "picturemarkersymbol":d=(l.width+l.height)/2;break;
case "simplelinesymbol":case "cartographiclinesymbol":d=l.width;break;case "simplefillsymbol":case "picturefillsymbol":d=l.outline&&l.outline.width}d&&(b=Math.min(b,d),c=Math.max(c,d))}});return b!==Number.MAX_VALUE&&c!==-Number.MAX_VALUE&&1<Math.abs(c-b)},getOrderByFields:function(){var a=this.orderByFields||this._orderBy;return this.supportsAdvancedQueries&&a?e.filter(a,function(a){a=a.split(" ")[0];return!!this._getField(a,!0)},this):null},_getField:function(a,b){var c=this.fields;if(!c||0===c.length)return null;
var d;b&&(a=a.toLowerCase());e.some(c,function(c){var l=!1;(l=b?c&&c.name.toLowerCase()===a?!0:!1:c&&c.name===a?!0:!1)&&(d=c);return l});return d},_getDateOpts:function(){this._dtOpts||(this._dtOpts={properties:e.map(e.filter(this.fields,function(a){return!!(a&&"esriFieldTypeDate"===a.type)}),function(a){return a.name})});return this._dtOpts},_applyNormalized:function(a,b){a&&b&&e.forEach(a,function(a,c){a&&b[c]&&a.setGeometry(b[c])})},_editHandler:function(a,b,c,d,l,h){l=a.addResults;var q=a.updateResults;
a=a.deleteResults;var f,p,g,t,n=this.objectIdField,v=this._mode,z=this._isTable;f=this.editFieldsInfo;var k=this.getOutFields()||[],y=f&&f.creatorField,m=f&&f.creationDateField,D=f&&f.editorField,x=f&&f.editDateField;f=f&&f.realm;-1===e.indexOf(k,"*")&&(y&&-1===e.indexOf(k,y)&&(y=null),m&&-1===e.indexOf(k,m)&&(m=null),D&&-1===e.indexOf(k,D)&&(D=null),x&&-1===e.indexOf(k,x)&&(x=null));var k=m||x?(new Date).getTime():null,u=y||D?this.getUserId():void 0;u&&f&&(u=u+"@"+f);if(l)for(f=0;f<l.length;f++)l[f]=
new G(l[f]),z||(p=l[f],p.success&&(p=p.objectId,g=b[f],(t=g._graphicsLayer)&&t!==this&&t.remove(g),t=g.attributes||{},t[n]=p,y&&(t[y]=u),D&&(t[D]=u),m&&(t[m]=k),x&&(t[x]=k),g.setAttributes(t),v._init&&v.drawFeature(g)));if(q)for(f=0;f<q.length;f++)if(q[f]=new G(q[f]),!z&&(p=q[f],p.success)){p=p.objectId;g=c[p];if(b=v._getFeature(p))b.geometry!==g.geometry&&b.setGeometry(A.fromJson(g.geometry.toJson())),this._repaint(b,p);g=b||g;t=g.attributes||{};D&&(t[D]=u);x&&(t[x]=k);g.setAttributes(t)}if(a){c=
[];for(f=0;f<a.length;f++)if(a[f]=new G(a[f]),!z&&(p=a[f],p.success&&(p=p.objectId,g=v._getFeature(p))))this._unSelectFeatureIIf(p,v)&&c.push(g),g._count=0,v._removeFeatureIIf(p);if(0<c.length)this.onSelectionComplete(c,K.SELECTION_SUBTRACT)}this._resolve([l,q,a],"onEditsComplete",d,h)},_sendAttachment:function(a,b,c,d,h){var f=this;return l({url:this._url.path+"/"+b+"/"+("add"===a?"addAttachment":"updateAttachment"),form:c,content:s.mixin(this._url.query,{f:"json",token:this._getToken()||void 0}),
callbackParamName:"callback.html",handleAs:"json"}).addCallback(function(c){var l="add"===a?"onAddAttachmentComplete":"onUpdateAttachmentComplete";c=new G(c["add"===a?"addAttachmentResult":"updateAttachmentResult"]);c.attachmentId=c.objectId;c.objectId=b;f._resolve([c],l,d);return c}).addErrback(function(a){f._resolve([a],null,h,null,!0)})},_repaint:function(a,b,c){b=q.isDefined(b)?b:a.attributes[this.objectIdField];(!(b in this._selectedFeatures)||!this._selectionSymbol)&&a.setSymbol(a.symbol,c)},
_getKind:function(a){var b=this._trackManager;return b?b.isLatestObservation(a)?1:0:0}});s.mixin(K,{MODE_SNAPSHOT:0,MODE_ONDEMAND:1,MODE_SELECTION:2,SELECTION_NEW:3,SELECTION_ADD:4,SELECTION_SUBTRACT:5,MODE_AUTO:6,MODE_STREAM:7,POPUP_NONE:"esriServerHTMLPopupTypeNone",POPUP_HTML_TEXT:"esriServerHTMLPopupTypeAsHTMLText",POPUP_URL:"esriServerHTMLPopupTypeAsURL"});E._createWrappers(K);g("extend-esri")&&s.setObject("layers.FeatureLayer",K,a);return K})},"dojo/touch":function(){define("./_base/kernel ./aspect ./dom ./dom-class ./_base/lang ./on ./has ./mouse ./domReady ./_base/window".split(" "),
function(r,m,k,u,s,e,w,n,b,g){function d(a,b,c){return h&&c?function(a,b){return e(a,c,b)}:q?function(c,d){var l=e(c,b,function(a){d.call(this,a);C=(new Date).getTime()}),h=e(c,a,function(a){(!C||(new Date).getTime()>C+1E3)&&d.call(this,a)});return{remove:function(){l.remove();h.remove()}}}:function(b,c){return e(b,a,c)}}function f(a){do if(void 0!==a.dojoClick)return a;while(a=a.parentNode)}function c(a,b,c){var d=f(a.target);if(v=!a.target.disabled&&d&&d.dojoClick)if(y=(t="useTarget"==v)?d:a.target,
t&&a.preventDefault(),p=a.changedTouches?a.changedTouches[0].pageX-g.global.pageXOffset:a.clientX,z=a.changedTouches?a.changedTouches[0].pageY-g.global.pageYOffset:a.clientY,D=("object"==typeof v?v.x:"number"==typeof v?v:0)||4,S=("object"==typeof v?v.y:"number"==typeof v?v:0)||4,!l){l=!0;var h=function(a){v=t?k.isDescendant(g.doc.elementFromPoint(a.changedTouches?a.changedTouches[0].pageX-g.global.pageXOffset:a.clientX,a.changedTouches?a.changedTouches[0].pageY-g.global.pageYOffset:a.clientY),y):
v&&(a.changedTouches?a.changedTouches[0].target:a.target)==y&&Math.abs((a.changedTouches?a.changedTouches[0].pageX-g.global.pageXOffset:a.clientX)-p)<=D&&Math.abs((a.changedTouches?a.changedTouches[0].pageY-g.global.pageYOffset:a.clientY)-z)<=S};g.doc.addEventListener(b,function(a){h(a);t&&a.preventDefault()},!0);g.doc.addEventListener(c,function(a){h(a);if(v){N=(new Date).getTime();var b=t?y:a.target;"LABEL"===b.tagName&&(b=k.byId(b.getAttribute("for"))||b);var c=a.changedTouches?a.changedTouches[0]:
a,d=document.createEvent("MouseEvents");d._dojo_click=!0;d.initMouseEvent("click",!0,!0,a.view,a.detail,c.screenX,c.screenY,c.clientX,c.clientY,a.ctrlKey,a.altKey,a.shiftKey,a.metaKey,0,null);setTimeout(function(){e.emit(b,"click",d);N=(new Date).getTime()},0)}},!0);a=function(a){g.doc.addEventListener(a,function(b){!b._dojo_click&&((new Date).getTime()<=N+1E3&&!("INPUT"==b.target.tagName&&u.contains(b.target,"dijitOffScreen")))&&(b.stopPropagation(),b.stopImmediatePropagation&&b.stopImmediatePropagation(),
"click"==a&&(("INPUT"!=b.target.tagName||"radio"==b.target.type||"checkbox"==b.target.type)&&"TEXTAREA"!=b.target.tagName&&"AUDIO"!=b.target.tagName&&"VIDEO"!=b.target.tagName)&&b.preventDefault())},!0)};a("click");a("mousedown");a("mouseup")}}var x=5>w("ios"),h=w("pointer-events")||w("MSPointer"),a=function(){var a={},b;for(b in{down:1,move:1,up:1,cancel:1,over:1,out:1})a[b]=w("MSPointer")?"MSPointer"+b.charAt(0).toUpperCase()+b.slice(1):"pointer"+b;return a}(),q=w("touch-events"),l,v,t=!1,y,p,z,
D,S,N,C,H;h?b(function(){g.doc.addEventListener(a.down,function(b){c(b,a.move,a.up)},!0)}):q&&b(function(){function a(b){var c=s.delegate(b,{bubbles:!0});6<=w("ios")&&(c.touches=b.touches,c.altKey=b.altKey,c.changedTouches=b.changedTouches,c.ctrlKey=b.ctrlKey,c.metaKey=b.metaKey,c.shiftKey=b.shiftKey,c.targetTouches=b.targetTouches);return c}H=g.body();g.doc.addEventListener("touchstart",function(a){C=(new Date).getTime();var b=H;H=a.target;e.emit(b,"dojotouchout",{relatedTarget:H,bubbles:!0});e.emit(H,
"dojotouchover",{relatedTarget:b,bubbles:!0});c(a,"touchmove","touchend")},!0);e(g.doc,"touchmove",function(b){C=(new Date).getTime();var c=g.doc.elementFromPoint(b.pageX-(x?0:g.global.pageXOffset),b.pageY-(x?0:g.global.pageYOffset));c&&(H!==c&&(e.emit(H,"dojotouchout",{relatedTarget:c,bubbles:!0}),e.emit(c,"dojotouchover",{relatedTarget:H,bubbles:!0}),H=c),e.emit(c,"dojotouchmove",a(b))||b.preventDefault())});e(g.doc,"touchend",function(b){C=(new Date).getTime();var c=g.doc.elementFromPoint(b.pageX-
(x?0:g.global.pageXOffset),b.pageY-(x?0:g.global.pageYOffset))||g.body();e.emit(c,"dojotouchend",a(b))})});m={press:d("mousedown","touchstart",a.down),move:d("mousemove","dojotouchmove",a.move),release:d("mouseup","dojotouchend",a.up),cancel:d(n.leave,"touchcancel",h?a.cancel:null),over:d("mouseover","dojotouchover",a.over),out:d("mouseout","dojotouchout",a.out),enter:n._eventHandler(d("mouseover","dojotouchover",a.over)),leave:n._eventHandler(d("mouseout","dojotouchout",a.out))};return r.touch=m})},
"dijit/_WidgetsInTemplateMixin":function(){define(["dojo/_base/array","dojo/aspect","dojo/_base/declare","dojo/_base/lang","dojo/parser"],function(r,m,k,u,s){return k("dijit._WidgetsInTemplateMixin",null,{_earlyTemplatedStartup:!1,widgetsInTemplate:!0,contextRequire:null,_beforeFillContent:function(){if(this.widgetsInTemplate){var e=this.domNode;this.containerNode&&!this.searchContainerNode&&(this.containerNode.stopParser=!0);s.parse(e,{noStart:!this._earlyTemplatedStartup,template:!0,inherited:{dir:this.dir,
lang:this.lang,textDir:this.textDir},propsThis:this,contextRequire:this.contextRequire,scope:"dojo"}).then(u.hitch(this,function(e){this._startupWidgets=e;for(var n=0;n<e.length;n++)this._processTemplateNode(e[n],function(b,g){return b[g]},function(b,g,d){return g in b?b.connect(b,g,d):b.on(g,d,!0)});this.containerNode&&this.containerNode.stopParser&&delete this.containerNode.stopParser}));if(!this._startupWidgets)throw Error(this.declaredClass+": parser returned unfilled promise (probably waiting for module auto-load), unsupported by _WidgetsInTemplateMixin.   Must pre-load all supporting widgets before instantiation.");
}},_processTemplateNode:function(e,k,n){return k(e,"dojoType")||k(e,"data-dojo-type")?!0:this.inherited(arguments)},startup:function(){r.forEach(this._startupWidgets,function(e){e&&(!e._started&&e.startup)&&e.startup()});this._startupWidgets=null;this.inherited(arguments)}})})},"esri/layers/RenderMode":function(){define("dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has dojo/io/script ../kernel".split(" "),function(r,m,k,u,s,e,w){m=m(null,{declaredClass:"esri.layers._RenderMode",
constructor:function(){this._prefix="jsonp_"+(r._scopeName||"dojo")+"IoScript"},initialize:function(e){this.map=e;this._init=!0},startup:function(){},propertyChangeHandler:function(e){},destroy:function(){this._init=!1},drawFeature:function(e){},suspend:function(){},resume:function(){},refresh:function(){},_incRefCount:function(e){(e=this._featureMap[e])&&e._count++},_decRefCount:function(e){(e=this._featureMap[e])&&e._count--},_getFeature:function(e){return this._featureMap[e]},_addFeatureIIf:function(e,
b){var g=this._featureMap,d=g[e],f=this.featureLayer;d||(g[e]=b,f._add(b),b._count=0);return d||b},_removeFeatureIIf:function(e){var b=this._featureMap[e],g=this.featureLayer;if(b){if(b._count)return;delete this._featureMap[e];g._remove(b)}return b},_clearIIf:function(){var e;e=this.featureLayer;var b=e.graphics,g=e._selectedFeatures,d=e.objectIdField;for(e=b.length-1;0<=e;e--){var f=b[e],c=f.attributes[d];c in g?f._count=1:(f._count=0,this._removeFeatureIIf(c))}},_isPending:function(n){return e[this._prefix+
n]?!0:!1},_cancelPendingRequest:function(n,b){if(n=n||e[this._prefix+b])try{n.cancel(),e._validCheck(n)}catch(g){}},_purgeRequests:function(){e._validCheck(null)},_toggleVisibility:function(e){var b=this.featureLayer,g=b.graphics,d=e?"show":"hide",f,c=g.length;e=e&&b._ager;for(f=0;f<c;f++){var k=g[f];k[d]();e&&b._repaint(k)}},_applyTimeFilter:function(e){var b=this.featureLayer;if(b.timeInfo&&!b.suspended){e||b._fireUpdateStart();var g=b._trackManager;g&&g.clearTracks();var d=b.getTimeDefinition(),
f=b._getOffsettedTE(b._mapTimeExtent);f?(f=b._getTimeOverlap(d,f))?(d=b._filterByTime(b.graphics,f.startTime,f.endTime),g&&g.addFeatures(d.match),u.forEach(d.match,function(c){var d=c._shape;c.visible||(c.show(),(d=c._shape)&&d._moveToFront());b._ager&&d&&b._repaint(c)}),u.forEach(d.noMatch,function(b){b.visible&&b.hide()})):this._toggleVisibility(!1):(g&&g.addFeatures(b.graphics),this._toggleVisibility(!0));g&&(g.moveLatestToFront(),g.drawTracks());e||b._fireUpdateEnd()}}});s("extend-esri")&&k.setObject("layers._RenderMode",
m,w);return m})},"esri/layers/FeatureType":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../lang ../symbols/jsonUtils ./RangeDomain ./CodedValueDomain ./InheritedDomain ./FeatureTemplate".split(" "),function(r,m,k,u,s,e,w,n,b,g,d){r=r(null,{declaredClass:"esri.layers.FeatureType",constructor:function(f){if(f&&m.isObject(f)){this.id=f.id;this.name=f.name;var c=f.symbol;c&&(this.symbol=w.fromJson(c));var c=f.domains,e,h=this.domains={};for(e in c)if(c.hasOwnProperty(e)){var a=
c[e];switch(a.type){case "range":h[e]=new n(a);break;case "codedValue":h[e]=new b(a);break;case "inherited":h[e]=new g(a)}}if(e=f.templates){c=this.templates=[];for(f=0;f<e.length;f++)c.push(new d(e[f]))}}},toJson:function(){var b={id:this.id,name:this.name,symbol:this.symbol&&this.symbol.toJson()},c,d=this.domains,h=this.templates,a=e.fixJson;if(d){var q=b.domains={};for(c in d)d.hasOwnProperty(c)&&(q[c]=d[c]&&d[c].toJson());a(q)}h&&(b.templates=k.map(h,function(a){return a.toJson()}));return a(b)}});
u("extend-esri")&&m.setObject("layers.FeatureType",r,s);return r})},"esri/layers/TrackManager":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../graphic ../geometry/Polyline ./GraphicsLayer".split(" "),function(r,m,k,u,s,e,w,n){r=r(null,{declaredClass:"esri.layers._TrackManager",constructor:function(b){this.layer=b;this.trackMap={};this.trackLineMap={}},initialize:function(b){this.map=b;var g=this.layer,d=g._getRenderer(),d=d&&d.trackRenderer;if("esriGeometryPoint"===
g.geometryType){var f=this.container=new n._GraphicsLayer({id:g.id+"_tracks",_child:!0});f.loaded=!0;f.onLoad(f);f._setMap(b,g._div);f.setRenderer(d)}},addFeatures:function(b){var g=this.trackMap,d=this.layer,f=d._trackIdField,c=[];k.forEach(b,function(a){var b=a.attributes[f];(g[b]=g[b]||[]).push(a);-1===k.indexOf(c,b)&&c.push(b)});var e=d._startTimeField,h=d.objectIdField,a=function(a,b){var c=a.attributes[e],d=b.attributes[e];return c===d?a.attributes[h]<b.attributes[h]?-1:1:c<d?-1:1};k.forEach(c,
function(b){g[b].sort(a)})},trimTracks:function(b){function g(b){for(b=d[b]||[];b.length>f;)c.push(b.shift())}var d=this.trackMap,f=this.layer.maximumTrackPoints||0,c=[],e;if(!f)return c;if(b)k.forEach(b,function(b){g(b)});else for(e in d)d.hasOwnProperty(e)&&g(e);return c},drawTracks:function(b){function g(a){var b=c[a],g,t,k;t=d.trackLineMap[a];f.remove(t);delete d.trackLineMap[a];if(!b||2>b.length)return!1;t=[];for(g=b.length-1;0<=g;g--)(k=b[g].geometry)&&t.push([k.x,k.y]);b={};b[h]=a;1<t.length&&
(t=new e(new w({paths:[t],spatialReference:n}),null,b),f.add(t),d.trackLineMap[a]=t)}var d=this,f=this.container,c,n,h,a;if(f)if(c=this.trackMap,n=this.map.spatialReference,h=this.layer._trackIdField,b)k.forEach(b,function(a){g(a)});else for(a in c)c.hasOwnProperty(a)&&g(a)},refreshTracks:function(b){function g(a){var b,l;d.drawTracks([a]);if(e&&e.latestObservationRenderer){a=f[a]||[];b=a.length;for(l=0;l<b;l++)c._repaint(a[l],null,!0)}}var d=this,f=this.trackMap,c=this.layer,e=c._getRenderer(),h;
if(b)k.forEach(b,function(a){g(a)});else for(h in f)f.hasOwnProperty(h)&&g(h);this.moveLatestToFront()},moveLatestToFront:function(b){k.forEach(this.getLatestObservations(b),function(b){var d=b._shape;d&&d._moveToFront();this._repaint(b,null,!0)},this.layer)},getLatestObservations:function(b){function g(b){b=c[b];return b[b.length-1]}var d=[],f=this.layer._getRenderer(),c=this.trackMap,e;if(!f.latestObservationRenderer)return d;if(b)k.forEach(b,function(b){d.push(g(b))});else for(e in c)c.hasOwnProperty(e)&&
d.push(g(e));return d},clearTracks:function(b){var g=this.getLatestObservations(b),d=this.container,f;b?k.forEach(b,function(b){delete this.trackMap[b];d&&(f=this.trackLineMap[b],d.remove(f),delete this.trackLineMap[b])},this):(this.trackMap={},this.trackLineMap={},d&&d.clear());k.forEach(g,function(b){this._repaint(b,null,!0)},this.layer)},isLatestObservation:function(b){var g=this.trackMap[b.attributes[this.layer._trackIdField]];return g?g[g.length-1]===b:!1},destroy:function(){var b=this.container;
b&&(b.clear(),b._unsetMap(this.map,this.layer._div));this.map=this.layer=this.trackMap=this.container=null}});u("extend-esri")&&m.setObject("layers._TrackManager",r,s);return r})},"esri/layers/GridLayout":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../SpatialReference ../geometry/Extent ../geometry/Polyline".split(" "),function(r,m,k,u,s,e,w,n){r=r(null,{declaredClass:"esri.layers._GridLayout",constructor:function(b,g,d,f){this.origin=b;this.cellWidth=
g.width;this.cellHeight=g.height;this.mapWidth=d.width;this.mapHeight=d.height;this.srInfo=f},setResolution:function(b){this._resolution=(b.xmax-b.xmin)/this.mapWidth;this.srInfo&&(b=Math.round(2*this.srInfo.valid[1]/this._resolution),b=Math.round(b/this.cellWidth),this._frameStats=[b,0,b-1])},getCellCoordinates:function(b){var g=this._resolution,d=this.origin;return{row:Math.floor((d.y-b.y)/(this.cellHeight*g)),col:Math.floor((b.x-d.x)/(this.cellWidth*g))}},normalize:function(b){var g=this._frameStats;
if(g){var d=g[0],f=g[1],g=g[2];b<f?(b%=d,b=b<f?b+d:b):b>g&&(b%=d)}return b},intersects:function(b,g){var d=this.srInfo;return d?k.some(g._getParts(d),function(d){return b.intersects(d.extent)}):b.intersects(g)},getCellExtent:function(b,g){var d=this._resolution,f=this.origin,c=this.cellWidth,k=this.cellHeight;return new w(g*c*d+f.x,f.y-(b+1)*k*d,(g+1)*c*d+f.x,f.y-b*k*d,new e(f.spatialReference.toJson()))},getLatticeID:function(b){var g=this.getCellCoordinates({x:b.xmin,y:b.ymax}),d=this.getCellCoordinates({x:b.xmax,
y:b.ymin});b=g.row;var f=d.row,g=this.normalize(g.col),d=this.normalize(d.col);return b+"_"+f+"_"+g+"_"+d},sorter:function(b,g){return b<g?-1:1},getCellsInExtent:function(b,g){var d=this.getCellCoordinates({x:b.xmin,y:b.ymax}),f=this.getCellCoordinates({x:b.xmax,y:b.ymin}),c=d.row,e=f.row,d=d.col,f=f.col,h=[],a,q,l,v=[],t=[],k,p,z,m=[];for(a=c;a<=e;a++)for(q=d;q<=f;q++)l=this.normalize(q),b=this.getCellExtent(a,l),h.push({row:a,col:l,extent:b,resolution:this._resolution}),g&&(v.push(b.xmin,b.xmax),
t.push(b.ymin,b.ymax));d=this.normalize(d);f=this.normalize(f);v.sort(this.sorter);t.sort(this.sorter);q=v.length;for(a=q-1;0<=a;a--)a<q-1&&v[a]===v[a+1]&&v.splice(a,1);q=t.length;for(a=q-1;0<=a;a--)a<q-1&&t[a]===t[a+1]&&t.splice(a,1);if(v.length&&t.length){l=v[0];k=v[v.length-1];p=t[0];z=t[t.length-1];q=v.length;for(a=0;a<q;a++)m.push([[v[a],z],[v[a],p]]);q=t.length;for(a=0;a<q;a++)m.push([[l,t[a]],[k,t[a]]]);a=new n({paths:m,spatialReference:this.origin.spatialReference.toJson()});h.push({latticeID:c+
"_"+e+"_"+d+"_"+f,lattice:a,resolution:this._resolution})}return{minRow:c,maxRow:e,minCol:d,maxCol:f,cells:h}}});u("extend-esri")&&m.setObject("layers._GridLayout",r,s);return r})},"dojo/date/stamp":function(){define(["../_base/lang","../_base/array"],function(r,m){var k={};r.setObject("dojo.date.stamp",k);k.fromISOString=function(u,s){k._isoRegExp||(k._isoRegExp=/^(?:(\d{4})(?:-(\d{2})(?:-(\d{2}))?)?)?(?:T(\d{2}):(\d{2})(?::(\d{2})(.\d+)?)?((?:[+-](\d{2}):(\d{2}))|Z)?)?$/);var e=k._isoRegExp.exec(u),
r=null;if(e){e.shift();e[1]&&e[1]--;e[6]&&(e[6]*=1E3);s&&(s=new Date(s),m.forEach(m.map("FullYear Month Date Hours Minutes Seconds Milliseconds".split(" "),function(b){return s["get"+b]()}),function(b,d){e[d]=e[d]||b}));r=new Date(e[0]||1970,e[1]||0,e[2]||1,e[3]||0,e[4]||0,e[5]||0,e[6]||0);100>e[0]&&r.setFullYear(e[0]||1970);var n=0,b=e[7]&&e[7].charAt(0);"Z"!=b&&(n=60*(e[8]||0)+(Number(e[9])||0),"-"!=b&&(n*=-1));b&&(n-=r.getTimezoneOffset());n&&r.setTime(r.getTime()+6E4*n)}return r};k.toISOString=
function(k,m){var e=function(b){return 10>b?"0"+b:b};m=m||{};var r=[],n=m.zulu?"getUTC":"get",b="";"time"!=m.selector&&(b=k[n+"FullYear"](),b=["0000".substr((b+"").length)+b,e(k[n+"Month"]()+1),e(k[n+"Date"]())].join("-"));r.push(b);if("date"!=m.selector){b=[e(k[n+"Hours"]()),e(k[n+"Minutes"]()),e(k[n+"Seconds"]())].join(":");n=k[n+"Milliseconds"]();m.milliseconds&&(b+="."+(100>n?"0":"")+e(n));if(m.zulu)b+="Z";else if("time"!=m.selector)var n=k.getTimezoneOffset(),g=Math.abs(n),b=b+((0<n?"-":"+")+
e(Math.floor(g/60))+":"+e(g%60));r.push(b)}return r.join("T")};return k})},"dijit/_Templated":function(){define("./_WidgetBase ./_TemplatedMixin ./_WidgetsInTemplateMixin dojo/_base/array dojo/_base/declare dojo/_base/lang dojo/_base/kernel".split(" "),function(r,m,k,u,s,e,w){e.extend(r,{waiRole:"",waiState:""});return s("dijit._Templated",[m,k],{widgetsInTemplate:!1,constructor:function(){w.deprecated(this.declaredClass+": dijit._Templated deprecated, use dijit._TemplatedMixin and if necessary dijit._WidgetsInTemplateMixin",
"","2.0")},_processNode:function(e,b){var g=this.inherited(arguments),d=b(e,"waiRole");d&&e.setAttribute("role",d);(d=b(e,"waiState"))&&u.forEach(d.split(/\s*,\s*/),function(b){-1!=b.indexOf("-")&&(b=b.split("-"),e.setAttribute("aria-"+b[0],b[1]))});return g}})})},"esri/dijit/PopupRenderer":function(){define("require dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/_base/kernel dojo/sniff dojo/query dojo/dom dojo/dom-attr dojo/dom-class dojo/dom-construct dojo/dom-style dijit/_Widget dijit/_Templated ../kernel ./_EventedWidget dojo/i18n!../nls/jsapi dojo/NodeList-dom".split(" "),
function(r,m,k,u,s,e,w,n,b,g,d,f,c,x,h,a,q,l){var v=0;m=m([q,x,h],{declaredClass:"esri.dijit._PopupRenderer",constructor:function(){this._nls=u.mixin({},l.widgets.popup)},templateString:"\x3cdiv class\x3d'esriViewPopup'\x3e\x3cdiv class\x3d'mainSection'\x3e\x3cdiv class\x3d'header' dojoAttachPoint\x3d'_title'\x3e\x3c/div\x3e\x3cdiv class\x3d'hzLine'\x3e\x3c/div\x3e\x3cdiv dojoAttachPoint\x3d'_description'\x3e\x3c/div\x3e\x3cdiv class\x3d'break'\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d'attachmentsSection hidden'\x3e\x3cdiv\x3e${_nls.NLS_attach}:\x3c/div\x3e\x3cul dojoAttachPoint\x3d'_attachmentsList'\x3e\x3c/ul\x3e\x3cdiv class\x3d'break'\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d'mediaSection hidden'\x3e\x3cdiv class\x3d'header' dojoAttachPoint\x3d'_mediaTitle'\x3e\x3c/div\x3e\x3cdiv class\x3d'hzLine'\x3e\x3c/div\x3e\x3cdiv class\x3d'caption' dojoAttachPoint\x3d'_mediaCaption'\x3e\x3c/div\x3e\x3cdiv class\x3d'gallery' dojoAttachPoint\x3d'_gallery'\x3e\x3cdiv class\x3d'mediaHandle prev' dojoAttachPoint\x3d'_prevMedia' dojoAttachEvent\x3d'onclick: _goToPrevMedia'\x3e\x3c/div\x3e\x3cdiv class\x3d'mediaHandle next' dojoAttachPoint\x3d'_nextMedia' dojoAttachEvent\x3d'onclick: _goToNextMedia'\x3e\x3c/div\x3e\x3cul class\x3d'summary'\x3e\x3cli class\x3d'image mediaCount hidden' dojoAttachPoint\x3d'_imageCount'\x3e0\x3c/li\x3e\x3cli class\x3d'image mediaIcon hidden'\x3e\x3c/li\x3e\x3cli class\x3d'chart mediaCount hidden' dojoAttachPoint\x3d'_chartCount'\x3e0\x3c/li\x3e\x3cli class\x3d'chart mediaIcon hidden'\x3e\x3c/li\x3e\x3c/ul\x3e\x3cdiv class\x3d'frame' dojoAttachPoint\x3d'_mediaFrame'\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d'editSummarySection hidden' dojoAttachPoint\x3d'_editSummarySection'\x3e\x3cdiv class\x3d'break'\x3e\x3c/div\x3e\x3cdiv class\x3d'break hidden' dojoAttachPoint\x3d'_mediaBreak'\x3e\x3c/div\x3e\x3cdiv class\x3d'editSummary' dojoAttachPoint\x3d'_editSummary'\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e",
showTitle:!0,startup:function(){this.inherited(arguments);this.template.getComponents(this.graphic).then(u.hitch(this,this._handleComponentsSuccess),u.hitch(this,this._handleComponentsError))},destroy:function(){this._dfd&&this._dfd.cancel();this._destroyFrame();this.template=this.graphic=this._nls=this._mediaInfos=this._mediaPtr=this._dfd=null;this.inherited(arguments)},_goToPrevMedia:function(){0>this._mediaPtr-1||(this._mediaPtr--,this._updateUI(),this._displayMedia())},_goToNextMedia:function(){this._mediaPtr+
1!==this._mediaInfos.length&&(this._mediaPtr++,this._updateUI(),this._displayMedia())},_updateUI:function(){var a=this._mediaInfos,b=a.length,c=this.domNode,l=this._prevMedia,h=this._nextMedia;if(1<b){var f=0,q=0;s.forEach(a,function(a){"image"===a.type?f++:-1!==a.type.indexOf("chart")&&q++});f&&(g.set(this._imageCount,"innerHTML",f),e.query(".summary .image",c).removeClass("hidden"));q&&(g.set(this._chartCount,"innerHTML",q),e.query(".summary .chart",c).removeClass("hidden"))}else e.query(".summary",
c).addClass("hidden"),d.add(l,"hidden"),d.add(h,"hidden");a=this._mediaPtr;0===a?d.add(l,"hidden"):d.remove(l,"hidden");a===b-1?d.add(h,"hidden"):d.remove(h,"hidden");this._destroyFrame()},_displayMedia:function(){var a=this._mediaInfos[this._mediaPtr],b=a.title,c=a.caption,l=e.query(".mediaSection .hzLine",this.domNode)[0];g.set(this._mediaTitle,"innerHTML",b);d[b?"remove":"add"](this._mediaTitle,"hidden");g.set(this._mediaCaption,"innerHTML",c);d[c?"remove":"add"](this._mediaCaption,"hidden");d[b&&
c?"remove":"add"](l,"hidden");this._rid=null;if("image"===a.type)this._showImage(a.value);else{var h=this,b=["dojox/charting/Chart2D","dojox/charting/action2d/Tooltip"],c=a.value.theme||this.chartTheme;u.isString(c)&&(c=c.replace(/\./gi,"/"),-1===c.indexOf("/")&&(c="dojox/charting/themes/"+c));c||(c="./Rainbow");b.push(c);try{var f=this._rid=v++;r(b,function(b,c,d){f===h._rid&&(h._rid=null,h._showChart(a.type,a.value,b,c,d))})}catch(q){console.log("PopupRenderer: error loading modules")}}},_preventNewTab:function(a){return(a=
a&&u.trim(a).toLowerCase())&&(0===a.indexOf("mailto:")||0===a.indexOf("tel:"))},_showImage:function(a){d.add(this._mediaFrame,"image");var b=c.get(this._gallery,"height"),l="\x3cimg class\x3d'esriPopupMediaImage' src\x3d'"+a.sourceURL+"' /\x3e";a.linkURL&&(l="\x3ca "+(this._preventNewTab(a.linkURL)?"":"target\x3d'_blank' ")+"href\x3d'"+a.linkURL+"'\x3e"+l+"\x3c/a\x3e");g.set(this._mediaFrame,"innerHTML",l);var h=e.query(".esriPopupMediaImage",this._mediaFrame)[0],f=this,q;q=k.connect(h,"onload",function(){k.disconnect(q);
q=null;f._imageLoaded(h,b)})},_showChart:function(a,b,c,l,h){d.remove(this._mediaFrame,"image");c=this._chart=new c(f.create("div",{"class":"chart"},this._mediaFrame),{margins:{l:4,t:4,r:4,b:4}});h&&c.setTheme(h);switch(a){case "piechart":c.addPlot("default",{type:"Pie",labels:!1});c.addSeries("Series A",b.fields);break;case "linechart":c.addPlot("default",{type:"Markers"});c.addAxis("x",{min:0,majorTicks:!1,minorTicks:!1,majorLabels:!1,minorLabels:!1});c.addAxis("y",{includeZero:!0,vertical:!0,fixUpper:"minor"});
s.forEach(b.fields,function(a,b){a.x=b+1});c.addSeries("Series A",b.fields);break;case "columnchart":c.addPlot("default",{type:"Columns",gap:3});c.addAxis("y",{includeZero:!0,vertical:!0,fixUpper:"minor"});c.addSeries("Series A",b.fields);break;case "barchart":c.addPlot("default",{type:"Bars",gap:3}),c.addAxis("x",{includeZero:!0,fixUpper:"minor",minorLabels:!1}),c.addAxis("y",{vertical:!0,majorTicks:!1,minorTicks:!1,majorLabels:!1,minorLabels:!1}),c.addSeries("Series A",b.fields)}this._action=new l(c);
c.render()},_destroyFrame:function(){this._rid=null;this._chart&&(this._chart.destroy(),this._chart=null);this._action&&(this._action.destroy(),this._action=null);g.set(this._mediaFrame,"innerHTML","")},_imageLoaded:function(a,b){var d=a.height;d<b&&(d=Math.round((b-d)/2),c.set(a,"marginTop",d+"px"))},_attListHandler:function(a,b){if(a===this._dfd){this._dfd=null;var c="";!(b instanceof Error)&&(b&&b.length)&&s.forEach(b,function(a){c+="\x3cli\x3e";c+="\x3ca href\x3d'"+a.url+"' target\x3d'_blank'\x3e"+
(a.name||"[No name]")+"\x3c/a\x3e";c+="\x3c/li\x3e"});g.set(this._attachmentsList,"innerHTML",c||"\x3cli\x3e"+this._nls.NLS_noAttach+"\x3c/li\x3e")}},_handleComponentsSuccess:function(a){if(a){var c=this.showTitle?a.title:"",l=a.description,h=a.fields,f=a.mediaInfos,q=this.domNode,v=this._nls,k=this,n=this.template,m=this.graphic;this._prevMedia.title=v.NLS_prevMedia;this._nextMedia.title=v.NLS_nextMedia;g.set(this._title,"innerHTML",c);c||d.add(this._title,"hidden");!l&&h&&(l="",s.forEach(h,function(a){l+=
"\x3ctr valign\x3d'top'\x3e";l+="\x3ctd class\x3d'attrName'\x3e"+a[0]+"\x3c/td\x3e";l+="\x3ctd class\x3d'attrValue'\x3e"+a[1].replace(/^\s*(https?:\/\/[^\s]+)\s*$/i,"\x3ca target\x3d'_blank' href\x3d'$1' title\x3d'$1'\x3e"+v.NLS_moreInfo+"\x3c/a\x3e")+"\x3c/td\x3e";l+="\x3c/tr\x3e"}),l&&(l="\x3ctable class\x3d'attrTable' cellpadding\x3d'0px' cellspacing\x3d'0px'\x3e"+l+"\x3c/table\x3e"));g.set(this._description,"innerHTML",l);l||d.add(this._description,"hidden");e.query("a",this._description).forEach(function(a){k._preventNewTab(a.href)?
"_blank"===a.target&&g.remove(a,"target"):g.set(a,"target","_blank")});c&&l?e.query(".mainSection .hzLine",q).removeClass("hidden"):c||l?e.query(".mainSection .hzLine",q).addClass("hidden"):e.query(".mainSection",q).addClass("hidden");if(c=this._dfd=n.getAttachments(m))c.addBoth(u.hitch(this,this._attListHandler,c)),g.set(this._attachmentsList,"innerHTML","\x3cli\x3e"+v.NLS_searching+"...\x3c/li\x3e"),e.query(".attachmentsSection",q).removeClass("hidden");f&&f.length&&(e.query(".mediaSection",q).removeClass("hidden"),
b.setSelectable(this._mediaFrame,!1),this._mediaInfos=f,this._mediaPtr=0,this._updateUI(),this._displayMedia());a.editSummary&&(g.set(this._editSummary,"innerHTML",a.editSummary),f&&f.length&&d.remove(this._mediaBreak,"hidden"),d.remove(this._editSummarySection,"hidden"))}},_handleComponentsError:function(a){console.log("PopupRenderer: error loading template",a)}});w("extend-esri")&&u.setObject("dijit._PopupRenderer",m,a);return m})},"esri/layers/MapImageLayer":function(){define("dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/dom-construct dojo/dom-style ../kernel ../config ../sniff ../domUtils ../geometry/Point ../geometry/webMercatorUtils ./layer".split(" "),
function(r,m,k,u,s,e,w,n,b,g,d,f,c){var x=r([c],{declaredClass:"esri.layers.MapImageLayer","-chains-":{constructor:"manual"},constructor:function(b){this.inherited(arguments,[null,b]);this._mapImages=[];var a=k.hitch;this._panStart=a(this,this._panStart);this._pan=a(this,this._pan);this._extentChange=a(this,this._extentChange);this._zoom=a(this,this._zoom);this._zoomStart=a(this,this._zoomStart);this._scale=a(this,this._scale);this._resize=a(this,this._resize);m.connect(this,"onSuspend",this,this._onSuspend);
m.connect(this,"onResume",this,this._onResume);this.loaded=!0;this.onLoad(this)},opacity:1,addImage:function(b){var a=this._mapImages.push(b),a=a-1;b._idx=a;b._layer=this;this._div&&this._createImage(b,a)},removeImage:function(b){if(b){var a=b._idx,c=this._mapImages;if(c[a]===b){delete c[a];if(a=b._node)this._clearEvents(a),a.e_idx=a.e_bl=a.e_tr=a.e_l=a.e_t=a.e_w=a.e_h=null,a.parentNode&&(a.parentNode.removeChild(a),s.destroy(a));b._node=b._idx=b._layer=null}}},removeAllImages:function(){var b=this._mapImages,
a,c=b.length;for(a=0;a<c;a++){var d=b[a];d&&this.removeImage(d)}this._mapImages=[]},getImages:function(){var b=this._mapImages,a=[],c,d=b.length;for(c=0;c<d;c++)b[c]&&a.push(b[c]);return a},setOpacity:function(b){this.opacity!=b&&(this._opacityChanged(this.opacity=b),this.onOpacityChange())},onOpacityChange:function(){},_opacityChanged:function(c){var a=this._div,d,l;if(a)if(!b("ie")||8<b("ie"))e.set(a,"opacity",c);else{l=a.childNodes;d=l.length;for(a=0;a<d;a++)e.set(l[a],"opacity",c)}},_createImage:function(c,
a){var d=s.create("img");e.set(d,{position:"absolute"});8>=b("ie")&&e.set(d,"opacity",this.opacity);c.rotation&&!(9>b("ie"))&&e.set(d,w._css.names.transform,w._css.rotate(360-c.rotation));c._node=d;d.e_idx=a;d.e_layer=this;d.e_load=m.connect(d,"onload",x.prototype._imageLoaded);d.e_error=m.connect(d,"onerror",x.prototype._imageError);d.e_abort=m.connect(d,"onabort",x.prototype._imageError);d.src=c.href},_imageLoaded:function(b,a){var c=a||b.target||b.currentTarget,d=c.e_layer,f=d._mapImages[c.e_idx],
g=d._map;g&&(g.__zooming||g.__panning||!d._sr)?d._standby.push(c):(d._clearEvents(c),f&&f._node===c&&g&&d._attach(f))},_imageError:function(b){b=b.target||b.currentTarget;var a=b.e_layer,c=a._mapImages[b.e_idx];a._clearEvents(b);c&&(c._node=null)},_clearEvents:function(b){var a=m.disconnect;a(b.e_load);a(b.e_error);a(b.e_abort);b.e_load=b.e_error=b.e_abort=b.e_layer=null},_attach:function(b){var a=b.extent,c=a.spatialReference,l=this._sr,g=this._div,e=b._node,k=new d({x:a.xmin,y:a.ymin,spatialReference:c}),
a=new d({x:a.xmax,y:a.ymax,spatialReference:c});l.equals(c)||(l.isWebMercator()&&4326===c.wkid?(k=f.geographicToWebMercator(k),a=f.geographicToWebMercator(a)):c.isWebMercator()&&4326===l.wkid&&(k=f.webMercatorToGeographic(k),a=f.webMercatorToGeographic(a)));e.e_bl=k;e.e_tr=a;b.visible&&(this._setPos(e,g._left,g._top),(this._active||g).appendChild(e))},_setPos:function(b,a,c){var d=b.e_bl,f=b.e_tr,g=this._map,d=g.toScreen(d),f=g.toScreen(f);a=d.x-a;c=f.y-c;var k=Math.abs(f.x-d.x),d=Math.abs(d.y-f.y),
f={width:k+"px",height:d+"px"},p=this._mapImages[b.e_idx];"css-transforms"===g.navigationMode?f[w._css.names.transform]=w._css.translate(a,c)+(p.rotation?" "+w._css.rotate(360-p.rotation):""):(f.left=a+"px",f.top=c+"px");e.set(b,f);b.e_l=a;b.e_t=c;b.e_w=k;b.e_h=d},managedSuspension:!0,_setMap:function(c,a){this.inherited(arguments);var d=this._div=s.create("div",null,a),l=w._css.names,f={position:"absolute"},k=c.__visibleDelta;if(!b("ie")||8<b("ie"))f.opacity=this.opacity;"css-transforms"===c.navigationMode?
(f[l.transform]=w._css.translate(k.x,k.y),e.set(d,f),d._left=k.x,d._top=k.y,f={position:"absolute",width:c.width+"px",height:c.height+"px",overflow:"visible"},this._active=s.create("div",null,d),e.set(this._active,f),this._passive=s.create("div",null,d),e.set(this._passive,f)):(d._left=0,d._top=0,e.set(d,f));this._standby=[];l=this._mapImages;k=l.length;for(f=0;f<k;f++){var n=l[f];n._node||this._createImage(n,n._idx)}g.hide(d);return d},_unsetMap:function(b,a){this._disconnect();var c=this._div;if(c){var d=
this._mapImages,f,g=d.length;for(f=0;f<g;f++){var e=d[f];if(e){var p=e._node;p&&(this._clearEvents(p),p.e_idx=p.e_bl=p.e_tr=p.e_l=p.e_t=p.e_w=p.e_h=null);e._node=null}}a.removeChild(c);s.destroy(c)}this._map=this._div=this._sr=this._active=this._passive=this._standby=null;this.inherited(arguments)},_onSuspend:function(){this._disconnect();g.hide(this._div)},_onResume:function(b){b.firstOccurrence&&(this._sr=this._map.spatialReference,this._processStandbyList());b=this._map;var a=this._div,c=b.__visibleDelta;
"css-transforms"===b.navigationMode&&(a._left=c.x,a._top=c.y,e.set(a,w._css.names.transform,w._css.translate(a._left,a._top)));this._redraw("css-transforms"===b.navigationMode);this._connect(b);g.show(a)},_connect:function(b){if(!this._connections){var a=m.connect,c="css-transforms"===b.navigationMode;this._connections=[a(b,"onPanStart",this._panStart),a(b,"onPan",this._pan),a(b,"onExtentChange",this._extentChange),c&&a(b,"onZoomStart",this._zoomStart),c?a(b,"onScale",this._scale):a(b,"onZoom",this._zoom),
c&&a(b,"onResize",this._resize)]}},_disconnect:function(){this._connections&&(u.forEach(this._connections,m.disconnect),this._connections=null)},_panStart:function(){this._panL=this._div._left;this._panT=this._div._top},_pan:function(b,a){var c=this._div;c._left=this._panL+a.x;c._top=this._panT+a.y;"css-transforms"===this._map.navigationMode?e.set(c,w._css.names.transform,w._css.translate(c._left,c._top)):e.set(c,{left:c._left+"px",top:c._top+"px"})},_extentChange:function(b,a,c){c?this._redraw("css-transforms"===
this._map.navigationMode):a&&this._pan(b,a);this._processStandbyList()},_processStandbyList:function(){var b,a=this._standby;if(a&&a.length)for(b=a.length-1;0<=b;b--)this._imageLoaded(null,a[b]),a.splice(b,1)},_redraw:function(b){if(b){b=this._passive;var a=w._css.names;e.set(b,a.transition,"none");this._moveImages(b,this._active);e.set(b,a.transform,"none")}b=this._active||this._div;var a=this._div._left,c=this._div._top,d,f=b.childNodes.length,g;for(d=0;d<f;d++)g=b.childNodes[d],this._setPos(g,
a,c)},_zoom:function(b,a,c){b=this._div;var d=b._left,f=b._top,g,k=b.childNodes.length,p;for(g=0;g<k;g++){p=b.childNodes[g];var n=p.e_w*a,m=p.e_h*a,u=(c.x-d-p.e_l)*(n-p.e_w)/p.e_w,x=(c.y-f-p.e_t)*(m-p.e_h)/p.e_h,u=isNaN(u)?0:u,x=isNaN(x)?0:x;e.set(p,{left:p.e_l-u+"px",top:p.e_t-x+"px",width:n+"px",height:m+"px"})}},_zoomStart:function(){this._moveImages(this._active,this._passive)},_moveImages:function(b,a){var c=b.childNodes,d;d=c.length;if(0<d)for(d-=1;0<=d;d--)a.appendChild(c[d])},_scale:function(b,
a){var c=w._css.names,d=this._passive;e.set(d,c.transition,a?"none":c.transformName+" "+n.defaults.map.zoomDuration+"ms ease");w._css.matrix(b);e.set(d,c.transform,w._css.matrix(b))},_resize:function(b,a,c){e.set(this._active,{width:a+"px",height:c+"px"});e.set(this._passive,{width:a+"px",height:c+"px"})}});b("extend-esri")&&k.setObject("layers.MapImageLayer",x,w);return x})},"dijit/_AttachMixin":function(){define("require dojo/_base/array dojo/_base/connect dojo/_base/declare dojo/_base/lang dojo/mouse dojo/on dojo/touch ./_WidgetBase".split(" "),
function(r,m,k,u,s,e,w,n,b){var g=s.delegate(n,{mouseenter:e.enter,mouseleave:e.leave,keypress:k._keypress}),d;k=u("dijit._AttachMixin",null,{constructor:function(){this._attachPoints=[];this._attachEvents=[]},buildRendering:function(){this.inherited(arguments);this._attachTemplateNodes(this.domNode);this._beforeFillContent()},_beforeFillContent:function(){},_attachTemplateNodes:function(b){for(var c=b;;)if(1==c.nodeType&&(this._processTemplateNode(c,function(b,c){return b.getAttribute(c)},this._attach)||
this.searchContainerNode)&&c.firstChild)c=c.firstChild;else{if(c==b)break;for(;!c.nextSibling;)if(c=c.parentNode,c==b)return;c=c.nextSibling}},_processTemplateNode:function(b,c,d){var g=!0,a=this.attachScope||this,e=c(b,"dojoAttachPoint")||c(b,"data-dojo-attach-point");if(e)for(var l=e.split(/\s*,\s*/);e=l.shift();)s.isArray(a[e])?a[e].push(b):a[e]=b,g="containerNode"!=e,this._attachPoints.push(e);if(c=c(b,"dojoAttachEvent")||c(b,"data-dojo-attach-event")){e=c.split(/\s*,\s*/);for(l=s.trim;c=e.shift();)if(c){var k=
null;-1!=c.indexOf(":")?(k=c.split(":"),c=l(k[0]),k=l(k[1])):c=l(c);k||(k=c);this._attachEvents.push(d(b,c,s.hitch(a,k)))}}return g},_attach:function(b,c,e){c=c.replace(/^on/,"").toLowerCase();c="dijitclick"==c?d||(d=r("./a11yclick")):g[c]||c;return w(b,c,e)},_detachTemplateNodes:function(){var b=this.attachScope||this;m.forEach(this._attachPoints,function(c){delete b[c]});this._attachPoints=[];m.forEach(this._attachEvents,function(b){b.remove()});this._attachEvents=[]},destroyRendering:function(){this._detachTemplateNodes();
this.inherited(arguments)}});s.extend(b,{dojoAttachEvent:"",dojoAttachPoint:""});return k})},"esri/layers/SnapshotMode":function(){define("dojo/_base/declare dojo/_base/lang dojo/has ../kernel ../SpatialReference ../tasks/query ./RenderMode".split(" "),function(r,m,k,u,s,e,w){r=r([w],{declaredClass:"esri.layers._SnapshotMode",constructor:function(e){this.featureLayer=e;this.pagination=e.queryPagination;this._featureMap={};this._drawFeatures=m.hitch(this,this._drawFeatures);this._queryErrorHandler=
m.hitch(this,this._queryErrorHandler)},startup:function(){this.pagination=this.pagination&&null!=this.featureLayer.maxRecordCount;this.featureLayer._collection?this._applyTimeFilter():this._fetchAll()},propertyChangeHandler:function(e){this._init&&(e?this.featureLayer._collection?console.log("FeatureLayer: layer created by value (from a feature collection) does not support definition expressions and time definitions. Layer id \x3d "+this.featureLayer.id):this._fetchAll():this._applyTimeFilter())},
drawFeature:function(e){var b=e.attributes[this.featureLayer.objectIdField];this._addFeatureIIf(b,e);this._incRefCount(b)},resume:function(){this.propertyChangeHandler(0)},refresh:function(){var e=this.featureLayer;e._collection?(e._fireUpdateStart(),e._refresh(!0),e._fireUpdateEnd()):this._fetchAll()},_getRequestId:function(e){return("_"+e.name+e.layerId+e._ulid).replace(/[^a-zA-Z0-9\_]+/g,"_")},_fetchAll:function(){var e=this.featureLayer;!e._collection&&!e.suspended&&(e._fireUpdateStart(),this._clearIIf(),
this._sendRequest())},_sendRequest:function(k){var b=this.map,g=this.featureLayer,d=g.getDefinitionExpression(),f=new e;f.outFields=g.getOutFields();f.where=d||"1\x3d1";f.returnGeometry=!0;f.outSpatialReference=new s(b.spatialReference.toJson());f.timeExtent=g.getTimeDefinition();f.maxAllowableOffset=g._maxOffset;f.quantizationParameters=g._quantizationParameters;g._ts&&(f._ts=(new Date).getTime());f.orderByFields=g.supportsAdvancedQueries?g.getOrderByFields():null;f.multipatchOption=g.multipatchOption;
this.pagination&&(this._start=f.start=null==k?0:k,f.num=g.maxRecordCount);var c;g._usePatch&&(c=this._getRequestId(g),this._cancelPendingRequest(null,c));g._task.execute(f,this._drawFeatures,this._queryErrorHandler,c)},_drawFeatures:function(e){this._purgeRequests();var b=e.features,g=this.featureLayer,d=g.objectIdField,f,c=b.length,k=e.exceededTransferLimit&&!g._collection,h,a;for(f=0;f<c;f++)h=b[f],a=h.attributes[d],this._addFeatureIIf(a,h),this._incRefCount(a);this._applyTimeFilter(!0);if(!this.pagination||
!k)g._fireUpdateEnd(null,e.exceededTransferLimit?{queryLimitExceeded:!0}:null);k&&(this.pagination&&this._sendRequest(this._start+g.maxRecordCount),g.onQueryLimitExceeded())},_queryErrorHandler:function(e){this._purgeRequests();var b=this.featureLayer;b._errorHandler(e);b._fireUpdateEnd(e)}});k("extend-esri")&&m.setObject("layers._SnapshotMode",r,u);return r})},"esri/layers/SelectionMode":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","../kernel","./RenderMode"],function(r,m,
k,u,s){r=r([s],{declaredClass:"esri.layers._SelectionMode",constructor:function(e){this.featureLayer=e;this._featureMap={}},propertyChangeHandler:function(e){this._init&&0===e&&this._applyTimeFilter()},resume:function(){this.propertyChangeHandler(0)}});k("extend-esri")&&m.setObject("layers._SelectionMode",r,u);return r})},"esri/tasks/Task":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/json dojo/has ../kernel ../deferredUtils ../urlUtils ../Evented".split(" "),function(r,m,k,u,s,
e,w,n){r=r(n,{declaredClass:"esri.tasks._Task",_eventMap:{error:["error"],complete:["result"]},constructor:function(b,e){b&&m.isString(b)&&(this._url=w.urlToObject(this.url=b));e&&e.requestOptions&&(this.requestOptions=e.requestOptions);this.normalization=!0;this._errorHandler=m.hitch(this,this._errorHandler);this.registerConnectEvents()},_useSSL:function(){var b=this._url,e=/^http:/i;this.url&&(this.url=this.url.replace(e,"https:"));b&&b.path&&(b.path=b.path.replace(e,"https:"))},_encode:function(b,
e,d){var f,c,n={},h,a;for(h in b)if("declaredClass"!==h&&(f=b[h],c=typeof f,null!==f&&void 0!==f&&"function"!==c))if(m.isArray(f)){n[h]=[];a=f.length;for(c=0;c<a;c++)n[h][c]=this._encode(f[c])}else"object"===c?f.toJson&&(c=f.toJson(d&&d[h]),"esri.tasks.FeatureSet"===f.declaredClass&&c.spatialReference&&(c.sr=c.spatialReference,delete c.spatialReference),n[h]=e?c:k.toJson(c)):n[h]=f;return n},_successHandler:function(b,g,d,f){g&&this[g].apply(this,b);d&&d.apply(null,b);f&&e._resDfd(f,b)},_errorHandler:function(b,
e,d){this.onError(b);e&&e(b);d&&d.errback(b)},setNormalization:function(b){this.normalization=b},onError:function(){}});u("extend-esri")&&(s.Task=r);return r})},"dojo/DeferredList":function(){define(["./_base/kernel","./_base/Deferred","./_base/array"],function(r,m,k){r.DeferredList=function(u,s,e,r,n){var b=[];m.call(this);var g=this;0===u.length&&!s&&this.resolve([0,[]]);var d=0;k.forEach(u,function(f,c){function k(f,a){b[c]=[f,a];d++;d===u.length&&g.resolve(b)}f.then(function(b){s?g.resolve([c,
b]):k(!0,b)},function(b){e?g.reject(b):k(!1,b);if(r)return null;throw b;})})};r.DeferredList.prototype=new m;r.DeferredList.prototype.gatherResults=function(m){m=new r.DeferredList(m,!1,!0,!1);m.addCallback(function(m){var e=[];k.forEach(m,function(k){e.push(k[1])});return e});return m};return r.DeferredList})},"dijit/_OnDijitClickMixin":function(){define("dojo/on dojo/_base/array dojo/keys dojo/_base/declare dojo/has ./a11yclick".split(" "),function(r,m,k,u,s,e){r=u("dijit._OnDijitClickMixin",null,
{connect:function(k,m,b){return this.inherited(arguments,[k,"ondijitclick"==m?e:m,b])}});r.a11yclick=e;return r})},"dijit/a11yclick":function(){define(["dojo/keys","dojo/mouse","dojo/on","dojo/touch"],function(r,m,k,u){function s(e){if((e.keyCode===r.ENTER||e.keyCode===r.SPACE)&&!/input|button|textarea/i.test(e.target.nodeName))for(e=e.target;e;e=e.parentNode)if(e.dojoClick)return!0}var e;k(document,"keydown",function(k){s(k)?(e=k.target,k.preventDefault()):e=null});k(document,"keyup",function(m){s(m)&&
m.target==e&&(e=null,k.emit(m.target,"click",{cancelable:!0,bubbles:!0,ctrlKey:m.ctrlKey,shiftKey:m.shiftKey,metaKey:m.metaKey,altKey:m.altKey,_origType:m.type}))});var w=function(e,b){e.dojoClick=!0;return k(e,"click",b)};w.click=w;w.press=function(e,b){var g=k(e,u.press,function(d){("mousedown"!=d.type||m.isLeft(d))&&b(d)}),d=k(e,"keydown",function(d){(d.keyCode===r.ENTER||d.keyCode===r.SPACE)&&b(d)});return{remove:function(){g.remove();d.remove()}}};w.release=function(e,b){var g=k(e,u.release,
function(d){("mouseup"!=d.type||m.isLeft(d))&&b(d)}),d=k(e,"keyup",function(d){(d.keyCode===r.ENTER||d.keyCode===r.SPACE)&&b(d)});return{remove:function(){g.remove();d.remove()}}};w.move=u.move;return w})},"dijit/hccss":function(){define(["dojo/dom-class","dojo/hccss","dojo/domReady","dojo/_base/window"],function(r,m,k,u){k(function(){m("highcontrast")&&r.add(u.body(),"dijit_a11y")});return m})},"dijit/_TemplatedMixin":function(){define("dojo/cache dojo/_base/declare dojo/dom-construct dojo/_base/lang dojo/on dojo/sniff dojo/string ./_AttachMixin".split(" "),
function(r,m,k,u,s,e,w,n){var b=m("dijit._TemplatedMixin",n,{templateString:null,templatePath:null,_skipNodeCache:!1,searchContainerNode:!0,_stringRepl:function(b){var d=this.declaredClass,f=this;return w.substitute(b,this,function(b,e){"!"==e.charAt(0)&&(b=u.getObject(e.substr(1),!1,f));if("undefined"==typeof b)throw Error(d+" template:"+e);return null==b?"":"!"==e.charAt(0)?b:this._escapeValue(""+b)},this)},_escapeValue:function(b){return b.replace(/["'<>&]/g,function(b){return{"\x26":"\x26amp;",
"\x3c":"\x26lt;","\x3e":"\x26gt;",'"':"\x26quot;","'":"\x26#x27;"}[b]})},buildRendering:function(){if(!this._rendered){this.templateString||(this.templateString=r(this.templatePath,{sanitize:!0}));var e=b.getCachedTemplate(this.templateString,this._skipNodeCache,this.ownerDocument),d;if(u.isString(e)){if(d=k.toDom(this._stringRepl(e),this.ownerDocument),1!=d.nodeType)throw Error("Invalid template: "+e);}else d=e.cloneNode(!0);this.domNode=d}this.inherited(arguments);this._rendered||this._fillContent(this.srcNodeRef);
this._rendered=!0},_fillContent:function(b){var d=this.containerNode;if(b&&d)for(;b.hasChildNodes();)d.appendChild(b.firstChild)}});b._templateCache={};b.getCachedTemplate=function(e,d,f){var c=b._templateCache,m=e,h=c[m];if(h){try{if(!h.ownerDocument||h.ownerDocument==(f||document))return h}catch(a){}k.destroy(h)}e=w.trim(e);if(d||e.match(/\$\{([^\}]+)\}/g))return c[m]=e;d=k.toDom(e,f);if(1!=d.nodeType)throw Error("Invalid template: "+e);return c[m]=d};e("ie")&&s(window,"unload",function(){var e=
b._templateCache,d;for(d in e){var f=e[d];"object"==typeof f&&k.destroy(f);delete e[d]}});return b})},"esri/tasks/GeometryService":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/json dojo/_base/Deferred dojo/has ../kernel ../request ../deferredUtils ./Task ../geometry/Extent ../geometry/Polyline ../geometry/Polygon ../geometry/Multipoint ../geometry/jsonUtils".split(" "),function(r,m,k,u,s,e,w,n,b,g,d,f,c,x,h){r=r(g,{declaredClass:"esri.tasks.GeometryService",_eventMap:{"areas-and-lengths-complete":["result"],
"auto-complete-complete":["geometries"],"buffer-complete":["geometries"],"convex-hull-complete":["geometry"],"cut-complete":["result"],"densify-complete":["geometries"],"difference-complete":["geometries"],"distance-complete":["distance"],"generalize-complete":["geometries"],"intersect-complete":["geometries"],"label-points-complete":["geometries"],"lengths-complete":["result"],"offset-complete":["geometries"],"project-complete":["geometries"],"relation-complete":["relations"],"reshape-complete":["geometry"],
"simplify-complete":["geometries"],"trim-extend-complete":["geometries"],"union-complete":["geometry"]},constructor:function(a){a=m.hitch;this._projectHandler=a(this,this._projectHandler);this._simplifyHandler=a(this,this._simplifyHandler);this._bufferHandler=a(this,this._bufferHandler);this._areasAndLengthsHandler=a(this,this._areasAndLengthsHandler);this._lengthsHandler=a(this,this._lengthsHandler);this._labelPointsHandler=a(this,this._labelPointsHandler);this._relationHandler=a(this,this._relationHandler);
this._convexHullHandler=a(this,this._convexHullHandler);this._unionHandler=a(this,this._unionHandler);this._autoCompleteHandler=a(this,this._autoCompleteHandler);this._reshapeHandler=a(this,this._reshapeHandler);this._cutHandler=a(this,this._cutHandler);this._intersectHandler=a(this,this._intersectHandler);this._differenceHandler=a(this,this._differenceHandler);this._trimExtendHandler=a(this,this._trimExtendHandler);this._densifyHandler=a(this,this._densifyHandler);this._generalizeHandler=a(this,
this._densifyHandler);this._offsetHandler=a(this,this._offsetHandler);this._distanceHandler=a(this,this._distanceHandler);this._toGeoCoordinateHandler=a(this,this._toGeoCoordinateHandler);this._fromGeoCoordinateHandler=a(this,this._fromGeoCoordinateHandler);this.registerConnectEvents()},_encodeGeometries:function(a){var b=[],c,d=a.length;for(c=0;c<d;c++)b.push(a[c].toJson());return{geometryType:h.getJsonType(a[0]),geometries:b}},_decodeGeometries:function(a,b,c){var d=h.getGeometryType(b);a=a.geometries;
var e=[],f={spatialReference:c.toJson()},g=m.mixin;k.forEach(a,function(a,b){e[b]=new d(g(a,f))});return e},_toProjectGeometry:function(a){var b=a.spatialReference.toJson();return a instanceof d?new c({rings:[[[a.xmin,a.ymin],[a.xmin,a.ymax],[a.xmax,a.ymax],[a.xmax,a.ymin],[a.xmin,a.ymin]]],spatialReference:b}):new f({paths:[[].concat(a.points)],spatialReference:b})},_fromProjectedGeometry:function(a,b,c){return"esriGeometryEnvelope"===b?(a=a.rings[0],new d(a[0][0],a[0][1],a[2][0],a[2][1],c)):new x({points:a.paths[0],
spatialReference:c.toJson()})},project:function(a,c,d,e){var f=m.mixin({},this._url.query,{f:"json"}),g;a.geometries?(e=d,d=c,c=a.outSR,g=a.geometries[0],f=m.mixin(f,a.toJson())):(g=a[0],f=m.mixin(f,{outSR:c.wkid||u.toJson(c.toJson()),inSR:g.spatialReference.wkid||u.toJson(g.spatialReference.toJson()),geometries:u.toJson(this._encodeGeometries(a))}));var p=h.getJsonType(g),k=this._projectHandler,D=this._errorHandler,r=new s(b._dfdCanceller);r._pendingDfd=n({url:this._url.path+"/project",content:f,
callbackParamName:"callback",load:function(a,b){k(a,b,p,c,d,e,r)},error:function(a){D(a,e,r)}});return r},_projectHandler:function(a,b,c,d,e,f,g){try{var h=this._decodeGeometries(a,c,d);this._successHandler([h],"onProjectComplete",e,g)}catch(k){this._errorHandler(k,f,g)}},onProjectComplete:function(){},simplify:function(a,c,d){var e=a[0].spatialReference,f=m.mixin({},this._url.query,{f:"json",sr:e.wkid?e.wkid:u.toJson(e.toJson()),geometries:u.toJson(this._encodeGeometries(a))}),g=h.getJsonType(a[0]),
p=this._simplifyHandler,k=this._errorHandler,D=new s(b._dfdCanceller);D._pendingDfd=n({url:this._url.path+"/simplify",content:f,callbackParamName:"callback",load:function(a,b){p(a,b,g,e,c,d,D)},error:function(a){k(a,d,D)}});return D},_simplifyHandler:function(a,b,c,d,e,f,g){try{var h=this._decodeGeometries(a,c,d);this._successHandler([h],"onSimplifyComplete",e,g)}catch(k){this._errorHandler(k,f,g)}},onSimplifyComplete:function(){},convexHull:function(a,c,d){var e=a[0].spatialReference;a=m.mixin({},
this._url.query,{f:"json",sr:u.toJson(e.toJson()),geometries:u.toJson(this._encodeGeometries(a))});var f=this._convexHullHandler,g=this._errorHandler,p=new s(b._dfdCanceller);p._pendingDfd=n({url:this._url.path+"/convexHull",content:a,callbackParamName:"callback",load:function(a,b){f(a,b,e,c,d,p)},error:function(a){g(a,d,p)}});return p},_convexHullHandler:function(a,b,c,d,e,f){try{var g=h.fromJson(a.geometry).setSpatialReference(c);this._successHandler([g],"onConvexHullComplete",d,f)}catch(k){this._errorHandler(k,
e,f)}},onConvexHullComplete:function(){},union:function(a,c,d){var e=a[0].spatialReference;a=m.mixin({},this._url.query,{f:"json",sr:u.toJson(e.toJson()),geometries:u.toJson(this._encodeGeometries(a))});var f=this._unionHandler,g=this._errorHandler,p=new s(b._dfdCanceller);p._pendingDfd=n({url:this._url.path+"/union",content:a,callbackParamName:"callback",load:function(a,b){f(a,b,e,c,d,p)},error:function(a){g(a,d,p)}});return p},_unionHandler:function(a,b,c,d,e,f){try{var g=h.fromJson(a.geometry).setSpatialReference(c);
this._successHandler([g],"onUnionComplete",d,f)}catch(k){this._errorHandler(k,e,f)}},onUnionComplete:function(){},autoComplete:function(a,c,d,e){var f=a[0].spatialReference;a=m.mixin({},this._url.query,{f:"json",sr:u.toJson(f.toJson()),polygons:u.toJson(this._encodeGeometries(a).geometries),polylines:u.toJson(this._encodeGeometries(c).geometries)});var g=this._autoCompleteHandler,h=this._errorHandler,k=new s(b._dfdCanceller);k._pendingDfd=n({url:this._url.path+"/autoComplete",content:a,callbackParamName:"callback",
load:function(a,b){g(a,b,f,d,e,k)},error:function(a){h(a,e,k)}});return k},_autoCompleteHandler:function(a,b,d,e,f,g){try{var h=a.geometries;a=[];var k,m=h.length;for(k=0;k<m;k++)a[k]=new c({spatialReference:d,rings:h[k].rings});this._successHandler([a],"onAutoCompleteComplete",e,g)}catch(n){this._errorHandler(n,f,g)}},onAutoCompleteComplete:function(){},reshape:function(a,c,d,e){var f=a.spatialReference;a=m.mixin({},this._url.query,{f:"json",sr:u.toJson(f.toJson()),target:u.toJson({geometryType:h.getJsonType(a),
geometry:a.toJson()}),reshaper:u.toJson(c.toJson())});var g=this._reshapeHandler,p=this._errorHandler,k=new s(b._dfdCanceller);k._pendingDfd=n({url:this._url.path+"/reshape",content:a,callbackParamName:"callback",load:function(a,b){g(a,b,f,d,e,k)},error:function(a){p(a,e,k)}});return k},_reshapeHandler:function(a,b,c,d,e,f){try{var g=h.fromJson(a.geometry).setSpatialReference(c);this._successHandler([g],"onReshapeComplete",d,f)}catch(k){this._errorHandler(k,e,f)}},onReshapeComplete:function(){},cut:function(a,
c,d,e){var f=a[0].spatialReference,g=k.map(a,function(a){return a.toJson()});a=m.mixin({},this._url.query,{f:"json",sr:u.toJson(f.toJson()),target:u.toJson({geometryType:h.getJsonType(a[0]),geometries:g}),cutter:u.toJson(c.toJson())});var p=this._cutHandler,z=this._errorHandler,D=new s(b._dfdCanceller);D._pendingDfd=n({url:this._url.path+"/cut",content:a,callbackParamName:"callback",load:function(a,b){p(a,b,f,d,e,D)},error:function(a){z(a,e,D)}});return D},_cutHandler:function(a,b,c,d,e,f){try{var g=
a.geometries,m={};m.cutIndexes=a.cutIndexes;m.geometries=[];k.forEach(g,function(a){m.geometries.push(h.fromJson(a).setSpatialReference(c))});this._successHandler([m],"onCutComplete",d,f)}catch(n){this._errorHandler(n,e,f)}},onCutComplete:function(){},intersect:function(a,c,d,e){var f=a[0].spatialReference;a=m.mixin({},this._url.query,{f:"json",sr:u.toJson(f.toJson()),geometries:u.toJson(this._encodeGeometries(a)),geometry:u.toJson({geometryType:h.getJsonType(c),geometry:c.toJson()})});var g=this._intersectHandler,
k=this._errorHandler,z=new s(b._dfdCanceller);z._pendingDfd=n({url:this._url.path+"/intersect",content:a,callbackParamName:"callback",load:function(a,b){g(a,b,f,d,e,z)},error:function(a){k(a,e,z)}});return z},_intersectHandler:function(a,b,c,d,e,f){try{var g=[];k.forEach(a.geometries,function(a){g.push(h.fromJson(a).setSpatialReference(c))});this._successHandler([g],"onIntersectComplete",d,f)}catch(m){this._errorHandler(m,e,f)}},onIntersectComplete:function(){},difference:function(a,c,d,e){var f=
a[0].spatialReference;a=m.mixin({},this._url.query,{f:"json",sr:u.toJson(f.toJson()),geometries:u.toJson(this._encodeGeometries(a)),geometry:u.toJson({geometryType:h.getJsonType(c),geometry:c.toJson()})});var g=this._differenceHandler,k=this._errorHandler,z=new s(b._dfdCanceller);z._pendingDfd=n({url:this._url.path+"/difference",content:a,callbackParamName:"callback",load:function(a,b){g(a,b,f,d,e,z)},error:function(a){k(a,e,z)}});return z},_differenceHandler:function(a,b,c,d,e,f){try{var g=[];k.forEach(a.geometries,
function(a){g.push(h.fromJson(a).setSpatialReference(c))});this._successHandler([g],"onDifferenceComplete",d,f)}catch(m){this._errorHandler(m,e,f)}},onDifferenceComplete:function(){},buffer:function(a,c,d){var e=m.mixin({},this._url.query,{f:"json"},a.toJson()),f=a.outSpatialReference||a.geometries[0].spatialReference,g=this._bufferHandler,h=this._errorHandler,k=new s(b._dfdCanceller);k._pendingDfd=n({url:this._url.path+"/buffer",content:e,callbackParamName:"callback",load:function(a,b){g(a,b,f,c,
d,k)},error:function(a){h(a,d,k)}});return k},_bufferHandler:function(a,b,d,e,f,g){try{var h=a.geometries;a=[];var k,m=h.length;for(k=0;k<m;k++)a[k]=new c({spatialReference:d,rings:h[k].rings});this._successHandler([a],"onBufferComplete",e,g)}catch(n){this._errorHandler(n,f,g)}},onBufferComplete:function(){},areasAndLengths:function(a,c,d){a=m.mixin({},this._url.query,{f:"json"},a.toJson());var e=this._areasAndLengthsHandler,f=this._errorHandler,g=new s(b._dfdCanceller);g._pendingDfd=n({url:this._url.path+
"/areasAndLengths",content:a,callbackParamName:"callback",load:function(a,b){e(a,b,c,d,g)},error:function(a){f(a,d,g)}});return g},_areasAndLengthsHandler:function(a,b,c,d,e){try{this._successHandler([a],"onAreasAndLengthsComplete",c,e)}catch(f){this._errorHandler(f,d,e)}},onAreasAndLengthsComplete:function(){},lengths:function(a,c,d){a=m.mixin({},this._url.query,{f:"json"},a.toJson());var e=this._lengthsHandler,f=this._errorHandler,g=new s(b._dfdCanceller);g._pendingDfd=n({url:this._url.path+"/lengths",
content:a,callbackParamName:"callback",load:function(a,b){e(a,b,c,d,g)},error:function(a){f(a,d,g)}});return g},_lengthsHandler:function(a,b,c,d,e){try{this._successHandler([a],"onLengthsComplete",c,e)}catch(f){this._errorHandler(f,d,e)}},onLengthsComplete:function(){},labelPoints:function(a,c,d){var e=k.map(a,function(a){return a.toJson()}),f=a[0].spatialReference,e=m.mixin({},this._url.query,{f:"json",sr:f.wkid?f.wkid:u.toJson(f.toJson()),polygons:u.toJson(e)}),g=this._labelPointsHandler,h=this._errorHandler,
z=new s(b._dfdCanceller);z._pendingDfd=n({url:this._url.path+"/labelPoints",content:e,callbackParamName:"callback",load:function(b,e){g(b,e,a,f,c,d,z)},error:function(a){h(a,d,z)}});return z},_labelPointsHandler:function(a,b,c,d,e,f,g){try{var m=[];k.forEach(a.labelPoints,function(a){m.push(h.fromJson(a).setSpatialReference(d))});this._successHandler([m],"onLabelPointsComplete",e,g)}catch(n){this._errorHandler(n,f,g)}},onLabelPointsComplete:function(){},relation:function(a,c,d){a=m.mixin({},this._url.query,
{f:"json"},a.toJson());var e=this._relationHandler,f=this._errorHandler,g=new s(b._dfdCanceller);g._pendingDfd=n({url:this._url.path+"/relation",content:a,callbackParamName:"callback",load:function(a,b){e(a,b,c,d,g)},error:function(a){f(a,d,g)}});return g},_relationHandler:function(a,b,c,d,e){try{this._successHandler([a.relations],"onRelationComplete",c,e)}catch(f){this._errorHandler(f,d,e)}},onRelationComplete:function(){},trimExtend:function(a,c,d){var e=m.mixin({},this._url.query,{f:"json"},a.toJson()),
f=a.sr,g=this._trimExtendHandler,h=this._errorHandler,k=new s(b._dfdCanceller);k._pendingDfd=n({url:this._url.path+"/trimExtend",content:e,callbackParamName:"callback",load:function(a,b){g(a,b,f,c,d,k)},error:function(a){h(a,d,k)}});return k},_trimExtendHandler:function(a,b,c,d,e,g){try{var k=a.geometries;a=[];var h,m=k.length;for(h=0;h<m;h++)a[h]=new f({spatialReference:c,paths:k[h].paths});this._successHandler([a],"onTrimExtendComplete",d,g)}catch(n){this._errorHandler(n,e,g)}},onTrimExtendComplete:function(){},
densify:function(a,c,d){var e=m.mixin({},this._url.query,{f:"json"},a.toJson()),f=a.geometries[0].spatialReference,g=this._densifyHandler,h=this._errorHandler,k=new s(b._dfdCanceller);k._pendingDfd=n({url:this._url.path+"/densify",content:e,callbackParamName:"callback",load:function(a,b){g(a,b,f,c,d,k)},error:function(a){h(a,d,k)}});return k},_densifyHandler:function(a,b,c,d,e,f){try{var g=[];k.forEach(a.geometries,function(a){g.push(h.fromJson(a).setSpatialReference(c))});this._successHandler([g],
"onDensifyComplete",d,f)}catch(m){this._errorHandler(m,e,f)}},onDensifyComplete:function(){},generalize:function(a,c,d){var e=m.mixin({},this._url.query,{f:"json"},a.toJson()),f=a.geometries[0].spatialReference,g=this._generalizeHandler,k=this._errorHandler,h=new s(b._dfdCanceller);h._pendingDfd=n({url:this._url.path+"/generalize",content:e,callbackParamName:"callback",load:function(a,b){g(a,b,f,c,d,h)},error:function(a){k(a,d,h)}});return h},_generalizeHandler:function(a,b,c,d,e,f){try{var g=[];
k.forEach(a.geometries,function(a){g.push(h.fromJson(a).setSpatialReference(c))});this._successHandler([g],"onGeneralizeComplete",d,f)}catch(m){this._errorHandler(m,e,f)}},onGeneralizeComplete:function(){},offset:function(a,c,d){var e=m.mixin({},this._url.query,{f:"json"},a.toJson()),f=a.geometries[0].spatialReference,g=this._offsetHandler,h=this._errorHandler,k=new s(b._dfdCanceller);k._pendingDfd=n({url:this._url.path+"/offset",content:e,callbackParamName:"callback",load:function(a,b){g(a,b,f,c,
d,k)},error:function(a){h(a,d,k)}});return k},_offsetHandler:function(a,b,c,d,e,f){try{var g=[];k.forEach(a.geometries,function(a){g.push(h.fromJson(a).setSpatialReference(c))});this._successHandler([g],"onOffsetComplete",d,f)}catch(m){this._errorHandler(m,e,f)}},onOffsetComplete:function(){},distance:function(a,c,d){var e=m.mixin({},this._url.query,{f:"json"},a.toJson()),f=a.geometry1.spatialReference,g=this._distanceHandler,k=this._errorHandler,h=new s(b._dfdCanceller);h._pendingDfd=n({url:this._url.path+
"/distance",content:e,callbackParamName:"callback",load:function(a,b){g(a,b,f,c,d,h)},error:function(a){k(a,d,h)}});return h},_distanceHandler:function(a,b,c,d,e,f){try{a=a&&a.distance,this._successHandler([a],"onDistanceComplete",d,f)}catch(g){this._errorHandler(g,e,f)}},onDistanceComplete:function(){},toGeoCoordinateString:function(a,c,d){var e={};m.isObject(a.sr)?e.sr=a.sr.wkid||u.toJson(a.sr.toJson()):e.sr=a.sr;e.coordinates=u.toJson(a.coordinates);e.conversionType=a.conversionType||"MGRS";e.conversionMode=
a.conversionMode;e.numOfDigits=a.numOfDigits;e.rounding=a.rounding;e.addSpaces=a.addSpaces;a=m.mixin({},this._url.query,{f:"json"},e);var f=this._toGeoCoordinateHandler,g=this._errorHandler,h=new s(b._dfdCanceller);h._pendingDfd=n({url:this._url.path+"/toGeoCoordinateString",content:a,callbackParamName:"callback",load:function(a,b){f(a,b,c,d,h)},error:function(a){g(a,d,h)}});return h},_toGeoCoordinateHandler:function(a,b,c,d,e){try{this._successHandler([a.strings],"onToGeoCoordinateStringComplete",
c,e)}catch(f){this._errorHandler(f,d,e)}},onToGeoCoordinateStringComplete:function(){},fromGeoCoordinateString:function(a,c,d){var e={};m.isObject(a.sr)?e.sr=a.sr.wkid||u.toJson(a.sr.toJson()):e.sr=a.sr;e.strings=u.toJson(a.strings);e.conversionType=a.conversionType||"MGRS";e.conversionMode=a.conversionMode;a=m.mixin({},this._url.query,{f:"json"},e);var f=this._fromGeoCoordinateHandler,g=this._errorHandler,h=new s(b._dfdCanceller);h._pendingDfd=n({url:this._url.path+"/fromGeoCoordinateString",content:a,
callbackParamName:"callback",load:function(a,b){f(a,b,c,d,h)},error:function(a){g(a,d,h)}});return h},_fromGeoCoordinateHandler:function(a,b,c,d,e){try{this._successHandler([a.coordinates],"onToGeoCoordinateStringComplete",c,e)}catch(f){this._errorHandler(f,d,e)}},onFromGeoCoordinateStringComplete:function(){}});m.mixin(r,{UNIT_METER:9001,UNIT_GERMAN_METER:9031,UNIT_FOOT:9002,UNIT_SURVEY_FOOT:9003,UNIT_CLARKE_FOOT:9005,UNIT_FATHOM:9014,UNIT_NAUTICAL_MILE:9030,UNIT_SURVEY_CHAIN:9033,UNIT_SURVEY_LINK:9034,
UNIT_SURVEY_MILE:9035,UNIT_KILOMETER:9036,UNIT_CLARKE_YARD:9037,UNIT_CLARKE_CHAIN:9038,UNIT_CLARKE_LINK:9039,UNIT_SEARS_YARD:9040,UNIT_SEARS_FOOT:9041,UNIT_SEARS_CHAIN:9042,UNIT_SEARS_LINK:9043,UNIT_BENOIT_1895A_YARD:9050,UNIT_BENOIT_1895A_FOOT:9051,UNIT_BENOIT_1895A_CHAIN:9052,UNIT_BENOIT_1895A_LINK:9053,UNIT_BENOIT_1895B_YARD:9060,UNIT_BENOIT_1895B_FOOT:9061,UNIT_BENOIT_1895B_CHAIN:9062,UNIT_BENOIT_1895B_LINK:9063,UNIT_INDIAN_FOOT:9080,UNIT_INDIAN_1937_FOOT:9081,UNIT_INDIAN_1962_FOOT:9082,UNIT_INDIAN_1975_FOOT:9083,
UNIT_INDIAN_YARD:9084,UNIT_INDIAN_1937_YARD:9085,UNIT_INDIAN_1962_YARD:9086,UNIT_INDIAN_1975_YARD:9087,UNIT_FOOT_1865:9070,UNIT_RADIAN:9101,UNIT_DEGREE:9102,UNIT_ARCMINUTE:9103,UNIT_ARCSECOND:9104,UNIT_GRAD:9105,UNIT_GON:9106,UNIT_MICRORADIAN:9109,UNIT_ARCMINUTE_CENTESIMAL:9112,UNIT_ARCSECOND_CENTESIMAL:9113,UNIT_MIL6400:9114,UNIT_BRITISH_1936_FOOT:9095,UNIT_GOLDCOAST_FOOT:9094,UNIT_INTERNATIONAL_CHAIN:109003,UNIT_INTERNATIONAL_LINK:109004,UNIT_INTERNATIONAL_YARD:109001,UNIT_STATUTE_MILE:9093,UNIT_SURVEY_YARD:109002,
UNIT_50KILOMETER_LENGTH:109030,UNIT_150KILOMETER_LENGTH:109031,UNIT_DECIMETER:109005,UNIT_CENTIMETER:109006,UNIT_MILLIMETER:109007,UNIT_INTERNATIONAL_INCH:109008,UNIT_US_SURVEY_INCH:109009,UNIT_INTERNATIONAL_ROD:109010,UNIT_US_SURVEY_ROD:109011,UNIT_US_NAUTICAL_MILE:109012,UNIT_UK_NAUTICAL_MILE:109013,UNIT_SQUARE_INCHES:"esriSquareInches",UNIT_SQUARE_FEET:"esriSquareFeet",UNIT_SQUARE_YARDS:"esriSquareYards",UNIT_ACRES:"esriAcres",UNIT_SQUARE_MILES:"esriSquareMiles",UNIT_SQUARE_MILLIMETERS:"esriSquareMillimeters",
UNIT_SQUARE_CENTIMETERS:"esriSquareCentimeters",UNIT_SQUARE_DECIMETERS:"esriSquareDecimeters",UNIT_SQUARE_METERS:"esriSquareMeters",UNIT_ARES:"esriAres",UNIT_HECTARES:"esriHectares",UNIT_SQUARE_KILOMETERS:"esriSquareKilometers"});e("extend-esri")&&m.setObject("tasks.GeometryService",r,w);return r})},"dojo/parser":function(){define("require ./_base/kernel ./_base/lang ./_base/array ./_base/config ./dom ./_base/window ./_base/url ./aspect ./promise/all ./date/stamp ./Deferred ./has ./query ./on ./ready".split(" "),
function(r,m,k,u,s,e,w,n,b,g,d,f,c,x,h,a){function q(a){return eval("("+a+")")}function l(a){var b=a._nameCaseMap,c=a.prototype;if(!b||b._extendCnt<t){var b=a._nameCaseMap={},d;for(d in c)"_"!==d.charAt(0)&&(b[d.toLowerCase()]=d);b._extendCnt=t}return b}function v(a,b){var c=a.join();if(!y[c]){for(var d=[],e=0,f=a.length;e<f;e++){var g=a[e];d[d.length]=y[g]=y[g]||k.getObject(g)||~g.indexOf("/")&&(b?b(g):r(g))}e=d.shift();y[c]=d.length?e.createSubclass?e.createSubclass(d):e.extend.apply(e,d):e}return y[c]}
new Date("X");var t=0;b.after(k,"extend",function(){t++},!0);var y={},p={_clearCache:function(){t++;y={}},_functionFromScript:function(a,b){var c="",d="",e=a.getAttribute(b+"args")||a.getAttribute("args"),f=a.getAttribute("with"),e=(e||"").split(/\s*,\s*/);f&&f.length&&u.forEach(f.split(/\s*,\s*/),function(a){c+="with("+a+"){";d+="}"});return new Function(e,c+a.innerHTML+d)},instantiate:function(a,b,c){b=b||{};c=c||{};var d=(c.scope||m._scopeName)+"Type",e="data-"+(c.scope||m._scopeName)+"-",f=e+
"type",g=e+"mixins",h=[];u.forEach(a,function(a){var c=d in b?b[d]:a.getAttribute(f)||a.getAttribute(d);if(c){var e=a.getAttribute(g),c=e?[c].concat(e.split(/\s*,\s*/)):[c];h.push({node:a,types:c})}});return this._instantiate(h,b,c)},_instantiate:function(a,b,c,d){function e(a){!b._started&&!c.noStart&&u.forEach(a,function(a){"function"===typeof a.startup&&!a._started&&a.startup()});return a}a=u.map(a,function(a){var d=a.ctor||v(a.types,c.contextRequire);if(!d)throw Error("Unable to resolve constructor for: '"+
a.types.join()+"'");return this.construct(d,a.node,b,c,a.scripts,a.inherited)},this);return d?g(a).then(e):e(a)},construct:function(a,e,f,g,p,r){function t(a){M&&k.setObject(M,a);for(E=0;E<G.length;E++)b[G[E].advice||"after"](a,G[E].method,k.hitch(a,G[E].func),!0);for(E=0;E<T.length;E++)T[E].call(a);for(E=0;E<Q.length;E++)a.watch(Q[E].prop,Q[E].func);for(E=0;E<U.length;E++)h(a,U[E].event,U[E].func);return a}var s=a&&a.prototype;g=g||{};var v={};g.defaults&&k.mixin(v,g.defaults);r&&k.mixin(v,r);var w;
c("dom-attributes-explicit")?w=e.attributes:c("dom-attributes-specified-flag")?w=u.filter(e.attributes,function(a){return a.specified}):(r=(/^input$|^img$/i.test(e.nodeName)?e:e.cloneNode(!1)).outerHTML.replace(/=[^\s"']+|="[^"]*"|='[^']*'/g,"").replace(/^\s*<[a-zA-Z0-9]*\s*/,"").replace(/\s*>.*$/,""),w=u.map(r.split(/\s+/),function(a){var b=a.toLowerCase();return{name:a,value:"LI"==e.nodeName&&"value"==a||"enctype"==b?e.getAttribute(b):e.getAttributeNode(b).value}}));var y=g.scope||m._scopeName;
r="data-"+y+"-";var A={};"dojo"!==y&&(A[r+"props"]="data-dojo-props",A[r+"type"]="data-dojo-type",A[r+"mixins"]="data-dojo-mixins",A[y+"type"]="dojoType",A[r+"id"]="data-dojo-id");for(var E=0,B,y=[],M,J;B=w[E++];){var F=B.name,I=F.toLowerCase();B=B.value;switch(A[I]||I){case "data-dojo-type":case "dojotype":case "data-dojo-mixins":break;case "data-dojo-props":J=B;break;case "data-dojo-id":case "jsid":M=B;break;case "data-dojo-attach-point":case "dojoattachpoint":v.dojoAttachPoint=B;break;case "data-dojo-attach-event":case "dojoattachevent":v.dojoAttachEvent=
B;break;case "class":v["class"]=e.className;break;case "style":v.style=e.style&&e.style.cssText;break;default:if(F in s||(F=l(a)[I]||F),F in s)switch(typeof s[F]){case "string":v[F]=B;break;case "number":v[F]=B.length?Number(B):NaN;break;case "boolean":v[F]="false"!=B.toLowerCase();break;case "function":""===B||-1!=B.search(/[^\w\.]+/i)?v[F]=new Function(B):v[F]=k.getObject(B,!1)||new Function(B);y.push(F);break;default:I=s[F],v[F]=I&&"length"in I?B?B.split(/\s*,\s*/):[]:I instanceof Date?""==B?new Date(""):
"now"==B?new Date:d.fromISOString(B):I instanceof n?m.baseUrl+B:q(B)}else v[F]=B}}for(w=0;w<y.length;w++)A=y[w].toLowerCase(),e.removeAttribute(A),e[A]=null;if(J)try{J=q.call(g.propsThis,"{"+J+"}"),k.mixin(v,J)}catch(Y){throw Error(Y.toString()+" in data-dojo-props\x3d'"+J+"'");}k.mixin(v,f);p||(p=a&&(a._noScript||s._noScript)?[]:x("\x3e script[type^\x3d'dojo/']",e));var G=[],T=[],Q=[],U=[];if(p)for(E=0;E<p.length;E++)A=p[E],e.removeChild(A),f=A.getAttribute(r+"event")||A.getAttribute("event"),g=
A.getAttribute(r+"prop"),J=A.getAttribute(r+"method"),y=A.getAttribute(r+"advice"),w=A.getAttribute("type"),A=this._functionFromScript(A,r),f?"dojo/connect"==w?G.push({method:f,func:A}):"dojo/on"==w?U.push({event:f,func:A}):v[f]=A:"dojo/aspect"==w?G.push({method:J,advice:y,func:A}):"dojo/watch"==w?Q.push({prop:g,func:A}):T.push(A);a=(p=a.markupFactory||s.markupFactory)?p(v,e,a):new a(v,e);return a.then?a.then(t):t(a)},scan:function(a,b){function d(a){if(!a.inherited){a.inherited={};var b=a.node,c=
d(a.parent),b={dir:b.getAttribute("dir")||c.dir,lang:b.getAttribute("lang")||c.lang,textDir:b.getAttribute(q)||c.textDir},e;for(e in b)b[e]&&(a.inherited[e]=b[e])}return a.inherited}var e=[],g=[],h={},k=(b.scope||m._scopeName)+"Type",l="data-"+(b.scope||m._scopeName)+"-",p=l+"type",q=l+"textdir",l=l+"mixins",n=a.firstChild,t=b.inherited;if(!t){var s=function(a,b){return a.getAttribute&&a.getAttribute(b)||a.parentNode&&s(a.parentNode,b)},t={dir:s(a,"dir"),lang:s(a,"lang"),textDir:s(a,q)},x;for(x in t)t[x]||
delete t[x]}for(var t={inherited:t},w,y;;)if(n)if(1!=n.nodeType)n=n.nextSibling;else if(w&&"script"==n.nodeName.toLowerCase())(F=n.getAttribute("type"))&&/^dojo\/\w/i.test(F)&&w.push(n),n=n.nextSibling;else if(y)n=n.nextSibling;else{var F=n.getAttribute(p)||n.getAttribute(k);x=n.firstChild;if(!F&&(!x||3==x.nodeType&&!x.nextSibling))n=n.nextSibling;else{y=null;if(F){var I=n.getAttribute(l);w=I?[F].concat(I.split(/\s*,\s*/)):[F];try{y=v(w,b.contextRequire)}catch(Y){}y||u.forEach(w,function(a){~a.indexOf("/")&&
!h[a]&&(h[a]=!0,g[g.length]=a)});I=y&&!y.prototype._noScript?[]:null;t={types:w,ctor:y,parent:t,node:n,scripts:I};t.inherited=d(t);e.push(t)}else t={node:n,scripts:w,parent:t};w=I;y=n.stopParser||y&&y.prototype.stopParser&&!b.template;n=x}}else{if(!t||!t.node)break;n=t.node.nextSibling;y=!1;t=t.parent;w=t.scripts}var G=new f;g.length?(c("dojo-debug-messages")&&console.warn("WARNING: Modules being Auto-Required: "+g.join(", ")),(b.contextRequire||r)(g,function(){G.resolve(u.filter(e,function(a){if(!a.ctor)try{a.ctor=
v(a.types,b.contextRequire)}catch(c){}for(var d=a.parent;d&&!d.types;)d=d.parent;var e=a.ctor&&a.ctor.prototype;a.instantiateChildren=!(e&&e.stopParser&&!b.template);a.instantiate=!d||d.instantiate&&d.instantiateChildren;return a.instantiate}))})):G.resolve(e);return G.promise},_require:function(a,b){var c=q("{"+a.innerHTML+"}"),d=[],e=[],g=new f,h=b&&b.contextRequire||r,l;for(l in c)d.push(l),e.push(c[l]);h(e,function(){for(var a=0;a<d.length;a++)k.setObject(d[a],arguments[a]);g.resolve(arguments)});
return g.promise},_scanAmd:function(a,b){var c=new f,d=c.promise;c.resolve(!0);var e=this;x("script[type\x3d'dojo/require']",a).forEach(function(a){d=d.then(function(){return e._require(a,b)});a.parentNode.removeChild(a)});return d},parse:function(a,b){var c;!b&&a&&a.rootNode?(b=a,c=b.rootNode):a&&k.isObject(a)&&!("nodeType"in a)?b=a:c=a;c=c?e.byId(c):w.body();b=b||{};var d=b.template?{template:!0}:{},f=[],g=this,h=this._scanAmd(c,b).then(function(){return g.scan(c,b)}).then(function(a){return g._instantiate(a,
d,b,!0)}).then(function(a){return f=f.concat(a)}).otherwise(function(a){console.error("dojo/parser::parse() error",a);throw a;});k.mixin(f,h);return f}};m.parser=p;s.parseOnLoad&&a(100,p,"parse");return p})},"dijit/_Widget":function(){define("dojo/aspect dojo/_base/config dojo/_base/connect dojo/_base/declare dojo/has dojo/_base/kernel dojo/_base/lang dojo/query dojo/ready ./registry ./_WidgetBase ./_OnDijitClickMixin ./_FocusMixin dojo/uacss ./hccss".split(" "),function(r,m,k,u,s,e,w,n,b,g,d,f,c){function x(){}
function h(a){return function(b,c,d,e){return b&&"string"==typeof c&&b[c]==x?b.on(c.substring(2).toLowerCase(),w.hitch(d,e)):a.apply(k,arguments)}}r.around(k,"connect",h);e.connect&&r.around(e,"connect",h);r=u("dijit._Widget",[d,f,c],{onClick:x,onDblClick:x,onKeyDown:x,onKeyPress:x,onKeyUp:x,onMouseDown:x,onMouseMove:x,onMouseOut:x,onMouseOver:x,onMouseLeave:x,onMouseEnter:x,onMouseUp:x,constructor:function(a){this._toConnect={};for(var b in a)this[b]===x&&(this._toConnect[b.replace(/^on/,"").toLowerCase()]=
a[b],delete a[b])},postCreate:function(){this.inherited(arguments);for(var a in this._toConnect)this.on(a,this._toConnect[a]);delete this._toConnect},on:function(a,b){return this[this._onMap(a)]===x?k.connect(this.domNode,a.toLowerCase(),this,b):this.inherited(arguments)},_setFocusedAttr:function(a){this._focused=a;this._set("focused",a)},setAttribute:function(a,b){e.deprecated(this.declaredClass+"::setAttribute(attr, value) is deprecated. Use set() instead.","","2.0");this.set(a,b)},attr:function(a,
b){return 2<=arguments.length||"object"===typeof a?this.set.apply(this,arguments):this.get(a)},getDescendants:function(){e.deprecated(this.declaredClass+"::getDescendants() is deprecated. Use getChildren() instead.","","2.0");return this.containerNode?n("[widgetId]",this.containerNode).map(g.byNode):[]},_onShow:function(){this.onShow()},onShow:function(){},onHide:function(){},onClose:function(){return!0}});s("dijit-legacy-requires")&&b(0,function(){require(["dijit/_base"])});return r})},"dijit/_FocusMixin":function(){define(["./focus",
"./_WidgetBase","dojo/_base/declare","dojo/_base/lang"],function(r,m,k,u){u.extend(m,{focused:!1,onFocus:function(){},onBlur:function(){},_onFocus:function(){this.onFocus()},_onBlur:function(){this.onBlur()}});return k("dijit._FocusMixin",null,{_focusManager:r})})},"dijit/focus":function(){define("dojo/aspect dojo/_base/declare dojo/dom dojo/dom-attr dojo/dom-class dojo/dom-construct dojo/Evented dojo/_base/lang dojo/on dojo/domReady dojo/sniff dojo/Stateful dojo/_base/window dojo/window ./a11y ./registry ./main".split(" "),
function(r,m,k,u,s,e,w,n,b,g,d,f,c,x,h,a,q){var l,v,t=new (m([f,w],{curNode:null,activeStack:[],constructor:function(){var a=n.hitch(this,function(a){k.isDescendant(this.curNode,a)&&this.set("curNode",null);k.isDescendant(this.prevNode,a)&&this.set("prevNode",null)});r.before(e,"empty",a);r.before(e,"destroy",a)},registerIframe:function(a){return this.registerWin(a.contentWindow,a)},registerWin:function(a,c){var e=this,f=a.document&&a.document.body;if(f){var g=d("pointer-events")?"pointerdown":d("MSPointer")?
"MSPointerDown":d("touch-events")?"mousedown, touchstart":"mousedown",k=b(a.document,g,function(a){if(!a||!(a.target&&null==a.target.parentNode))e._onTouchNode(c||a.target,"mouse")}),l=b(f,"focusin",function(a){if(a.target.tagName){var b=a.target.tagName.toLowerCase();"#document"==b||"body"==b||(h.isFocusable(a.target)?e._onFocusNode(c||a.target):e._onTouchNode(c||a.target))}}),m=b(f,"focusout",function(a){e._onBlurNode(c||a.target)});return{remove:function(){k.remove();l.remove();m.remove();f=k=
l=m=null}}}},_onBlurNode:function(a){a=(new Date).getTime();a<l+100||(this._clearFocusTimer&&clearTimeout(this._clearFocusTimer),this._clearFocusTimer=setTimeout(n.hitch(this,function(){this.set("prevNode",this.curNode);this.set("curNode",null)}),0),this._clearActiveWidgetsTimer&&clearTimeout(this._clearActiveWidgetsTimer),a<v+100||(this._clearActiveWidgetsTimer=setTimeout(n.hitch(this,function(){delete this._clearActiveWidgetsTimer;this._setStack([])}),0)))},_onTouchNode:function(b,d){v=(new Date).getTime();
this._clearActiveWidgetsTimer&&(clearTimeout(this._clearActiveWidgetsTimer),delete this._clearActiveWidgetsTimer);s.contains(b,"dijitPopup")&&(b=b.firstChild);var e=[];try{for(;b;){var f=u.get(b,"dijitPopupParent");if(f)b=a.byId(f).domNode;else if(b.tagName&&"body"==b.tagName.toLowerCase()){if(b===c.body())break;b=x.get(b.ownerDocument).frameElement}else{var g=b.getAttribute&&b.getAttribute("widgetId"),h=g&&a.byId(g);h&&!("mouse"==d&&h.get("disabled"))&&e.unshift(g);b=b.parentNode}}}catch(k){}this._setStack(e,
d)},_onFocusNode:function(a){a&&9!=a.nodeType&&(l=(new Date).getTime(),this._clearFocusTimer&&(clearTimeout(this._clearFocusTimer),delete this._clearFocusTimer),this._onTouchNode(a),a!=this.curNode&&(this.set("prevNode",this.curNode),this.set("curNode",a)))},_setStack:function(b,c){var d=this.activeStack,e=d.length-1,f=b.length-1;if(b[f]!=d[e]){this.set("activeStack",b);var g;for(g=e;0<=g&&d[g]!=b[g];g--)if(e=a.byId(d[g]))e._hasBeenBlurred=!0,e.set("focused",!1),e._focusManager==this&&e._onBlur(c),
this.emit("widget-blur",e,c);for(g++;g<=f;g++)if(e=a.byId(b[g]))e.set("focused",!0),e._focusManager==this&&e._onFocus(c),this.emit("widget-focus",e,c)}},focus:function(a){if(a)try{a.focus()}catch(b){}}}));g(function(){var a=t.registerWin(x.get(document));d("ie")&&b(window,"unload",function(){a&&(a.remove(),a=null)})});q.focus=function(a){t.focus(a)};for(var y in t)/^_/.test(y)||(q.focus[y]="function"==typeof t[y]?n.hitch(t,y):t[y]);t.watch(function(a,b,c){q.focus[a]=c});return t})},"esri/tasks/QueryTask":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/Deferred dojo/_base/json dojo/has ../kernel ../request ../deferredUtils ../geometry/Extent ../geometry/normalizeUtils ./Task ./FeatureSet".split(" "),
function(r,m,k,u,s,e,w,n,b,g,d,f,c){r=r(f,{declaredClass:"esri.tasks.QueryTask",_eventMap:{complete:["featureSet"],"execute-for-count-complete":["count"],"execute-for-ids-complete":["objectIds"],"execute-relationship-query-complete":["featureSets"]},constructor:function(b,c){this._handler=m.hitch(this,this._handler);this._relationshipQueryHandler=m.hitch(this,this._relationshipQueryHandler);this._executeForIdsHandler=m.hitch(this,this._executeForIdsHandler);this._countHandler=m.hitch(this,this._countHandler);
this._extentHandler=m.hitch(this,this._extentHandler);this.source=c&&c.source;this.gdbVersion=c&&c.gdbVersion;this.registerConnectEvents()},__msigns:[{n:"execute",c:4,a:[{i:0,p:["geometry"]}],e:2},{n:"executeForIds",c:3,a:[{i:0,p:["geometry"]}],e:2},{n:"executeForCount",c:3,a:[{i:0,p:["geometry"]}],e:2},{n:"executeForExtent",c:3,a:[{i:0,p:["geometry"]}],e:2}],onComplete:function(){},onExecuteRelationshipQueryComplete:function(){},onExecuteForIdsComplete:function(){},onExecuteForCountComplete:function(){},
onExecuteForExtentComplete:function(){},execute:function(b,c,a,d,e){var f=e.assembly;b=this._encode(m.mixin({},this._url.query,{f:"json"},b.toJson(f&&f[0])));var g=this._handler,k=this._errorHandler;this.source&&(f={source:this.source.toJson()},b.layer=s.toJson(f));this.gdbVersion&&(b.gdbVersion=this.gdbVersion);return n({url:this._url.path+"/query",content:b,callbackParamName:"callback",load:function(b,d){g(b,d,c,a,e.dfd)},error:function(b){k(b,a,e.dfd)},callbackSuffix:d},this.requestOptions)},executeRelationshipQuery:function(c,
d,a){c=this._encode(m.mixin({},this._url.query,{f:"json"},c.toJson()));var e=this._relationshipQueryHandler,f=this._errorHandler;this.gdbVersion&&(c.gdbVersion=this.gdbVersion);var g=new u(b._dfdCanceller);g._pendingDfd=n({url:this._url.path+"/queryRelatedRecords",content:c,callbackParamName:"callback",load:function(b,c){e(b,c,d,a,g)},error:function(b){f(b,a,g)}},this.requestOptions);return g},executeForIds:function(b,c,a,d){var e=d.assembly;b=this._encode(m.mixin({},this._url.query,{f:"json",returnIdsOnly:!0},
b.toJson(e&&e[0])));var f=this._executeForIdsHandler,g=this._errorHandler;this.source&&(e={source:this.source.toJson()},b.layer=s.toJson(e));this.gdbVersion&&(b.gdbVersion=this.gdbVersion);return n({url:this._url.path+"/query",content:b,callbackParamName:"callback",load:function(b,e){f(b,e,c,a,d.dfd)},error:function(b){g(b,a,d.dfd)}},this.requestOptions)},executeForCount:function(b,c,a,d){var e=d.assembly;b=this._encode(m.mixin({},this._url.query,{f:"json",returnIdsOnly:!0,returnCountOnly:!0},b.toJson(e&&
e[0])));var f=this._countHandler,g=this._errorHandler;this.source&&(e={source:this.source.toJson()},b.layer=s.toJson(e));this.gdbVersion&&(b.gdbVersion=this.gdbVersion);return n({url:this._url.path+"/query",content:b,callbackParamName:"callback",load:function(b,e){f(b,e,c,a,d.dfd)},error:function(b){g(b,a,d.dfd)}},this.requestOptions)},executeForExtent:function(b,c,a,d){var e=d.assembly;b=this._encode(m.mixin({},this._url.query,{f:"json",returnExtentOnly:!0,returnCountOnly:!0},b.toJson(e&&e[0])));
var f=this._extentHandler,g=this._errorHandler;this.source&&(e={source:this.source.toJson()},b.layer=s.toJson(e));this.gdbVersion&&(b.gdbVersion=this.gdbVersion);return n({url:this._url.path+"/query",content:b,callbackParamName:"callback",load:function(b,e){f(b,e,c,a,d.dfd)},error:function(b){g(b,a,d.dfd)}},this.requestOptions)},_handler:function(b,d,a,e,f){try{var g=new c(b);this._successHandler([g],"onComplete",a,f)}catch(k){this._errorHandler(k,e,f)}},_relationshipQueryHandler:function(b,d,a,e,
f){try{var g=b.geometryType,m=b.spatialReference,n={};k.forEach(b.relatedRecordGroups,function(a){var b={};b.geometryType=g;b.spatialReference=m;b.features=a.relatedRecords;b=new c(b);if(null!=a.objectId)n[a.objectId]=b;else for(var d in a)a.hasOwnProperty(d)&&"relatedRecords"!==d&&(n[a[d]]=b)});this._successHandler([n],"onExecuteRelationshipQueryComplete",a,f)}catch(p){this._errorHandler(p,e,f)}},_executeForIdsHandler:function(b,c,a,d,e){try{this._successHandler([b.objectIds],"onExecuteForIdsComplete",
a,e)}catch(f){this._errorHandler(f,d,e)}},_countHandler:function(b,c,a,d,e){try{var f,g=b.features,k=b.objectIds;if(k)f=k.length;else{if(g)throw Error("Unable to perform query. Please check your parameters.");f=b.count}this._successHandler([f],"onExecuteForCountComplete",a,e)}catch(m){this._errorHandler(m,d,e)}},_extentHandler:function(b,c,a,d,e){try{b.extent&&(b.extent=new g(b.extent)),this._successHandler([b],"onExecuteForExtentComplete",a,e)}catch(f){this._errorHandler(f,d,e)}}});d._createWrappers(r);
e("extend-esri")&&m.setObject("tasks.QueryTask",r,w);return r})},"dijit/Destroyable":function(){define(["dojo/_base/array","dojo/aspect","dojo/_base/declare"],function(r,m,k){return k("dijit.Destroyable",null,{destroy:function(k){this._destroyed=!0},own:function(){var k=["destroyRecursive","destroy","remove"];r.forEach(arguments,function(s){function e(){n.remove();r.forEach(b,function(b){b.remove()})}var w,n=m.before(this,"destroy",function(b){s[w](b)}),b=[];s.then?(w="cancel",s.then(e,e)):r.forEach(k,
function(g){"function"===typeof s[g]&&(w||(w=g),b.push(m.after(s,g,e,!0)))})},this);return arguments}})})},"esri/layers/FeatureEditResult":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","../kernel"],function(r,m,k,u){r=r(null,{declaredClass:"esri.layers.FeatureEditResult",constructor:function(k){k&&m.isObject(k)&&(this.objectId=k.objectId,this.success=k.success,k.success||(k=k.error,this.error=Error(),this.error.code=k.code,this.error.message=k.description))}});k("extend-esri")&&
m.setObject("layers.FeatureEditResult",r,u);return r})},"dojo/cache":function(){define(["./_base/kernel","./text"],function(r){return r.cache})},"esri/tasks/FeatureSet":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../lang ../graphic ../SpatialReference ../graphicsUtils ../geometry/jsonUtils ../symbols/jsonUtils".split(" "),function(r,m,k,u,s,e,w,n,b,g,d){r=r(null,{declaredClass:"esri.tasks.FeatureSet",constructor:function(b){if(b){m.mixin(this,b);var c=
this.features,e=b.spatialReference,h=g.getGeometryType(b.geometryType),e=this.spatialReference=new n(e);this.geometryType=b.geometryType;b.fields&&(this.fields=b.fields);k.forEach(c,function(a,b){var f=a.geometry&&a.geometry.spatialReference;c[b]=new w(h&&a.geometry?new h(a.geometry):null,a.symbol&&d.fromJson(a.symbol),a.attributes);c[b].geometry&&!f&&c[b].geometry.setSpatialReference(e)});this._hydrate()}else this.features=[]},displayFieldName:null,geometryType:null,spatialReference:null,fieldAliases:null,
toJson:function(d){var c={};this.displayFieldName&&(c.displayFieldName=this.displayFieldName);this.fields&&(c.fields=this.fields);this.spatialReference?c.spatialReference=this.spatialReference.toJson():this.features[0]&&this.features[0].geometry&&(c.spatialReference=this.features[0].geometry.spatialReference.toJson());this.features[0]&&(this.features[0].geometry&&(c.geometryType=g.getJsonType(this.features[0].geometry)),c.features=b._encodeGraphics(this.features,d));c.exceededTransferLimit=this.exceededTransferLimit;
return e.fixJson(c)},_hydrate:function(){var b=this.transform;if(b){var c=this.features,d,e=b.translate[0],a=b.translate[1],g=b.scale[0],k=b.scale[1],m=function(a,b,c){if("esriGeometryPoint"===a)return function(a){a.x=b(a.x);a.y=c(a.y)};if("esriGeometryPolyline"===a||"esriGeometryPolygon"===a)return function(a){a=a.rings||a.paths;var d,e,f,g,k,h,l,m;d=0;for(e=a.length;d<e;d++){k=a[d];f=0;for(g=k.length;f<g;f++)h=k[f],0<f?(l+=h[0],m+=h[1]):(l=h[0],m=h[1]),h[0]=b(l),h[1]=c(m)}};if("esriGeometryEnvelope"===
a)return function(a){a.xmin=b(a.xmin);a.ymin=c(a.ymin);a.xmax=b(a.xmax);a.ymax=c(a.ymax)};if("esriGeometryMultipoint"===a)return function(a){a=a.points;var d,e,f;d=0;for(e=a.length;d<e;d++)f=a[d],f[0]=b(void 0),f[1]=c(void 0)}}(this.geometryType,function(a){return a*g+e},function(b){return a-b*k}),b=0;for(d=c.length;b<d;b++)c[b].geometry&&m(c[b].geometry);this.transform=null}}});u("extend-esri")&&m.setObject("tasks.FeatureSet",r,s);return r})},"esri/layers/FeatureTemplate":function(){define("dojo/_base/declare dojo/_base/lang dojo/has ../kernel ../lang ../graphic".split(" "),
function(r,m,k,u,s,e){r=r(null,{declaredClass:"esri.layers.FeatureTemplate",constructor:function(k){k&&m.isObject(k)&&(this.name=k.name,this.description=k.description,this.drawingTool=k.drawingTool,k=k.prototype,this.prototype=new e(k.geometry,null,k.attributes))},toJson:function(){return s.fixJson({name:this.name,description:this.description,drawingTool:this.drawingTool,prototype:this.prototype&&this.prototype.toJson()})}});m.mixin(r,{TOOL_AUTO_COMPLETE_POLYGON:"esriFeatureEditToolAutoCompletePolygon",
TOOL_CIRCLE:"esriFeatureEditToolCircle",TOOL_ELLIPSE:"esriFeatureEditToolEllipse",TOOL_FREEHAND:"esriFeatureEditToolFreehand",TOOL_LINE:"esriFeatureEditToolLine",TOOL_NONE:"esriFeatureEditToolNone",TOOL_POINT:"esriFeatureEditToolPoint",TOOL_POLYGON:"esriFeatureEditToolPolygon",TOOL_RECTANGLE:"esriFeatureEditToolRectangle",TOOL_ARROW:"esriFeatureEditToolArrow",TOOL_TRIANGLE:"esriFeatureEditToolTriangle",TOOL_LEFT_ARROW:"esriFeatureEditToolLeftArrow",TOOL_RIGHT_ARROW:"esriFeatureEditToolRightArrow",
TOOL_UP_ARROW:"esriFeatureEditToolUpArrow",TOOL_DOWN_ARROW:"esriFeatureEditToolDownArrow"});k("extend-esri")&&m.setObject("layers.FeatureTemplate",r,u);return r})},"esri/tasks/StatisticDefinition":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","../kernel"],function(r,m,k,u){r=r(null,{declaredClass:"esri.tasks.StatisticDefinition",toJson:function(){return{statisticType:this.statisticType,onStatisticField:this.onStatisticField,outStatisticFieldName:this.outStatisticFieldName,maxPointCount:this.maxPointCount,
maxRecordCount:this.maxRecordCount,maxVertexCount:this.maxVertexCount}}});k("extend-esri")&&m.setObject("tasks.StatisticDefinition",r,u);return r})},"esri/dijit/PopupTemplate":function(){define("dojo/_base/declare dojo/_base/lang dojo/has dojo/dom-construct ../kernel ../InfoTemplate ../PopupInfo ./PopupRenderer".split(" "),function(r,m,k,u,s,e,w,n){r=r([e,w],{declaredClass:"esri.dijit.PopupTemplate","-chains-":{constructor:"manual"},chartTheme:null,constructor:function(b,e){m.mixin(this,e);this.initialize(b,
e)},getTitle:function(b){var e;this.info&&(e=this.titleHasRelatedFields?"":this._getPopupValues(b,!0).title);return e||""},getContent:function(b){return this.info?(new n({template:this,graphic:b,chartTheme:this.chartTheme},u.create("div"))).domNode:""}});k("extend-esri")&&m.setObject("dijit.PopupTemplate",r,s);return r})},"*noref":1}});
define("esri/arcgis/utils","require dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/Deferred dojo/_base/json dojo/_base/url dojo/on dojo/DeferredList dojo/dom-construct ../kernel ../config ../lang ../request ../SpatialReference ../map ../urlUtils ../geometry/ScreenPoint ../geometry/Extent ../geometry/webMercatorUtils ../symbols/jsonUtils ../renderers/jsonUtils ../dijit/PopupTemplate ../dijit/Popup ../tasks/query ../tasks/GeometryService ../layers/ArcGISTiledMapServiceLayer ../layers/FeatureLayer dojo/i18n!../nls/jsapi".split(" "),function(r,
m,k,u,s,e,w,n,b,g,d,f,c,x,h,a,q,l,v,t,y,p,z,D,S,N,C,H,$){function O(a){return x({url:L.arcgisUrl+"/"+a.itemId+"/data",content:{f:"json"},callbackParamName:"callback"},{disableIdentityLookup:!0,_preLookup:!0})}function X(a,b){var c={f:"json"};b&&(c.token=b);return x({url:a,content:c,callbackParamName:"callback"},{disableIdentityLookup:!0})}function aa(a){a.itemProperties.layerDefinition&&(a.layerDefinition?(a.layerDefinition.drawingInfo||(a.layerDefinition.drawingInfo=a.itemProperties.layerDefinition.drawingInfo),
c.isDefined(a.layerDefinition.definitionExpression)||(a.layerDefinition.definitionExpression=a.itemProperties.layerDefinition.definitionExpression),c.isDefined(a.layerDefinition.minScale)||(a.layerDefinition.minScale=a.itemProperties.layerDefinition.minScale),c.isDefined(a.layerDefinition.maxScale)||(a.layerDefinition.maxScale=a.itemProperties.layerDefinition.maxScale)):a.layerDefinition=a.itemProperties.layerDefinition);a.itemProperties.popupInfo&&(!a.popupInfo&&!a.disablePopup)&&(a.popupInfo=a.itemProperties.popupInfo);
c.isDefined(a.itemProperties.showLabels)&&!c.isDefined(a.showLabels)&&(a.showLabels=a.itemProperties.showLabels);c.isDefined(a.itemProperties.showLegend)&&!c.isDefined(a.showLegend)&&(a.showLegend=a.itemProperties.showLegend);c.isDefined(a.itemProperties.refreshInterval)&&!c.isDefined(a.refreshInterval)&&(a.refreshInterval=a.itemProperties.refreshInterval)}function P(a){aa(a);a.itemProperties.layerDefinition&&a.layerDefinition&&(!c.isDefined(a.layerDefinition.maximumTrackPoints)&&c.isDefined(a.itemProperties.layerDefinition.maximumTrackPoints)&&
(a.layerDefinition.maximumTrackPoints=a.itemProperties.layerDefinition.maximumTrackPoints),!a.layerDefinition.definitionGeometry&&a.itemProperties.layerDefinition.definitionGeometry&&(a.layerDefinition.definitionGeometry=a.itemProperties.layerDefinition.definitionGeometry));a.itemProperties.purgeOptions&&!a.purgeOptions&&(a.purgeOptions=a.itemProperties.purgeOptions)}function A(a,d){var e=new s,f=a.itemData,g=[],h=[];k.forEach(f.operationalLayers,function(a){if(a.itemId&&!a.type){var b=a.url.toLowerCase();
-1<b.indexOf("/featureserver")||-1<b.indexOf("/mapserver/")?(h.push(a),g.push(O(a))):-1<b.indexOf("/mapserver")&&-1===b.indexOf("/mapserver/")&&(!a.layers||!c.isDefined(a.minScale)&&!c.isDefined(a.maxScale))?(h.push(a),g.push(O(a))):-1<b.indexOf("/imageserver")&&!c.isDefined(a.minScale)&&!c.isDefined(a.maxScale)?(h.push(a),g.push(O(a))):-1<b.indexOf("/streamserver")&&(h.push(a),g.push(O(a)))}});f.baseMap&&f.baseMap.baseMapLayers&&k.forEach(f.baseMap.baseMapLayers,function(a){a.itemId&&(h.push(a),
g.push(O(a)))});if(0<g.length){var l={};(new b(g)).addCallback(function(b){k.forEach(h,function(a,d){var e=b[d][1];if(e&&!(e instanceof Error)&&(l[a.itemId]=e,!a.type)){var f=a.url.toLowerCase();if((-1<f.indexOf("/featureserver")||-1<f.indexOf("/mapserver/"))&&e.layers)k.forEach(e.layers,function(b){if(f.endsWith("/featureserver/"+b.id)||f.endsWith("/mapserver/"+b.id))a.itemProperties=b,aa(a)});else if(-1<f.indexOf("/streamserver"))a.itemProperties=e,P(a);else if(-1<f.indexOf("/mapserver"))e.layers&&
!a.layers&&(a.layers=e.layers),c.isDefined(e.minScale)&&!c.isDefined(a.minScale)&&(a.minScale=e.minScale),c.isDefined(e.maxScale)&&!c.isDefined(a.maxScale)&&(a.maxScale=e.maxScale),c.isDefined(e.refreshInterval)&&!c.isDefined(a.refreshInterval)&&(a.refreshInterval=e.refreshInterval),e.visibleLayers&&!a.visibleLayers&&(a.visibleLayers=e.visibleLayers);else if(-1<f.indexOf("/imageserver")&&(c.isDefined(e.minScale)&&!c.isDefined(a.minScale)&&(a.minScale=e.minScale),c.isDefined(e.maxScale)&&!c.isDefined(a.maxScale)&&
(a.maxScale=e.maxScale),c.isDefined(e.refreshInterval)&&!c.isDefined(a.refreshInterval)&&(a.refreshInterval=e.refreshInterval),e.popupInfo&&(!a.popupInfo&&!a.disablePopup)&&(a.popupInfo=e.popupInfo),e.renderingRule&&!a.renderingRule&&(a.renderingRule=e.renderingRule,e.renderingRule.functionName&&(a.renderingRule.rasterFunction=e.renderingRule.functionName)),e.bandIds&&!a.bandIds&&(a.bandIds=e.bandIds),e.mosaicRule&&!a.mosaicRule&&(a.mosaicRule=e.mosaicRule),e.format&&!a.format&&(a.format=e.format),
c.isDefined(e.compressionQuality)&&!c.isDefined(a.compressionQuality)&&(a.compressionQuality=e.compressionQuality),e.layerDefinition&&e.layerDefinition.definitionExpression&&(!c.isDefined(a.layerDefinition)||!c.isDefined(a.layerDefinition.definitionExpression))))a.layerDefinition=a.layerDefinition||{},a.layerDefinition.definitionExpression=e.layerDefinition.definitionExpression}});a.relatedItemsData=l;e.callback(a)})}else e.callback(a);return e}function E(a,b){var c=new s,e=a.itemData,f=e.baseMap.baseMapLayers[0];
if("BingMapsAerial"===f.type||"BingMapsRoad"===f.type||"BingMapsHybrid"===f.type)if(f.portalUrl&&d.id)delete b.bingMapsKey,d.id.checkSignInStatus(q.urlToObject(L.arcgisUrl).path).then(m.hitch(null,function(a,b,c,d,e){X(f.portalUrl,e.token).then(m.hitch(null,B,a,b,c,d),m.hitch(null,M,a,b,c,d))},a,b,e,c),m.hitch(null,function(a,b,c,d,e){X(f.portalUrl).then(m.hitch(null,B,a,b,c,d),m.hitch(null,M,a,b,c,d))},a,b,e,c));else if(b.bingMapsKey){var g=new V({bingMapsKey:b.bingMapsKey,mapStyle:V.MAP_STYLE_AERIAL});
u.connect(g,"onLoad",m.hitch(this,function(){c.callback([a,b])}));u.connect(g,"onError",function(d){delete b.bingMapsKey;a.itemData=J(e);f=a.itemData.baseMap.baseMapLayers[0];f.errors=[];f.errors.push({message:"The owner of the application has not provided a valid Bing Key for the Bing Map it includes. Switching to Esri layers."});c.callback([a,b])})}else a.itemData=J(e),f=a.itemData.baseMap.baseMapLayers[0],f.errors=[],f.errors.push({message:"The owner of the application has not provided a Bing Key for the Bing Map it includes. Switching to Esri layers."}),
c.callback([a,b]);else c.callback([a,b]);return c}function B(a,b,c,d,e){e.bingKey?(b.bingMapsKey=e.bingKey,e=new V({bingMapsKey:b.bingMapsKey,mapStyle:V.MAP_STYLE_AERIAL}),u.connect(e,"onLoad",m.hitch(this,function(){d.callback([a,b])})),u.connect(e,"onError",function(e){delete b.bingMapsKey;a.itemData=J(c);e=a.itemData.baseMap.baseMapLayers[0];e.errors=[];e.errors.push({message:"The owner of the map has not provided a valid Bing Key for the Bing Map it includes. Switching to Esri layers."});d.callback([a,
b])})):M(a,b,c,d)}function M(a,b,c,d){delete b.bingMapsKey;a.itemData=J(c);c=a.itemData.baseMap.baseMapLayers[0];c.errors=[];c.errors.push({message:"The owner of the map has not provided a Bing Key for the Bing Map it includes. Switching to Esri layers."});d.callback([a,b])}function J(a){a.baseMap="BingMapsAerial"===a.baseMap.baseMapLayers[0].type?{title:"Imagery",baseMapLayers:[{id:"World_Imagery_2017",visibility:!0,opacity:1,url:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"}]}:
"BingMapsRoad"===a.baseMap.baseMapLayers[0].type?{title:"Streets",baseMapLayers:[{id:"World_Street_Map_8421",opacity:1,visibility:!0,url:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer"}]}:{title:"Imagery with Labels",baseMapLayers:[{id:"World_Imagery_6611",opacity:1,visibility:!0,url:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"},{id:"World_Boundaries_and_Places_1145",isReference:!0,opacity:1,visibility:!0,url:"http://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer"}]};
return a}function F(a,b,d,e){var f=a.dynamicLayerInfos||a.layerInfos,g=b.layers;if(g&&f)if(e.usePopupManager){var h;k.forEach(f,function(a){var b=a.id;if(!a.subLayerIds)for(a=0;a<g.length;a++){var c=g[a];if(c.id===b&&c.popupInfo){h||(h={});h[b]={infoTemplate:new d(c.popupInfo),layerUrl:c.layerUrl};break}}});h&&a.setInfoTemplates(h)}else{var l=[],m=[],n=[],p=[],q=[],r=[];k.forEach(f,function(b){var d=b.id;if(!b.subLayerIds&&-1!==k.indexOf(a.visibleLayers,d))for(b=0;b<g.length;b++){var e=g[b];if(e.id===
d){m.push(d);l.push(e.popupInfo);n.push(e.layerUrl||"");e.layerDefinition&&e.layerDefinition.definitionExpression?p.push(e.layerDefinition.definitionExpression):p.push("");q.push(c.isDefined(e.minScale)?e.minScale:null);r.push(c.isDefined(e.maxScale)?e.maxScale:null);break}}});l.length&&(a.__popups=l,a.__popupIds=m,a.__popupUrls=n,a.__popupWhereClauses=p,a.__popupMinScales=q,a.__popupMaxScales=r,a.__resourceInfo=b.resourceInfo)}}function I(a){if(!a)return!1;var b=(new w(L.arcgisUrl)).authority;return-1!==
a.indexOf(".arcgis.com/")||-1!==a.indexOf(b)}function Y(a){return!a?!1:-1!==a.indexOf("/services.arcgisonline.com/")||-1!==a.indexOf("/server.arcgisonline.com/")}function G(a){if("https:"===location.protocol&&(I(a)||Y(a)))a=a.replace("http:","https:");return a}function T(a,b,c){var d=[],e;a.displayLevels||(d=k.map(a.resourceInfo.tileInfo.lods,function(a){return a.level}));a.exclusionAreas&&(e=m.clone(a.exclusionAreas),e=k.map(e,function(a){a.geometry=new v(a.geometry);return a}));d=new C(G(a.url),
{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,displayLevels:a.displayLevels||d,id:a.id,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval,exclusionAreas:e});c.ignorePopups||F(d,a,b,c);return d}function Q(a,b){if(!a||!b||0===b.length)return[];var c=","+b+",",d=[],e,f=",";for(e=0;e<a.length;e++)if(null!==a[e].subLayerIds){if(-1===c.indexOf(","+a[e].id+",")||-1<f.indexOf(","+a[e].id+","))f+=a[e].subLayerIds.toString()+","}else-1<c.indexOf(","+a[e].id+",")&&
-1===f.indexOf(","+a[e].id+",")&&d.push(a[e].id);return d}function U(a,b,c){var d=new Ua;d.format="png24";a.resourceInfo&&(a.resourceInfo.supportedImageFormatTypes&&-1<a.resourceInfo.supportedImageFormatTypes.indexOf("PNG32"))&&(d.format="png32");var d=new Sa(G(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,imageParameters:d,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval}),e=a.visibleLayers;if(!a.visibleLayers){var f="";k.forEach(d.layerInfos,
function(a){a.defaultVisibility&&(f+=(0<f.length?",":"")+a.id)});e=f}if(a.layers&&0<a.layers.length){var g=[],h=[],l,n=[],p,q;k.forEach(a.layers,function(b){b.layerDefinition&&b.layerDefinition.definitionExpression&&(g[b.id]=b.layerDefinition.definitionExpression);if(b.layerDefinition&&b.layerDefinition.source){l=null;q=b.layerDefinition.source;if("mapLayer"===q.type){var c=k.filter(a.resourceInfo.layers,function(a){return a.id===q.mapLayerId});c.length&&(l=m.mixin(c[0],b))}else l=m.mixin({},b);l&&
(l.source=q,delete l.popupInfo,l=new Va(l),a.visibleLayers&&(c="string"==typeof a.visibleLayers?a.visibleLayers.split(","):a.visibleLayers,-1<k.indexOf(c,b.id)?l.defaultVisibility=!0:l.defaultVisibility=!1),h.push(l))}b.layerDefinition&&(b.layerDefinition.source&&b.layerDefinition.drawingInfo)&&(p=new Wa(b.layerDefinition.drawingInfo),n[b.id]=p)},this);0<g.length&&d.setLayerDefinitions(g);0<h.length?(d.setDynamicLayerInfos(h,!0),0<n.length&&d.setLayerDrawingOptions(n,!0)):(e=Q(d.layerInfos,e),d.setVisibleLayers(e))}else e=
Q(d.layerInfos,e),d.setVisibleLayers(e);c.ignorePopups||F(d,a,b,c);return d}function ua(a,b,d){var e=new Xa;e.bandIds=a.bandIds;null!=a.format&&(e.format=a.format,null!=a.compressionQuality&&(e.compressionQuality=a.compressionQuality));if(a.renderingRule&&a.renderingRule.rasterFunction){var f=new Ya(a.renderingRule);e.renderingRule=f}a.mosaicRule&&(f=new Za(a.mosaicRule),e.mosaicRule=f);c.isDefined(a.noData)&&(e.noData=a.noData);c.isDefined(a.noDataInterpretation)&&(e.noDataInterpretation=a.noDataInterpretation);
c.isDefined(a.interpolation)&&(e.interpolation=a.interpolation);e=new $a(G(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,imageServiceParameters:e,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval});a.layerDefinition&&a.layerDefinition.definitionExpression&&e.setDefinitionExpression(a.layerDefinition.definitionExpression,!0);!d.ignorePopups&&a.popupInfo&&e.setInfoTemplate(new b(a.popupInfo));return e}function ba(a,b,d){var e=[102113,102100,
3857],f=d||new h(b[0].layerObject.fullExtent.spatialReference),g=new h(a.resourceInfo.fullExtent.spatialReference);return f.wkt==g.wkt&&(f.wkid==g.wkid||c.isDefined(f.latestWkid)&&f.latestWkid==g.wkid||c.isDefined(g.latestWkid)&&f.wkid==g.latestWkid||c.isDefined(f.latestWkid)&&f.latestWkid==g.latestWkid)||f.wkid&&g.wkid&&k.some(e,function(a){return a===g.wkid})&&k.some(e,function(a){return a===f.wkid})?!0:!1}function ca(a,b){if(!b[0].layerObject.tileInfo)return!1;var c=[];k.forEach(b,function(a){a.baseMapLayer&&
a.layerObject.tileInfo&&(c=c.concat(k.map(a.layerObject.tileInfo.lods,function(a){return a.scale})))});return k.some(a.resourceInfo.tileInfo.lods,function(a){return k.some(c,function(b){return b===a.scale})})}function Z(a,b,f,g,l){var r,s=f._clazz;if("OpenStreetMap"===a.type)r=new ab({id:a.id,opacity:a.opacity,visible:null!==a.visibility&&void 0!==a.visibility?a.visibility:!0});else if("WMS"===a.type){var t=[],w=[];k.forEach(a.layers,function(a){w.push(new bb({name:a.name,title:a.title,legendURL:a.legendURL}));
t.push(a.name)},this);a.visibleLayers&&(t=a.visibleLayers);g={extent:new v(a.extent[0][0],a.extent[0][1],a.extent[1][0],a.extent[1][1],new h({wkid:4326})),layerInfos:w,version:a.version,maxWidth:a.maxWidth,maxHeight:a.maxHeight,getMapURL:a.mapUrl,spatialReferences:a.spatialReferences,title:a.title,copyright:a.copyright,minScale:a.minScale||0,maxScale:a.maxScale||0,format:a.format};r=new cb(a.url,{id:a.id,visibleLayers:t,format:"png",transparent:a.baseMapLayer?!1:!0,opacity:a.opacity,visible:null!==
a.visibility?a.visibility:!0,resourceInfo:g,refreshInterval:a.refreshInterval});r.spatialReference.wkid=g.spatialReferences[0]}else if("KML"===a.type){f=a.url;if(d.id&&(s=d.id.findCredential(q.urlToObject(L.arcgisUrl).path))){var x=L.arcgisUrl.substring(L.arcgisUrl.indexOf("//")+2,L.arcgisUrl.indexOf("/",L.arcgisUrl.indexOf("//")+3)),R=x.split("."),R=R[R.length-2]+"."+R[R.length-1];b=f.indexOf(R);-1<b&&(f="https://"+x+f.substring(b+R.length),f+="?token\x3d"+s.token)}r=new db(f,{id:a.id,visible:null!==
a.visibility?a.visibility:!0,outSR:g,refreshInterval:a.refreshInterval});u.connect(r,"onLoad",function(){(a.opacity||0===a.opacity)&&r.setOpacity(a.opacity);c.isDefined(a.minScale)&&c.isDefined(a.maxScale)&&r.setScaleRange(a.minScale,a.maxScale);a.visibleFolders&&k.forEach(r.folders,function(b){-1<k.indexOf(a.visibleFolders,b.id)?r.setFolderVisibility(b,!0):r.setFolderVisibility(b,!1)},this)})}else"WebTiledLayer"===a.type?(r=new eb(a.templateUrl,{id:a.id,visible:null!==a.visibility?a.visibility:!0,
opacity:a.opacity,copyright:a.copyright,fullExtent:a.fullExtent&&new v(a.fullExtent),initialExtent:a.fullExtent&&new v(a.fullExtent),subDomains:a.subDomains,tileInfo:a.tileInfo?new fb(a.tileInfo):null,refreshInterval:a.refreshInterval}),u.connect(r,"onLoad",function(){(c.isDefined(a.minScale)||c.isDefined(a.maxScale))&&r.setScaleRange(a.minScale,a.maxScale)})):"GeoRSS"===a.type?(r=new gb(a.url,{id:a.id,opacity:a.opacity,outSpatialReference:g,refreshInterval:a.refreshInterval}),u.connect(r,"onLoad",
function(){!1===a.visibility&&r.hide();c.isDefined(a.minScale)&&c.isDefined(a.maxScale)&&r.setScaleRange(a.minScale,a.maxScale);var b=r.getFeatureLayers();k.forEach(b,function(c){a.pointSymbol&&"esriGeometryPoint"===c.geometryType?(c.renderer.symbol=y.fromJson(a.pointSymbol),1===b.length&&(r.pointSymbol=y.fromJson(a.pointSymbol))):a.lineSymbol&&"esriGeometryPolyline"===c.geometryType?(c.renderer.symbol=y.fromJson(a.lineSymbol),1===b.length&&(r.polylineSymbol=y.fromJson(a.lineSymbol))):a.polygonSymbol&&
"esriGeometryPolygon"===c.geometryType&&(c.renderer.symbol=y.fromJson(a.polygonSymbol),1===b.length&&(r.polygonSymbol=y.fromJson(a.polygonSymbol)))})})):"CSV"==a.type&&a.url?(g={layerDefinition:a.layerDefinition,columnDelimiter:a.columnDelimiter,id:a.id?a.id:null,visible:null!==a.visibility?a.visibility:!0,opacity:a.opacity,refreshInterval:a.refreshInterval},a.locationInfo&&(g.latitudeFieldName=a.locationInfo.latitudeFieldName,g.longitudeFieldName=a.locationInfo.longitudeFieldName),f.ignorePopups||
(g.infoTemplate=new z(a.popupInfo?a.popupInfo:hb.generateDefaultPopupInfo(a))),r=new ib(a.url,g)):a.layerDefinition&&!a.url?(g=e.fromJson(e.toJson(a)),delete g.id,delete g.opacity,delete g.visibility,r=new H(g,{id:a.id,opacity:a.opacity,visible:a.visibility,outFields:["*"],autoGeneralize:!0}),!f.ignorePopups&&g.popupInfo&&r.setInfoTemplate(new s(g.popupInfo))):"BingMapsAerial"===a.type||"BingMapsRoad"===a.type||"BingMapsHybrid"===a.type?f.bingMapsKey?(g=V.MAP_STYLE_AERIAL_WITH_LABELS,"BingMapsAerial"===
a.type?g=V.MAP_STYLE_AERIAL:"BingMapsRoad"===a.type&&(g=V.MAP_STYLE_ROAD),r=new V({bingMapsKey:f.bingMapsKey,mapStyle:g,opacity:a.opacity,id:a.id}),u.connect(r,"onError",m.hitch(this,function(a){a.errors=a.errors||[];a.errors.push({message:"This application does not have a valid Bing Key for the Bing layer that is included in this map. [type:"+a.type+"]"})},a))):(a.errors=a.errors||[],a.errors.push({message:"This application does not provide a Bing Key for the Bing layer that is included in this map. [type:"+
a.type+"]"})):a.resourceInfo&&a.resourceInfo.mapName?r=!0===a.resourceInfo.singleFusedMapCache&&(a.baseMapLayer||ba(a,b,g)&&ca(a,l))?T(a,s,f):U(a,s,f):a.resourceInfo&&a.resourceInfo.pixelSizeX?r=!0===a.resourceInfo.singleFusedMapCache&&(a.baseMapLayer||ba(a,b,g)&&ca(a,l))?T(a,s,f):ua(a,s,f):a.resourceInfo&&"Feature Layer"===a.resourceInfo.type?(a.capabilities&&(a.resourceInfo.capabilities=a.capabilities),r=new H(G(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,
mode:I(a.url)?H.MODE_AUTO:c.isDefined(a.mode)?a.mode:H.MODE_ONDEMAND,editable:!1===f.editable?!1:void 0,outFields:["*"],autoGeneralize:!0,refreshInterval:a.refreshInterval}),!f.ignorePopups&&a.popupInfo&&r.setInfoTemplate(new s(a.popupInfo)),a.layerDefinition&&(a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.renderer&&(g=p.fromJson(a.layerDefinition.drawingInfo.renderer),g.isMaxInclusive=!0,r.setRenderer(g)),a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.labelingInfo&&(g=
k.map(a.layerDefinition.drawingInfo.labelingInfo,function(a){return new jb(a)}),r.setLabelingInfo(g)),a.layerDefinition.definitionExpression&&r.setDefinitionExpression(a.layerDefinition.definitionExpression),c.isDefined(a.layerDefinition.minScale)&&r.setMinScale(a.layerDefinition.minScale),c.isDefined(a.layerDefinition.maxScale)&&r.setMaxScale(a.layerDefinition.maxScale))):a.resourceInfo&&a.resourceInfo.streamUrls&&(g={resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id},a.layerDefinition&&
(R=a.layerDefinition.drawingInfo,a.layerDefinition.definitionGeometry&&(x=x||{},x.geometry=a.layerDefinition.definitionGeometry),c.isDefined(a.layerDefinition.definitionExpression)&&(x=x||{},x.where=a.layerDefinition.definitionExpression),c.isDefined(a.layerDefinition.maximumTrackPoints)&&(g.maximumTrackPoints=a.layerDefinition.maximumTrackPoints)),x&&(g.filter=x),a.purgeOptions&&(g.purgeOptions=a.purgeOptions),r=new kb(G(a.url),g),R&&R.renderer&&(g=R.renderer,r.setRenderer(p.fromJson(g))),!f.ignorePopups&&
a.popupInfo&&r.setInfoTemplate(new s(a.popupInfo)),a.layerDefinition&&(c.isDefined(a.layerDefinition.minScale)&&r.setMinScale(a.layerDefinition.minScale),c.isDefined(a.layerDefinition.maxScale)&&r.setMaxScale(a.layerDefinition.maxScale)),n.once(r,"error",function(b){a.errors.push({message:"Error loading stream layer. Check websocket url"})}));r&&(r.arcgisProps={title:a.title},a.baseMapLayer&&(r._basemapGalleryLayerType=a.isReference?"reference":"basemap"));return r}function da(a,b,c,d){k.forEach(a,
function(e,f){if(e.url&&!e.type){if(0===f||a[0].layerObject)e.layerObject=Z(e,a,b,c,d)}else e.layerObject=Z(e,a,b,c,d)});var e=k.filter(a,function(a){return!a.isReference}),f=k.filter(a,function(a){return!!a.isReference});return a=e.concat(f)}function ea(a){var b=null;a=a[0];a.url&&!a.type?a.resourceInfo.spatialReference&&(b=new h,a.resourceInfo.spatialReference.wkid&&(b.wkid=a.resourceInfo.spatialReference.wkid),a.resourceInfo.spatialReference.wkt&&(b.wkt=a.resourceInfo.spatialReference.wkt)):-1<
a.type.indexOf("BingMaps")||"OpenStreetMap"==a.type?b=new h({wkid:102100}):"WMS"==a.type&&(b=new h({wkid:a.spatialReferences[0]}));return b}function K(a,b,c,d,e,f,g){k.forEach(b,function(b,c){b.url&&!b.type&&(b.resourceInfo=a[b.deferredsPos][1],delete b.deferredsPos)});f=f||ea(b);b=da(b,c,f,g);e.callback(b);return e}function Fa(a,b){var c=G(a);return x({url:c,content:{f:"json"},callbackParamName:"callback",error:function(a,d){a.message=a.message?a.message+(" [url:"+c+"]"):"[url:"+c+"]";b.push(a);
f.defaults.io.errorHandler(a,d)}})}function Ga(a){var b=L.arcgisUrl+"/"+a.itemId+"/data";return x({url:b,content:{f:"json"},callbackParamName:"callback",error:function(c,d){c.message=c.message?c.message+(" [url:"+b+"]"):"[url:"+b+"]";a.errors=a.errors||[];a.errors.push(c);f.defaults.io.errorHandler(c,d)}})}function Ha(a,b,d){var f=new s;if((!d.featureCollection||!d.featureCollection.layers)&&!d.layers)return console.log("Invalid Feature Collection item data [item id: "+a.itemId+"]: ",d),a.errors=
a.errors||[],a.errors.push({message:"Invalid Feature Collection item data. [item id: "+a.itemId+"]"}),f.errback(),f;d.layers&&(d.featureCollection={layers:d.layers},delete d.layers,c.isDefined(d.showLegend)&&(d.featureCollection.showLegend=d.showLegend,delete d.showLegend));Ia(a,d.featureCollection,b).then(function(b){d.featureCollection=b;a.featureCollection&&a.featureCollection.layers?k.forEach(d.featureCollection.layers,function(b,d){var f=a.featureCollection.layers[d];if(!f.poupInfo&&!f.layerDefinition)f.popupInfo=
b.popupInfo,f.layerDefinition=b.layerDefinition;else if(f.layerDefinition){if(c.isDefined(f.layerDefinition.minScale)&&c.isDefined(f.layerDefinition.maxScale)&&(f.layerDefinition.minScale!==b.layerDefinition.minScale||f.layerDefinition.maxScale!==b.layerDefinition.maxScale))delete b.layerDefinition.minscale,delete b.layerDefinition.maxScale;f.layerDefinition.drawingInfo&&e.toJson(f.layerDefinition.drawingInfo)!==e.toJson(b.layerDefinition.drawingInfo)&&delete b.layerDefinition.drawingInfo;f.layerDefinition.showLegend!==
b.layerDefinition.showLegend&&delete b.layerDefinition.showLegend;f.layerDefinition=m.mixin(f.layerDefinition,b.layerDefinition)}else f.layerDefinition=b.layerDefinition;f.featureSet=b.featureSet;f.nextObjectId=b.nextObjectId}):(a.featureCollection=a.featureCollection||{},a.featureCollection=m.mixin(a.featureCollection,d.featureCollection));f.callback(a)});return f}function Ia(a,d,e){var f=new s;r(["./csv"],function(g){var h=[];k.forEach(d.layers,function(a){a.featureSet&&(a.featureSet.features&&
a.featureSet.features.length&&a.featureSet.features[0].geometry&&a.featureSet.features[0].geometry.spatialReference)&&(a.deferredsPos=h.length,h.push(g.projectFeatureCollection(a,e,a.featureSet.features[0].geometry.spatialReference)))});(new b(h)).addCallback(function(){k.forEach(d.layers,function(b){c.isDefined(b.deferredsPos)&&(h[b.deferredsPos].results&&h[b.deferredsPos].results.length?b=h[b.deferredsPos].results[0]:(console.log("Errors projecting feature collection. ["+a.title+" - "+b.layerDefinition.name+
"]"),b.errors=b.errors||[],b.errors.push({message:"Errors projecting feature collection. ["+a.title+" - "+b.layerDefinition.name+"]"})),delete b.deferredsPos)});f.callback(d)})});return f}function fa(a,c,d,e){var f=new s,g=new s,h=[],l;k.forEach(a.operationalLayers,function(a){a.itemId&&"Feature Collection"==a.type&&h.push(Ga(a).then(m.hitch(null,Ha,a,d)))});0===h.length?Ja(a,c,d,e,g):(l=new b(h),l.addCallback(function(b){Ja(a,c,d,e,g)}));g.then(function(a){h=[];k.forEach(a,function(a){a=a.layerObject;
if(a instanceof H&&!a.loaded&&!a.loadError){var b=new s;n.once(a,"load, error",function(){b.callback(a)});h.push(b)}});if(h.length){var c=new s;l=new b(h);l.addCallback(function(){c.callback(a)});return c.promise}return a}).then(function(a){var b=[];k.forEach(a,function(a){if(a.layerObject instanceof H){var c=a.layerObject;c.loaded&&(c.labelingInfo&&(a.showLabels||c._collection))&&b.push(c)}});b.length?r(["../layers/LabelLayer"],function(c){var d=new c;k.forEach(b,function(a){d.addFeatureLayer(a)});
a.push({layerObject:d});f.callback(a)}):f.callback(a)});return f}function Ja(a,c,d,e,f){var g=[],h=[],l=[];k.forEach(a.operationalLayers,function(a,b){a.featureCollection?k.forEach(a.featureCollection.layers,function(c,d){var e=!0;a.visibleLayers&&-1==k.indexOf(a.visibleLayers,d)&&(e=!1);c.visibility=a.visibility&&e;c.opacity=a.opacity;c.id=(a.id||"operational"+b)+"_"+d;l.push(c)},this):l.push(a)});k.forEach(a.baseMap.baseMapLayers,function(a,b){a.baseMapLayer=!0;a.id=a.id||"base"+b;g.push(a)});k.forEach(l,
function(a,b){a.id=a.id||"operational"+b;g.push(a)});k.forEach(g,function(a){a.url&&!a.type&&(a.deferredsPos=h.length,a.errors=a.errors||[],h.push(Fa(a.url,a.errors)))});0===h.length?(d=d||ea(g),g=da(g,c,d,e),f.callback(g)):(new b(h)).addCallback(function(a){K(a,g,c,h,f,d,e)});return f}function ga(a,b,c,d){var e=a.minScale,f=a.maxScale;if(10.1>=c.version&&b)for(a=b.length-1;0<=a;a--){if(b[a].id==d)if(0==e&&0<b[a].minScale?e=b[a].minScale:0<e&&0==b[a].minScale?e=c.minScale:0<e&&0<b[a].minScale&&(e=
Math.min(e,b[a].minScale)),f=Math.max(c.maxScale||0,b[a].maxScale||0),c.setScaleRange(e,f),-1<b[a].parentLayerId)d=b[a].parentLayerId;else break}else 10.1<c.version&&(k.forEach(a.layerInfos,function(a){a.id==d&&(0==e&&0<a.minScale?e=a.minScale:0<e&&0==a.minScale||0<e&&0<a.minScale&&(e=Math.min(e,a.minScale)),f=Math.max(f||0,a.maxScale||0))}),c.setScaleRange(e,f))}function ha(a,b,d,e){var f=a.url,g=a.__popupIds,h=a.__popupUrls,l=a.__popupWhereClauses,n=a.__popupMinScales,p=a.__popupMaxScales,q=a.__resourceInfo,
r=[];k.forEach(a.__popups,function(e,m){if(e){var s,t=[];k.forEach(e.fieldInfos,function(a){"shape"!==a.fieldName.toLowerCase()&&t.push(a.fieldName)});if(a.dynamicLayerInfos&&0<a.dynamicLayerInfos.length){var v=k.filter(a.dynamicLayerInfos,function(a){return g[m]==a.id})[0].source;s=new H(f+"/dynamicLayer",{id:a.id+"_"+g[m],source:v,outFields:t,mode:H.MODE_SELECTION,infoTemplate:e&&new d(e),drawMode:!1,visible:a.visible,autoGeneralize:!0});var w=function(d,e){0<l[d].length&&e.setDefinitionExpression(l[d]);
if(!c.isDefined(n[d])&&!c.isDefined(p[d]))ga(a,b||q.layers,e,g[d]);else if(c.isDefined(a.minScale)||c.isDefined(a.maxScale)){var f=a.minScale,h=a.maxScale;0==f&&0<n[d]?f=n[d]:0<f&&0==n[d]||0<f&&0<n[d]&&(f=Math.min(f,n[d]));h=Math.max(h||0,p[d]||0);e.setScaleRange(f,h)}else e.setScaleRange(n[d],p[d])};s.loaded?w(m,s):u.connect(s,"onLoad",function(a){w(m,s)})}else{var x=null,Ta=f+"/"+g[m];if(h[m].length)Ta=h[m];else if(b)for(v=0;v<b.length;v++)if(b[v].id===g[m]){x=b[v];break}s=new H(G(Ta),{id:a.id+
"_"+g[m],outFields:t,mode:H.MODE_SELECTION,infoTemplate:e&&new d(e),drawMode:!1,visible:a.visible,resourceInfo:x,autoGeneralize:!0});s.loaded?(0<l[m].length&&s.setDefinitionExpression(l[m]),ga(a,b||q.layers,s,g[m])):u.connect(s,"onLoad",function(c){0<l[m].length&&s.setDefinitionExpression(l[m]);ga(a,b||q.layers,c,g[m])})}r.push(s)}});0<r.length&&(u.connect(a,"onVisibilityChange",m.hitch(this,function(a,b){k.forEach(a,function(a){b?a.show():a.hide()})},r)),u.connect(e,"onLayerRemove",m.hitch(this,
function(a,b,c){a.id===c.id&&k.forEach(b,function(a){e.removeLayer(a)})},a,r)));delete a.__popups;delete a.__popupIds;delete a.__popupUrls;delete a.__popupWhereClauses;delete a.__popupMinScales;delete a.__popupMaxScales;delete a.__resourceInfo;return r}function Ka(a){return x({url:G(a.url+"/layers"),content:{f:"json"},callbackParamName:"callback",error:function(){}})}function La(a,c,d){var e=[];k.forEach(a,function(a){var b=a.__popups;b&&(1<b.length&&10<=a.version)&&(a.__deferredsPos=e.length,e.push(Ka(a)))});
var f=[];0<e.length?(new b(e)).addCallback(function(b){k.forEach(a,function(a){a.__popups&&0<a.__popups.length&&(a.__deferredsPos||0===a.__deferredsPos?(f=f.concat(ha(a,b[a.__deferredsPos][1].layers,d,c)),delete a.__deferredsPos):f=f.concat(ha(a,null,d,c)))});c.addLayers(f)}):(k.forEach(a,function(a){a.__popups&&0<a.__popups.length&&(f=f.concat(ha(a,null,d,c)))}),c.addLayers(f))}function Ma(a){k.forEach(a,function(a){var b=a.layer;b.toJson&&(a=b.toJson(),a.featureSet&&(b.name&&-1<b.name.indexOf("Text"))&&
k.forEach(a.featureSet.features,function(a,c){if(a.attributes.TEXT){var d=b.graphics[c];d.symbol.setText(a.attributes.TEXT);a.symbol.horizontalAlignment&&(d.symbol.align=a.symbol.horizontalAlignment);d.setSymbol(d.symbol);d.setAttributes(a.attributes)}},this))})}function Na(a){var b=6;k.forEach(a,function(a){if(a=a.renderer)"esri.renderer.SimpleRenderer"===a.declaredClass?((a=a.symbol)&&a.xoffset&&(b=Math.max(b,Math.abs(a.xoffset))),a&&a.yoffset&&(b=Math.max(b,Math.abs(a.yoffset)))):("esri.renderer.UniqueValueRenderer"===
a.declaredClass||"esri.renderer.ClassBreaksRenderer"===a.declaredClass)&&k.forEach(a.infos,function(a){(a=a.symbol)&&a.xoffset&&(b=Math.max(b,Math.abs(a.xoffset)));a&&a.yoffset&&(b=Math.max(b,Math.abs(a.yoffset)))})});return b}function va(a){var b=this,c=b.infoWindow,d=a.graphic;if(b.loaded){c.hide();c.clearFeatures();var e=[];k.forEach(b.graphicsLayerIds,function(a){if((a=b.getLayer(a))&&a instanceof H&&a.loaded&&a.visible)a.clearSelection(),a.infoTemplate&&!a.suspended&&e.push(a)});k.forEach(b.layerIds,
function(a){(a=b.getLayer(a))&&(-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")&&a.loaded&&a.visible&&a.infoTemplate)&&e.push(a)});d=d&&d.getInfoTemplate()?d:null;if(e.length||d){var f=Na(e),g=a.screenPoint,h=b.toMap(new l(g.x-f,g.y+f)),f=b.toMap(new l(g.x+f,g.y-f)),h=new v(h.x,h.y,f.x,f.y,b.spatialReference),m=new S;m.geometry=h;m.timeExtent=b.timeExtent;var n=!0,h=k.map(e,function(b){var c;-1!==b.declaredClass.indexOf("ArcGISImageServiceLayer")?(m.geometry=a.mapPoint,n=!1,c=b.queryVisibleRasters(m,
{rasterAttributeTableFieldPrefix:"Raster.",returnDomainValues:!0}),c.addCallback(function(){return b.getVisibleRasters()})):(c=b.selectFeatures(m),c.addCallback(function(){return b.getSelectedFeatures()}));return c});d&&(f=new s,f.callback([d]),h.splice(0,0,f));if(!k.some(h,function(a){return-1===a.fired})){var p=d?1:0;k.forEach(e,function(a){p=-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")?p+a.getVisibleRasters().length:p+a.getSelectedFeatures().length});if(!p)return}c.setFeatures(h);c.show(a.mapPoint,
{closestFirst:n})}}}function lb(b,d){var e=d.mapOptions||{},f;e.infoWindow||(f=new D({visibleWhenEmpty:!1},g.create("div")),e.infoWindow=f);!c.isDefined(e.showInfoWindowOnClick)&&!d.usePopupManager&&(e.showInfoWindowOnClick=!1);e=new a(b,e);u.connect(e,"onLayersAddResult",Ma);return e}function W(a,b,c,d,e,f){var g,h,l,m;d.map?(g=d.map,h=d.clickEventHandle,l=d.clickEventListener,m=d.errors):(g=lb(d,e),!e.ignorePopups&&(!e.disableClickBehavior&&!e.usePopupManager)&&(h=u.connect(g,"onClick",va),l=va));
g.addLayers(a);!e.ignorePopups&&!e.usePopupManager&&La(a,g,e._clazz);var n=m||[];k.forEach(b,function(a){a.errors&&(n=n.concat(a.errors))},this);g.loaded?f.callback({map:g,itemInfo:c,errors:n,clickEventHandle:h,clickEventListener:l}):u.connect(g,"onLoad",function(){f.callback({map:g,itemInfo:c,errors:n,clickEventHandle:h,clickEventListener:l})})}function ia(a,b,c,d,e){var f=[];k.forEach(e,function(a){m.isArray(a.layerObject)?k.forEach(a.layerObject,function(a){f.push(a)}):f.push(a.layerObject)});
if("BingMapsAerial"===e[0].type||"BingMapsRoad"===e[0].type||"BingMapsHybrid"===e[0].type)var g=setInterval(function(){if(e[0].layerObject&&e[0].layerObject.loaded)clearInterval(g),Pa(a,b,c,d,e,f);else if(e[0].errors){clearInterval(g);var h="";e[0].errors&&e[0].errors.length&&(h=" ("+e[0].errors[0].message+")");d.errback(Error($.arcgis.utils.baseLayerError+h))}},10);else if(!f[0]&&e[0].baseMapLayer){var h="";e[0].errors&&e[0].errors.length&&(h=" ("+e[0].errors[0].message+")");d.errback(Error($.arcgis.utils.baseLayerError+
h))}else Pa(a,b,c,d,e,f)}function Pa(a,b,d,e,g,l){try{var m=d.mapOptions||{};d.mapOptions=m;var n=a.item;l=k.filter(l,c.isDefined);if(n)if(n.extent&&n.extent.length)if(m.extent)W(l,g,a,b,d,e);else{var p=new v(n.extent[0][0],n.extent[0][1],n.extent[1][0],n.extent[1][1],new h({wkid:4326})),q=l[0].spatialReference;4326===q.wkid?(m.extent=p,W(l,g,a,b,d,e)):102100===q.wkid||102113===q.wkid||3857===q.wkid?(p.xmin=Math.max(p.xmin,-180),p.xmax=Math.min(p.xmax,180),p.ymin=Math.max(p.ymin,-89.99),p.ymax=Math.min(p.ymax,
89.99),m.extent=t.geographicToWebMercator(p),W(l,g,a,b,d,e)):d.geometryServiceURL||f.defaults.geometryService?(d.geometryServiceURL?new N(d.geometryServiceURL):f.defaults.geometryService).project([p],q,function(c){c=c[0];m.extent=m.extent||c;W(l,g,a,b,d,e)},function(){W(l,g,a,b,d,e)}):e.errback(Error($.arcgis.utils.geometryServiceError))}else W(l,g,a,b,d,e);else W(l,g,a,b,d,e)}catch(r){e.errback(r)}}function Oa(a){var b=[];a=a.baseMap.baseMapLayers.concat(a.operationalLayers);k.forEach(a,function(a){var c=
{};if(a.featureCollection&&"CSV"!==a.type)!0===a.featureCollection.showLegend&&k.forEach(a.featureCollection.layers,function(d){!1!==d.showLegend&&(c={layer:d.layerObject,title:a.title,defaultSymbol:d.renderer&&d.renderer.defaultSymbol&&d.renderer.defaultLabel?!0:!1},1<a.featureCollection.layers.length&&(c.title+=" - "+d.layerDefinition.name),b.push(c))});else if(a.baseMapLayer&&!0===a.showLegend&&a.layerObject||!a.baseMapLayer&&!1!==a.showLegend&&a.layerObject){var d=a.layerObject.renderer,e=a.layerObject.declaredClass,
d=!d||d&&d.defaultSymbol&&d.defaultLabel?!0:!1;if(10.1>a.layerObject.version&&("esri.layers.ArcGISDynamicMapServiceLayer"===e||"esri.layers.ArcGISTiledMapServiceLayer"===e)||"esri.layers.ArcGISImageServiceLayer"===e)d=!0;c={layer:a.layerObject,title:a.title,defaultSymbol:d};a.layers&&(e=k.map(k.filter(a.layers,function(a){return!1===a.showLegend}),function(a){return a.id}),e.length&&(c.hideLayers=e));b.push(c)}});return b}function mb(a,b){function c(a,b){k.forEach(a,function(a,c){switch(a){case ja:Sa=
b[c];break;case ka:$a=b[c];break;case wa:hb=b[c];break;case la:ib=b[c];break;case xa:Va=b[c];break;case ma:gb=b[c];break;case ya:Ua=b[c];break;case za:Xa=b[c];break;case na:db=b[c];break;case oa:jb=b[c];break;case Aa:Wa=b[c];break;case Ba:Za=b[c];break;case pa:ab=b[c];break;case Ca:Ya=b[c];break;case qa:kb=b[c];break;case Da:fb=b[c];break;case ra:V=b[c];break;case sa:eb=b[c];break;case ta:cb=b[c];break;case Ea:bb=b[c]}})}var d=new s,e=a.itemData,f=[];e.baseMap&&e.baseMap.baseMapLayers&&(f=f.concat(e.baseMap.baseMapLayers));
e.operationalLayers&&(f=f.concat(e.operationalLayers));for(var e=k.map(f,function(a){return a&&a.layerType}),g=[],h=[],f=!1,l=0;l<e.length;l++){switch(e[l]){case "ArcGISFeatureLayer":-1===k.indexOf(g,oa)&&g.push(oa);break;case "ArcGISImageServiceLayer":-1===k.indexOf(g,ka)&&(g.push(ka),h.push(za),h.push(Ba),h.push(Ca));break;case "ArcGISMapServiceLayer":-1===k.indexOf(g,ja)&&(g.push(ja),h.push(xa),h.push(ya),h.push(Aa));break;case "ArcGISStreamLayer":-1===k.indexOf(g,qa)&&g.push(qa);break;case "ArcGISTiledImageServiceLayer":case "ArcGISTiledMapServiceLayer":break;
case "BingMapsAerial":case "BingMapsHybrid":case "BingMapsRoad":-1===k.indexOf(g,ra)&&g.push(ra);break;case "CSV":-1===k.indexOf(g,la)&&(g.push(la),h.push(wa));break;case "GeoRSS":-1===k.indexOf(g,ma)&&g.push(ma);break;case "KML":-1===k.indexOf(g,na)&&g.push(na);break;case "OpenStreetMap":-1===k.indexOf(g,pa)&&g.push(pa);break;case "WebTiledLayer":-1===k.indexOf(g,sa)&&(g.push(sa),h.push(Da));break;case "WMS":-1===k.indexOf(g,ta)&&(g.push(ta),h.push(Ea));break;default:f=!0}if(f)break}f&&(g=nb,h=ob);
g.length?r(g,function(){c(g,arguments);h.length?r(h,function(){c(h,arguments);d.resolve()}):d.resolve()}):d.resolve();return d}function Qa(a,b,c,d){mb(d,b).then(function(){E(d,b).then(function(b){var d=b[0],e=b[1];if(!d.itemData.operationalLayers||0===d.itemData.operationalLayers.length)A(d,e).addCallback(function(b){fa(b.itemData,e).addCallback(m.hitch(null,ia,b,a,e,c))});else{var f=new s,g=d.itemData.baseMap.baseMapLayers.slice(),h=k.filter(d.itemData.baseMap.baseMapLayers,function(a){return!a.isReference});
b={item:d.item,itemData:{baseMap:{baseMapLayers:h}}};d.itemData.baseMap.baseMapLayers=k.filter(d.itemData.baseMap.baseMapLayers,function(a){return a.isReference});A(b,e).addCallback(function(b){fa(b.itemData,e).addCallback(m.hitch(null,ia,b,a,e,f))});f.then(function(a){A(d,e).addCallback(function(b){fa(b.itemData,e,a.map.spatialReference,h).addCallback(function(d){b.itemData.baseMap.baseMapLayers=g;ia(b,a,e,c,d)})})},m.hitch(c,c.errback))}})})}function Ra(a){L._arcgisUrl&&0<L._arcgisUrl.length&&(L.arcgisUrl=
L._arcgisUrl);var b=L.arcgisUrl+"/"+a,c={},d=new s;x({url:b,content:{f:"json"},callbackParamName:"callback",load:function(a){c.item=a;x({url:b+"/data",content:{f:"json"},callbackParamName:"callback",load:function(a){c.itemData=a;d.callback(c)},error:function(a){d.errback(a)}})},error:function(a){d.errback(a)}});return d}String.prototype.endsWith=function(a){return this.match(a+"$")==a};var L,Sa,$a,hb,ib,Va,gb,Ua,Xa,db,jb,Wa,Za,ab,Ya,kb,fb,V,eb,cb,bb,ja="../layers/ArcGISDynamicMapServiceLayer",ka=
"../layers/ArcGISImageServiceLayer",wa="./csv",la="../layers/CSVLayer",xa="../layers/DynamicLayerInfo",ma="../layers/GeoRSSLayer",ya="../layers/ImageParameters",za="../layers/ImageServiceParameters",na="../layers/KMLLayer",oa="../layers/LabelClass",Aa="../layers/LayerDrawingOptions",Ba="../layers/MosaicRule",pa="../layers/OpenStreetMapLayer",Ca="../layers/RasterFunction",qa="../layers/StreamLayer",Da="../layers/TileInfo",ra="../virtualearth/VETiledLayer",sa="../layers/WebTiledLayer",ta="../layers/WMSLayer",
Ea="../layers/WMSLayerInfo",nb=[ja,ka,la,ma,na,oa,pa,qa,ra,sa,ta],ob=[wa,xa,ya,za,Aa,Ba,Ca,Da,Ea];L={arcgisUrl:location.protocol+"//www.arcgis.com/sharing/rest/content/items",getItem:Ra,createMap:function(a,b,c){var d=new s;c=c||{};var e=c.infoTemplateClass;c._clazz=e&&(m.isObject(e)?e:m.getObject(e))||z;m.isString(a)?Ra(a).addCallback(m.hitch(null,Qa,b,c,d)).addErrback(m.hitch(d,d.errback)):Qa(b,c,d,a);return d},getLegendLayers:function(a){return a&&a.itemInfo&&a.itemInfo.itemData?Oa(a.itemInfo.itemData):
[]},_arcgisUrl:null,_getItemProps:A,_getItemData:O,_getBingKey:X,_portalUrlResponse:B,_portalUrlFailure:M,_processFSItemProperties:aa,_processSSItemProperties:P,_getLayers:fa,_preBuildLayerObjects:K,_buildLayerObjects:da,_preCreateMap:ia,_getMapSR:ea,_createMap:W,_addSelectionLayers:La,_createSelectionFeatureLayers:ha,_getServiceInfo:Fa,_getFeatureCollectionItem:Ga,_mergeFeatureCollectionItem:Ha,_projectFeatureCollection:Ia,_getLayersInfo:Ka,_initLayer:Z,_loadAsCached:T,_loadAsDynamic:U,_processPopups:F,
_onLayersAddResult:Ma,_sameSpatialReferenceAsBasemap:ba,_sameTilingSchemeAsBasemap:ca,_showPopup:va,_calculateClickTolerance:Na,_getVisibleFeatureLayers:Q,_updateLayerScaleInfo:ga,_checkUrl:G,_isHostedService:I,_isAgolService:Y,_getLegendLayers:Oa};m.setObject("arcgis.utils",L,d);return L});